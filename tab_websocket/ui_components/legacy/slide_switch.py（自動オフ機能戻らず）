#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ® SlideSwitch UI Component v16 Phase2
è‡ªå‹•OFFæ©Ÿèƒ½ä»˜ãã‚¹ãƒ©ã‚¤ãƒ‰ã‚¹ã‚¤ãƒƒãƒ - å®Œå…¨ç‰ˆ

å…ƒã®slide_switch.pyã«Phase2æ©Ÿèƒ½ã‚’çµ±åˆã—ãŸå®Œå…¨ç‰ˆ
æ—¢å­˜ã®slide_switch.pyã‚’ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ç½®ãæ›ãˆã¦ãã ã•ã„

Phase2ã§ã®è¿½åŠ æ©Ÿèƒ½:
- delay_off() ãƒ¡ã‚½ãƒƒãƒ‰ - æŒ‡å®šç§’æ•°å¾Œã«è‡ªå‹•OFF
- animate_to_off() - ã‚¹ãƒ ãƒ¼ã‚ºãªè‡ªå‹•OFF ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- cancel_delayed_off() - è‡ªå‹•OFF ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
- set_switch_warning_state() - è­¦å‘ŠçŠ¶æ…‹è¡¨ç¤º
- get_switch_status() - è©³ç´°çŠ¶æ…‹å–å¾—
- æ¥ç¶šå¤±æ•—æ™‚ã®è‡ªå‹•å¾©æ—§UIå¯¾å¿œ
"""

import tkinter as tk
import logging

logger = logging.getLogger(__name__)


def create_slide_switch(frame, service_key, toggle_var, on_toggle_callback):
    """
    SlideSwitchä½œæˆé–¢æ•°ï¼ˆPhase2å¼·åŒ–ç‰ˆï¼‰
    
    Args:
        frame: è¦ªãƒ•ãƒ¬ãƒ¼ãƒ 
        service_key: ã‚µãƒ¼ãƒ“ã‚¹ã‚­ãƒ¼
        toggle_var: ãƒˆã‚°ãƒ«å¤‰æ•°
        on_toggle_callback: ãƒˆã‚°ãƒ«å¤‰æ›´ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        
    Returns:
        switch_frame: SlideSwitch ãƒ•ãƒ¬ãƒ¼ãƒ 
    """
    try:
        switch_frame = tk.Frame(frame, bg="#444444", width=50, height=25)
        switch_frame.pack_propagate(False)

        canvas = tk.Canvas(switch_frame, width=50, height=25, highlightthickness=0, bg="#444444")
        canvas.pack(fill=tk.BOTH, expand=True)

        # ãƒãƒ–ã®æç”»
        knob = canvas.create_oval(2, 2, 23, 23, fill="#ffffff", outline="#cccccc")
        
        # Phase2: è¿½åŠ å±æ€§
        switch_frame.knob = knob
        switch_frame.canvas = canvas
        switch_frame.service_key = service_key
        switch_frame.toggle_var = toggle_var
        switch_frame.callback = on_toggle_callback
        switch_frame.delayed_off_job = None  # è‡ªå‹•OFF ã‚¸ãƒ§ãƒ–ID
        switch_frame.is_auto_changing = False  # è‡ªå‹•å¤‰æ›´ä¸­ãƒ•ãƒ©ã‚°
        
        def on_click(event=None):
            # è‡ªå‹•å¤‰æ›´ä¸­ã¯æ‰‹å‹•æ“ä½œã‚’ç„¡è¦–
            if switch_frame.is_auto_changing:
                return
                
            toggle_var.set(not toggle_var.get())
            if on_toggle_callback:
                on_toggle_callback(service_key, toggle_var.get())

        canvas.bind("<Button-1>", on_click)
        canvas.bind("<Enter>", lambda e: canvas.config(cursor="hand2"))
        
        logger.debug(f"âœ… SlideSwitchä½œæˆå®Œäº†: {service_key}")
        return switch_frame
        
    except Exception as e:
        logger.error(f"âŒ SlideSwitchä½œæˆã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
        raise


def update_slide_switch_appearance(switch_frame, is_on):
    """
    SlideSwitchå¤–è¦³æ›´æ–°ï¼ˆPhase2å¼·åŒ–ç‰ˆï¼‰
    
    Args:
        switch_frame: SlideSwitch ãƒ•ãƒ¬ãƒ¼ãƒ 
        is_on: ON/OFF çŠ¶æ…‹
    """
    try:
        canvas = switch_frame.canvas
        
        if is_on:
            # ONçŠ¶æ…‹: ç·‘èƒŒæ™¯ã€ãƒãƒ–ã‚’å³ã«
            canvas.config(bg="#66bb6a")  # ç·‘
            canvas.coords(switch_frame.knob, 25, 2, 47, 23)
        else:
            # OFFçŠ¶æ…‹: èµ¤èƒŒæ™¯ã€ãƒãƒ–ã‚’å·¦ã«
            canvas.config(bg="#e57373")  # èµ¤
            canvas.coords(switch_frame.knob, 2, 2, 23, 23)
            
        # toggle_var ã‚‚åŒæœŸ
        if hasattr(switch_frame, 'toggle_var'):
            switch_frame.toggle_var.set(is_on)
            
        logger.debug(f"ğŸ”„ SlideSwitchå¤–è¦³æ›´æ–°: {switch_frame.service_key} = {is_on}")
        
    except Exception as e:
        logger.error(f"âŒ SlideSwitchå¤–è¦³æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")


def animate_slide_switch(switch_frame, to_on=True, step=0):
    """
    SlideSwitch ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ—¢å­˜æ©Ÿèƒ½ï¼‰
    
    Args:
        switch_frame: SlideSwitch ãƒ•ãƒ¬ãƒ¼ãƒ 
        to_on: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ–¹å‘ï¼ˆTrue=ON, False=OFFï¼‰
        step: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ—
    """
    try:
        canvas = switch_frame.canvas
        knob = switch_frame.knob
        
        if to_on:
            x1 = min(2 + step, 25)
            x2 = x1 + 21
            if x1 >= 25:
                update_slide_switch_appearance(switch_frame, True)
                return
        else:
            x1 = max(25 - step, 2)
            x2 = x1 + 21
            if x1 <= 2:
                update_slide_switch_appearance(switch_frame, False)
                return

        canvas.coords(knob, x1, 2, x2, 23)
        switch_frame.after(10, lambda: animate_slide_switch(switch_frame, to_on, step + 2))
        
    except Exception as e:
        logger.error(f"âŒ SlideSwitch ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: {e}")


# ===== Phase2 æ–°æ©Ÿèƒ½: è‡ªå‹•OFFé–¢é€£ =====

def delay_off(switch_frame, delay_seconds=3):
    """
    æŒ‡å®šç§’æ•°å¾Œã«è‡ªå‹•OFFï¼ˆPhase2æ–°æ©Ÿèƒ½ï¼‰
    
    Args:
        switch_frame: SlideSwitch ãƒ•ãƒ¬ãƒ¼ãƒ 
        delay_seconds: é…å»¶ç§’æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3ç§’ï¼‰
    """
    try:
        # æ—¢å­˜ã®è‡ªå‹•OFF ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        cancel_delayed_off(switch_frame)
        
        service_key = getattr(switch_frame, 'service_key', 'unknown')
        logger.info(f"â° {service_key} è‡ªå‹•OFFé–‹å§‹ - {delay_seconds}ç§’å¾Œã«å®Ÿè¡Œ")
        
        def turn_off():
            try:
                # è‡ªå‹•å¤‰æ›´ä¸­ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                switch_frame.is_auto_changing = True
                
                # å¤–è¦³ã‚’OFFã«å¤‰æ›´ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
                animate_to_off(switch_frame)
                
                # toggle_var ã‚’OFFã«è¨­å®š
                if hasattr(switch_frame, 'toggle_var'):
                    switch_frame.toggle_var.set(False)
                
                # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‘¼ã³å‡ºã—
                if hasattr(switch_frame, 'callback') and switch_frame.callback:
                    switch_frame.callback(switch_frame.service_key, False)
                
                # è‡ªå‹•å¤‰æ›´ä¸­ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆå°‘ã—é…å»¶ï¼‰
                switch_frame.after(500, lambda: setattr(switch_frame, 'is_auto_changing', False))
                
                # ã‚¸ãƒ§ãƒ–IDã‚¯ãƒªã‚¢
                switch_frame.delayed_off_job = None
                
                logger.info(f"âœ… {service_key} è‡ªå‹•OFFå®Œäº†")
                
            except Exception as e:
                logger.error(f"âŒ è‡ªå‹•OFFå®Ÿè¡Œã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
                # ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
                switch_frame.is_auto_changing = False
        
        # è‡ªå‹•OFF ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        switch_frame.delayed_off_job = switch_frame.after(delay_seconds * 1000, turn_off)
        
    except Exception as e:
        logger.error(f"âŒ è‡ªå‹•OFFè¨­å®šã‚¨ãƒ©ãƒ¼: {e}")


def animate_to_off(switch_frame):
    """
    OFFã¸ã®ã‚¹ãƒ ãƒ¼ã‚ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆPhase2æ–°æ©Ÿèƒ½ï¼‰
    
    Args:
        switch_frame: SlideSwitch ãƒ•ãƒ¬ãƒ¼ãƒ 
    """
    try:
        canvas = switch_frame.canvas
        
        # èƒŒæ™¯ã‚’è­¦å‘Šè‰²ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰ã«ä¸€ç¬å¤‰æ›´
        canvas.config(bg="#ff9800")  # ã‚ªãƒ¬ãƒ³ã‚¸
        
        # 200mså¾Œã«é€šå¸¸ã®OFFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        switch_frame.after(200, lambda: animate_slide_switch(switch_frame, to_on=False))
        
    except Exception as e:
        logger.error(f"âŒ OFFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: {e}")


def cancel_delayed_off(switch_frame):
    """
    è‡ªå‹•OFF ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆPhase2æ–°æ©Ÿèƒ½ï¼‰
    
    Args:
        switch_frame: SlideSwitch ãƒ•ãƒ¬ãƒ¼ãƒ 
    """
    try:
        if hasattr(switch_frame, 'delayed_off_job') and switch_frame.delayed_off_job:
            switch_frame.after_cancel(switch_frame.delayed_off_job)
            switch_frame.delayed_off_job = None
            
            service_key = getattr(switch_frame, 'service_key', 'unknown')
            logger.debug(f"â° {service_key} è‡ªå‹•OFF ã‚­ãƒ£ãƒ³ã‚»ãƒ«")
            
    except Exception as e:
        logger.error(f"âŒ è‡ªå‹•OFF ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼: {e}")


def set_switch_warning_state(switch_frame, is_warning=True):
    """
    SlideSwitch ã‚’è­¦å‘ŠçŠ¶æ…‹ã«è¨­å®šï¼ˆPhase2æ–°æ©Ÿèƒ½ï¼‰
    
    Args:
        switch_frame: SlideSwitch ãƒ•ãƒ¬ãƒ¼ãƒ 
        is_warning: è­¦å‘ŠçŠ¶æ…‹ã‹ã©ã†ã‹
    """
    try:
        canvas = switch_frame.canvas
        
        if is_warning:
            # è­¦å‘ŠçŠ¶æ…‹: ã‚ªãƒ¬ãƒ³ã‚¸èƒŒæ™¯ã§ç‚¹æ»…
            canvas.config(bg="#ff9800")  # ã‚ªãƒ¬ãƒ³ã‚¸
            
            def blink():
                if hasattr(switch_frame, 'is_warning') and switch_frame.is_warning:
                    current_bg = canvas.cget("bg")
                    new_bg = "#ff9800" if current_bg == "#ffcc80" else "#ffcc80"  # ã‚ªãƒ¬ãƒ³ã‚¸ç³»ã§ç‚¹æ»…
                    canvas.config(bg=new_bg)
                    switch_frame.after(500, blink)  # 0.5ç§’é–“éš”ã§ç‚¹æ»…
            
            switch_frame.is_warning = True
            blink()
            
        else:
            # è­¦å‘ŠçŠ¶æ…‹è§£é™¤: é€šå¸¸ã®çŠ¶æ…‹ã«æˆ»ã™
            switch_frame.is_warning = False
            is_on = switch_frame.toggle_var.get() if hasattr(switch_frame, 'toggle_var') else False
            update_slide_switch_appearance(switch_frame, is_on)
            
        service_key = getattr(switch_frame, 'service_key', 'unknown')
        logger.debug(f"âš ï¸ {service_key} è­¦å‘ŠçŠ¶æ…‹: {is_warning}")
        
    except Exception as e:
        logger.error(f"âŒ è­¦å‘ŠçŠ¶æ…‹è¨­å®šã‚¨ãƒ©ãƒ¼: {e}")


def get_switch_status(switch_frame):
    """
    SlideSwitch ã®è©³ç´°çŠ¶æ…‹å–å¾—ï¼ˆPhase2æ–°æ©Ÿèƒ½ï¼‰
    
    Args:
        switch_frame: SlideSwitch ãƒ•ãƒ¬ãƒ¼ãƒ 
        
    Returns:
        dict: çŠ¶æ…‹è¾æ›¸
    """
    try:
        return {
            'service_key': getattr(switch_frame, 'service_key', 'unknown'),
            'is_on': switch_frame.toggle_var.get() if hasattr(switch_frame, 'toggle_var') else False,
            'is_auto_changing': getattr(switch_frame, 'is_auto_changing', False),
            'has_delayed_off': getattr(switch_frame, 'delayed_off_job', None) is not None,
            'is_warning': getattr(switch_frame, 'is_warning', False)
        }
        
    except Exception as e:
        logger.error(f"âŒ SlideSwitchçŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        return {'error': str(e)}


# ===== ãƒ†ã‚¹ãƒˆç”¨é–¢æ•° =====

def test_slide_switch_with_auto_off():
    """SlideSwitchè‡ªå‹•OFFæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ"""
    print("ğŸ§ª SlideSwitch Phase2 è‡ªå‹•OFFæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹")
    
    try:
        # ãƒ†ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä½œæˆ
        root = tk.Tk()
        root.title("SlideSwitch Phase2 ãƒ†ã‚¹ãƒˆ")
        root.geometry("400x300")
        
        # ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ 
        test_frame = tk.Frame(root)
        test_frame.pack(pady=20)
        
        # ã‚¿ã‚¤ãƒˆãƒ«
        title_label = tk.Label(test_frame, text="ğŸ® SlideSwitch Phase2 è‡ªå‹•OFF ãƒ†ã‚¹ãƒˆ", font=("Yu Gothic UI", 14, "bold"))
        title_label.pack(pady=10)
        
        # ãƒ†ã‚¹ãƒˆç”¨SlideSwitchä½œæˆ
        switch_frame_container = tk.Frame(test_frame)
        switch_frame_container.pack(pady=20)
        
        # ã‚µãƒ¼ãƒ“ã‚¹åãƒ©ãƒ™ãƒ«
        service_label = tk.Label(switch_frame_container, text="ãƒ†ã‚¹ãƒˆã‚µãƒ¼ãƒ“ã‚¹:", font=("Yu Gothic UI", 12))
        service_label.pack(side=tk.LEFT, padx=(0, 10))
        
        # SlideSwitchä½œæˆ
        toggle_var = tk.BooleanVar(value=True)
        
        def test_callback(service_key, enabled):
            print(f"ğŸ”„ ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: {service_key} = {enabled}")
            status_label.config(text=f"çŠ¶æ…‹: {'ON' if enabled else 'OFF'}")
        
        slide_switch = create_slide_switch(
            switch_frame_container,
            "test_service",
            toggle_var,
            test_callback
        )
        slide_switch.pack(side=tk.LEFT, padx=10)
        
        # çŠ¶æ…‹è¡¨ç¤ºãƒ©ãƒ™ãƒ«
        status_label = tk.Label(switch_frame_container, text="çŠ¶æ…‹: ON", font=("Yu Gothic UI", 10))
        status_label.pack(side=tk.LEFT, padx=(10, 0))
        
        # åˆæœŸå¤–è¦³è¨­å®š
        update_slide_switch_appearance(slide_switch, True)
        
        # ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢
        button_frame = tk.Frame(test_frame)
        button_frame.pack(pady=20)
        
        # è‡ªå‹•OFF ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
        def test_auto_off():
            print("â° 3ç§’å¾Œè‡ªå‹•OFF ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ")
            delay_off(slide_switch, 3)
        
        auto_off_btn = tk.Button(button_frame, text="â° 3ç§’å¾Œè‡ªå‹•OFF", command=test_auto_off)
        auto_off_btn.pack(side=tk.LEFT, padx=5)
        
        # ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
        def test_cancel():
            print("â° è‡ªå‹•OFF ã‚­ãƒ£ãƒ³ã‚»ãƒ«")
            cancel_delayed_off(slide_switch)
        
        cancel_btn = tk.Button(button_frame, text="â° ã‚­ãƒ£ãƒ³ã‚»ãƒ«", command=test_cancel)
        cancel_btn.pack(side=tk.LEFT, padx=5)
        
        # è­¦å‘ŠçŠ¶æ…‹ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
        def test_warning():
            is_warning = not getattr(slide_switch, 'is_warning', False)
            print(f"âš ï¸ è­¦å‘ŠçŠ¶æ…‹ãƒ†ã‚¹ãƒˆ: {is_warning}")
            set_switch_warning_state(slide_switch, is_warning)
        
        warning_btn = tk.Button(button_frame, text="âš ï¸ è­¦å‘ŠçŠ¶æ…‹åˆ‡æ›¿", command=test_warning)
        warning_btn.pack(side=tk.LEFT, padx=5)
        
        # çŠ¶æ…‹ç¢ºèªãƒœã‚¿ãƒ³
        def check_status():
            status = get_switch_status(slide_switch)
            print(f"ğŸ“Š SlideSwitchçŠ¶æ…‹: {status}")
        
        status_btn = tk.Button(button_frame, text="ğŸ“Š çŠ¶æ…‹ç¢ºèª", command=check_status)
        status_btn.pack(side=tk.LEFT, padx=5)
        
        # æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢
        info_frame = tk.LabelFrame(test_frame, text="ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½")
        info_frame.pack(fill=tk.X, padx=10, pady=10)
        
        info_text = """Phase2 æ–°æ©Ÿèƒ½:
â€¢ delay_off() - æŒ‡å®šç§’æ•°å¾Œã«è‡ªå‹•OFF
â€¢ animate_to_off() - OFFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
â€¢ cancel_delayed_off() - è‡ªå‹•OFFã‚­ãƒ£ãƒ³ã‚»ãƒ«
â€¢ set_switch_warning_state() - è­¦å‘ŠçŠ¶æ…‹è¡¨ç¤º
â€¢ get_switch_status() - è©³ç´°çŠ¶æ…‹å–å¾—

ä½¿ç”¨æ–¹æ³•:
1. [3ç§’å¾Œè‡ªå‹•OFF] - è‡ªå‹•OFFå®Ÿè¡Œãƒ†ã‚¹ãƒˆ
2. [ã‚­ãƒ£ãƒ³ã‚»ãƒ«] - è‡ªå‹•OFFã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
3. [è­¦å‘ŠçŠ¶æ…‹åˆ‡æ›¿] - è­¦å‘Šè¡¨ç¤ºã®ãƒ†ã‚¹ãƒˆ
4. [çŠ¶æ…‹ç¢ºèª] - ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«çŠ¶æ…‹å‡ºåŠ›"""

        info_label = tk.Label(info_frame, text=info_text, justify=tk.LEFT, font=("Yu Gothic UI", 9))
        info_label.pack(padx=10, pady=10)
        
        print("âœ… SlideSwitch Phase2 ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†")
        print("ğŸ® ãƒ†ã‚¹ãƒˆæ–¹æ³•:")
        print("  1. [3ç§’å¾Œè‡ªå‹•OFF] ãƒœã‚¿ãƒ³ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ")
        print("  2. [ã‚­ãƒ£ãƒ³ã‚»ãƒ«] ãƒœã‚¿ãƒ³ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ†ã‚¹ãƒˆ")
        print("  3. [è­¦å‘ŠçŠ¶æ…‹åˆ‡æ›¿] ã§è­¦å‘Šè¡¨ç¤ºãƒ†ã‚¹ãƒˆ")
        print("  4. SlideSwitchç›´æ¥ã‚¯ãƒªãƒƒã‚¯ã§æ‰‹å‹•æ“ä½œãƒ†ã‚¹ãƒˆ")
        
        # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦çµ‚äº†å‡¦ç†
        def on_closing():
            try:
                cancel_delayed_off(slide_switch)
                root.destroy()
            except Exception as e:
                print(f"âŒ ãƒ†ã‚¹ãƒˆçµ‚äº†ã‚¨ãƒ©ãƒ¼: {e}")
                root.destroy()
        
        root.protocol("WM_DELETE_WINDOW", on_closing)
        
        print("ğŸš€ SlideSwitch Phase2 ãƒ†ã‚¹ãƒˆé–‹å§‹ - ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¦çµ‚äº†")
        root.mainloop()
        
        print("âœ… SlideSwitch Phase2 ãƒ†ã‚¹ãƒˆå®Œäº†")
        return True
        
    except Exception as e:
        print(f"âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()
        return False


if __name__ == "__main__":
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    test_slide_switch_with_auto_off()


# === âœ… çµ±åˆé–¢æ•°: ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¹ã‚¤ãƒƒãƒä¸€æ‹¬åˆ¶å¾¡ ===


def set_slide_switch_state(switch_frame, state: bool, log_widget=None, message: str = ""):
    """
    ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¹ã‚¤ãƒƒãƒã®çŠ¶æ…‹ã‚’ä¸€æ‹¬å¤‰æ›´ï¼ˆå†…éƒ¨çŠ¶æ…‹ãƒ»UIãƒ»ãƒ­ã‚°åæ˜ ï¼‰

    Args:
        switch_frame: ã‚¹ã‚¤ãƒƒãƒã®å¤–æ ï¼ˆFrameï¼‰
        state (bool): Trueã§ON, Falseã§OFF
        log_widget: ãƒ­ã‚°è¡¨ç¤ºç”¨ã®ScrolledTextãªã©ï¼ˆä»»æ„ï¼‰
        message (str): è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰
    """
    try:
        switch_var = getattr(switch_frame, "toggle_var", None)
        if switch_var:
            switch_var.set(state)
        update_slide_switch_appearance(switch_frame, state)
        if log_widget and message:
            log_widget.insert("end", f"âš ï¸ {message}\n")
            log_widget.see("end")
    except Exception as e:
        print(f"âŒ set_slide_switch_stateã‚¨ãƒ©ãƒ¼: {e}")
