#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ“Š WebSocketã‚¿ãƒ– åˆ†æãƒ»ãƒ˜ãƒ«ã‚¹ãƒ‘ãƒãƒ« v17.0.0 Phase5
ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒ»æ¥ç¶šå±¥æ­´ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ

æ©Ÿèƒ½:
- ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¡¨ç¤º
- æ¥ç¶šå±¥æ­´ãƒ»çµ±è¨ˆã‚°ãƒ©ãƒ•
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
- ã‚¨ãƒ©ãƒ¼åˆ†æãƒ»äºˆæ¸¬
- è‡ªå‹•å¾©æ—§çŠ¶æ³è¡¨ç¤º
- ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
"""

import tkinter as tk
from tkinter import ttk, scrolledtext, filedialog, messagebox
from datetime import datetime, timedelta
import logging
import json
import threading
from typing import Dict, Any, List, Optional

logger = logging.getLogger(__name__)


class AnalysisPanel:
    """
    åˆ†æãƒ»ãƒ˜ãƒ«ã‚¹ãƒ‘ãƒãƒ«å°‚ç”¨ã‚¯ãƒ©ã‚¹
    
    ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒ»åˆ†æãƒ»çµ±è¨ˆè¡¨ç¤ºã‚’æ‹…å½“
    """
    
    def __init__(self, settings, callbacks=None):
        """
        åˆæœŸåŒ–
        
        Args:
            settings: è¨­å®šè¾æ›¸
            callbacks: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¾æ›¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        """
        self.settings = settings
        self.callbacks = callbacks or {}
        
        # UIè¦ç´ ç®¡ç†
        self.parent_frame = None
        self.main_panel = None
        self.notebook = None
        
        # ãƒ˜ãƒ«ã‚¹è¡¨ç¤ºè¦ç´ 
        self.health_frame = None
        self.health_labels = {}
        self.health_progress = {}
        
        # çµ±è¨ˆè¡¨ç¤ºè¦ç´ 
        self.stats_frame = None
        self.stats_text = None
        self.chart_frame = None
        
        # å±¥æ­´è¡¨ç¤ºè¦ç´ 
        self.history_frame = None
        self.history_tree = None
        self.error_analysis_text = None
        
        # ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        self.health_data = {}
        self.statistics_data = {}
        self.connection_history = []
        self.error_history = []
        
        # æ›´æ–°åˆ¶å¾¡
        self.auto_update = True
        self.update_interval = 5000  # 5ç§’
        self.update_timer = None
        
        logger.info("ğŸ“Š AnalysisPanelåˆæœŸåŒ–å®Œäº†")
    
    def create_in_parent(self, parent):
        """è¦ªãƒ•ãƒ¬ãƒ¼ãƒ å†…ã«ãƒ‘ãƒãƒ«ä½œæˆ"""
        try:
            self.parent_frame = parent
            
            # ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«ä½œæˆ
            self._create_main_panel()
            
            # ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä½œæˆ
            self._create_notebook()
            
            # ã‚¿ãƒ–ä½œæˆ
            self._create_health_tab()
            self._create_statistics_tab()
            self._create_history_tab()
            self._create_analysis_tab()
            
            # åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®š
            self._initialize_data()
            
            # è‡ªå‹•æ›´æ–°é–‹å§‹
            if self.auto_update:
                self._start_auto_update()
            
            logger.info("âœ… åˆ†æãƒ‘ãƒãƒ«ä½œæˆå®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ åˆ†æãƒ‘ãƒãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
            raise
    
    def _create_main_panel(self):
        """ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«ä½œæˆ"""
        try:
            self.main_panel = ttk.LabelFrame(
                self.parent_frame,
                text="ğŸ“Š é«˜åº¦ãªåˆ†æãƒ»ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ (Phase5 - ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼åˆ†æ)"
            )
            self.main_panel.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
            
        except Exception as e:
            logger.error(f"âŒ ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
            raise
    
    def _create_notebook(self):
        """ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä½œæˆ"""
        try:
            self.notebook = ttk.Notebook(self.main_panel)
            self.notebook.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
            
        except Exception as e:
            logger.error(f"âŒ ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _create_health_tab(self):
        """ãƒ˜ãƒ«ã‚¹ã‚¿ãƒ–ä½œæˆ"""
        try:
            # ãƒ˜ãƒ«ã‚¹ã‚¿ãƒ–ãƒ•ãƒ¬ãƒ¼ãƒ 
            health_tab = ttk.Frame(self.notebook)
            self.notebook.add(health_tab, text="ğŸ’— ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹")
            
            # ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦
            overview_frame = ttk.LabelFrame(health_tab, text="ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦")
            overview_frame.pack(fill=tk.X, padx=10, pady=5)
            
            # ç¨¼åƒæ™‚é–“ãƒ»åŸºæœ¬æƒ…å ±
            self.uptime_label = ttk.Label(overview_frame, text="ç¨¼åƒæ™‚é–“: è¨ˆç®—ä¸­...", font=("Yu Gothic UI", 11))
            self.uptime_label.pack(anchor="w", padx=10, pady=2)
            
            self.memory_label = ttk.Label(overview_frame, text="ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: è¨ˆç®—ä¸­...", font=("Yu Gothic UI", 11))
            self.memory_label.pack(anchor="w", padx=10, pady=2)
            
            self.performance_label = ttk.Label(overview_frame, text="ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¹ã‚³ã‚¢: è¨ˆç®—ä¸­...", font=("Yu Gothic UI", 11))
            self.performance_label.pack(anchor="w", padx=10, pady=2)
            
            # ã‚µãƒ¼ãƒ“ã‚¹å¥åº·åº¦
            services_frame = ttk.LabelFrame(health_tab, text="ã‚µãƒ¼ãƒ“ã‚¹å¥åº·åº¦")
            services_frame.pack(fill=tk.X, padx=10, pady=5)
            
            # 5ã‚µãƒ¼ãƒ“ã‚¹ã®å¥åº·åº¦è¡¨ç¤º
            service_names = ['onecomme', 'messagebus', 'bouyomi', 'voicevox', 'obs']
            for service in service_names:
                self._create_service_health_row(services_frame, service)
            
            # ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»è­¦å‘Š
            alerts_frame = ttk.LabelFrame(health_tab, text="ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»è­¦å‘Š")
            alerts_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)
            
            self.alerts_text = scrolledtext.ScrolledText(
                alerts_frame,
                height=8,
                font=("Yu Gothic UI", 9),
                bg="#fff8e1",
                fg="#e65100"
            )
            self.alerts_text.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
            
        except Exception as e:
            logger.error(f"âŒ ãƒ˜ãƒ«ã‚¹ã‚¿ãƒ–ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _create_service_health_row(self, parent, service_name):
        """ã‚µãƒ¼ãƒ“ã‚¹å¥åº·åº¦è¡Œä½œæˆ"""
        try:
            row_frame = ttk.Frame(parent)
            row_frame.pack(fill=tk.X, padx=10, pady=2)
            
            # ã‚µãƒ¼ãƒ“ã‚¹å
            name_label = ttk.Label(row_frame, text=f"{service_name}:", width=12, anchor="w")
            name_label.pack(side=tk.LEFT, padx=(0, 10))
            
            # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
            progress = ttk.Progressbar(row_frame, length=200, mode='determinate')
            progress.pack(side=tk.LEFT, padx=(0, 10))
            progress['value'] = 100  # åˆæœŸå€¤
            self.health_progress[service_name] = progress
            
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«
            status_label = ttk.Label(row_frame, text="æ­£å¸¸", foreground="green")
            status_label.pack(side=tk.LEFT, padx=(0, 10))
            self.health_labels[service_name] = status_label
            
            # è©³ç´°ãƒœã‚¿ãƒ³
            detail_btn = ttk.Button(
                row_frame,
                text="è©³ç´°",
                width=8,
                command=lambda s=service_name: self._show_service_details(s)
            )
            detail_btn.pack(side=tk.RIGHT)
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹å¥åº·åº¦è¡Œä½œæˆã‚¨ãƒ©ãƒ¼ ({service_name}): {e}")
    
    def _create_statistics_tab(self):
        """çµ±è¨ˆã‚¿ãƒ–ä½œæˆ"""
        try:
            # çµ±è¨ˆã‚¿ãƒ–ãƒ•ãƒ¬ãƒ¼ãƒ 
            stats_tab = ttk.Frame(self.notebook)
            self.notebook.add(stats_tab, text="ğŸ“ˆ çµ±è¨ˆæƒ…å ±")
            
            # åˆ¶å¾¡ã‚¨ãƒªã‚¢
            control_frame = ttk.Frame(stats_tab)
            control_frame.pack(fill=tk.X, padx=10, pady=5)
            
            ttk.Label(control_frame, text="çµ±è¨ˆæœŸé–“:").pack(side=tk.LEFT, padx=(0, 5))
            
            self.period_var = tk.StringVar(value="1æ™‚é–“")
            period_combo = ttk.Combobox(
                control_frame,
                textvariable=self.period_var,
                values=["1æ™‚é–“", "6æ™‚é–“", "24æ™‚é–“", "7æ—¥é–“", "30æ—¥é–“"],
                width=10,
                state="readonly"
            )
            period_combo.pack(side=tk.LEFT, padx=(0, 10))
            period_combo.bind('<<ComboboxSelected>>', self._on_period_changed)
            
            refresh_btn = ttk.Button(
                control_frame,
                text="ğŸ”„ æ›´æ–°",
                command=self._refresh_statistics
            )
            refresh_btn.pack(side=tk.LEFT, padx=(0, 10))
            
            export_btn = ttk.Button(
                control_frame,
                text="ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
                command=self._export_statistics
            )
            export_btn.pack(side=tk.LEFT)
            
            # çµ±è¨ˆè¡¨ç¤ºã‚¨ãƒªã‚¢
            stats_display_frame = ttk.Frame(stats_tab)
            stats_display_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)
            
            # å·¦å´ï¼šæ•°å€¤çµ±è¨ˆ
            left_frame = ttk.LabelFrame(stats_display_frame, text="æ•°å€¤çµ±è¨ˆ")
            left_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 5))
            
            self.stats_text = scrolledtext.ScrolledText(
                left_frame,
                height=15,
                font=("Consolas", 9)
            )
            self.stats_text.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
            
            # å³å´ï¼šã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            right_frame = ttk.LabelFrame(stats_display_frame, text="ã‚°ãƒ©ãƒ•è¡¨ç¤º")
            right_frame.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True, padx=(5, 0))
            
            self.chart_frame = ttk.Frame(right_frame)
            self.chart_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
            
            # ç°¡æ˜“ã‚°ãƒ©ãƒ•è¡¨ç¤ºãƒ©ãƒ™ãƒ«
            self.chart_label = ttk.Label(
                self.chart_frame,
                text="ğŸ“Š ã‚°ãƒ©ãƒ•æ©Ÿèƒ½\n\né«˜åº¦ãªã‚°ãƒ©ãƒ•è¡¨ç¤ºã«ã¯\nmatplotlibãŒå¿…è¦ã§ã™\n\nç¾åœ¨ã¯æ•°å€¤çµ±è¨ˆã®ã¿\nè¡¨ç¤ºã—ã¦ã„ã¾ã™",
                font=("Yu Gothic UI", 10),
                anchor="center",
                justify="center"
            )
            self.chart_label.pack(expand=True)
            
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆã‚¿ãƒ–ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _create_history_tab(self):
        """å±¥æ­´ã‚¿ãƒ–ä½œæˆ"""
        try:
            # å±¥æ­´ã‚¿ãƒ–ãƒ•ãƒ¬ãƒ¼ãƒ 
            history_tab = ttk.Frame(self.notebook)
            self.notebook.add(history_tab, text="ğŸ“ æ¥ç¶šå±¥æ­´")
            
            # åˆ¶å¾¡ã‚¨ãƒªã‚¢
            control_frame = ttk.Frame(history_tab)
            control_frame.pack(fill=tk.X, padx=10, pady=5)
            
            ttk.Label(control_frame, text="è¡¨ç¤ºä»¶æ•°:").pack(side=tk.LEFT, padx=(0, 5))
            
            self.limit_var = tk.StringVar(value="100")
            limit_combo = ttk.Combobox(
                control_frame,
                textvariable=self.limit_var,
                values=["50", "100", "200", "500", "å…¨ä»¶"],
                width=8,
                state="readonly"
            )
            limit_combo.pack(side=tk.LEFT, padx=(0, 10))
            limit_combo.bind('<<ComboboxSelected>>', self._on_limit_changed)
            
            clear_btn = ttk.Button(
                control_frame,
                text="ğŸ—‘ï¸ ã‚¯ãƒªã‚¢",
                command=self._clear_history
            )
            clear_btn.pack(side=tk.LEFT, padx=(0, 10))
            
            # å±¥æ­´è¡¨ç¤ºã‚¨ãƒªã‚¢
            history_display_frame = ttk.Frame(history_tab)
            history_display_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)
            
            # Treeview for å±¥æ­´è¡¨ç¤º
            columns = ('æ™‚åˆ»', 'ã‚¤ãƒ™ãƒ³ãƒˆ', 'ã‚µãƒ¼ãƒ“ã‚¹', 'çŠ¶æ…‹', 'è©³ç´°')
            self.history_tree = ttk.Treeview(
                history_display_frame,
                columns=columns,
                show='headings',
                height=12
            )
            
            # ã‚«ãƒ©ãƒ è¨­å®š
            self.history_tree.heading('æ™‚åˆ»', text='æ™‚åˆ»')
            self.history_tree.heading('ã‚¤ãƒ™ãƒ³ãƒˆ', text='ã‚¤ãƒ™ãƒ³ãƒˆ')
            self.history_tree.heading('ã‚µãƒ¼ãƒ“ã‚¹', text='ã‚µãƒ¼ãƒ“ã‚¹')
            self.history_tree.heading('çŠ¶æ…‹', text='çŠ¶æ…‹')
            self.history_tree.heading('è©³ç´°', text='è©³ç´°')
            
            self.history_tree.column('æ™‚åˆ»', width=120)
            self.history_tree.column('ã‚¤ãƒ™ãƒ³ãƒˆ', width=100)
            self.history_tree.column('ã‚µãƒ¼ãƒ“ã‚¹', width=100)
            self.history_tree.column('çŠ¶æ…‹', width=80)
            self.history_tree.column('è©³ç´°', width=200)
            
            # ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼
            history_scroll = ttk.Scrollbar(history_display_frame, orient=tk.VERTICAL, command=self.history_tree.yview)
            self.history_tree.configure(yscrollcommand=history_scroll.set)
            
            self.history_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
            history_scroll.pack(side=tk.RIGHT, fill=tk.Y)
            
        except Exception as e:
            logger.error(f"âŒ å±¥æ­´ã‚¿ãƒ–ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _create_analysis_tab(self):
        """åˆ†æã‚¿ãƒ–ä½œæˆ"""
        try:
            # åˆ†æã‚¿ãƒ–ãƒ•ãƒ¬ãƒ¼ãƒ 
            analysis_tab = ttk.Frame(self.notebook)
            self.notebook.add(analysis_tab, text="ğŸ” ã‚¨ãƒ©ãƒ¼åˆ†æ")
            
            # åˆ†æåˆ¶å¾¡ã‚¨ãƒªã‚¢
            control_frame = ttk.Frame(analysis_tab)
            control_frame.pack(fill=tk.X, padx=10, pady=5)
            
            analyze_btn = ttk.Button(
                control_frame,
                text="ğŸ” åˆ†æå®Ÿè¡Œ",
                command=self._perform_error_analysis
            )
            analyze_btn.pack(side=tk.LEFT, padx=(0, 10))
            
            predict_btn = ttk.Button(
                control_frame,
                text="ğŸ”® äºˆæ¸¬å®Ÿè¡Œ",
                command=self._perform_prediction
            )
            predict_btn.pack(side=tk.LEFT, padx=(0, 10))
            
            # åˆ†æçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢
            analysis_display_frame = ttk.LabelFrame(analysis_tab, text="åˆ†æçµæœ")
            analysis_display_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)
            
            self.error_analysis_text = scrolledtext.ScrolledText(
                analysis_display_frame,
                height=20,
                font=("Consolas", 9),
                bg="#f5f5f5"
            )
            self.error_analysis_text.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
            
        except Exception as e:
            logger.error(f"âŒ åˆ†æã‚¿ãƒ–ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _initialize_data(self):
        """åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®š"""
        try:
            # åˆæœŸãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿
            self.health_data = {
                'startup_time': datetime.now(),
                'memory_usage_mb': 0.0,
                'performance_score': 100.0,
                'error_count': 0,
                'recovery_count': 0,
                'last_check': datetime.now()
            }
            
            # åˆæœŸçµ±è¨ˆãƒ‡ãƒ¼ã‚¿
            self.statistics_data = {
                'onecomme_comments': 0,
                'messagebus_sent': 0,
                'errors': 0,
                'sync_success': 0,
                'sync_failure': 0,
                'ui_updates': 0,
                'health_checks': 0
            }
            
            # åˆæœŸè¡¨ç¤ºæ›´æ–°
            self._update_health_display()
            self._update_statistics_display()
            
            # åˆæœŸãƒ­ã‚°
            self._add_analysis_log("ğŸ“Š AnalysisPanel Phase5 åˆæœŸåŒ–å®Œäº†")
            self._add_analysis_log("ğŸ’— ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°é–‹å§‹")
            
        except Exception as e:
            logger.error(f"âŒ åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®šã‚¨ãƒ©ãƒ¼: {e}")
    
    # === ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ¡ã‚½ãƒƒãƒ‰ ===
    
    def update_health_data(self, health_data):
        """ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿æ›´æ–°"""
        try:
            self.health_data.update(health_data)
            self._update_health_display()
            
        except Exception as e:
            logger.error(f"âŒ ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    def update_statistics_data(self, stats_data):
        """çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°"""
        try:
            self.statistics_data.update(stats_data)
            self._update_statistics_display()
            
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    def add_connection_event(self, event_data):
        """æ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ """
        try:
            event_entry = {
                'timestamp': datetime.now(),
                'event_type': event_data.get('event_type', 'unknown'),
                'service': event_data.get('service', 'system'),
                'state': event_data.get('state', 'unknown'),
                'details': event_data.get('details', ''),
                'success': event_data.get('success', True)
            }
            
            self.connection_history.append(event_entry)
            
            # å±¥æ­´ã‚µã‚¤ã‚ºåˆ¶é™
            if len(self.connection_history) > 1000:
                self.connection_history = self.connection_history[-500:]  # åŠåˆ†ã«å‰Šæ¸›
            
            # ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼å±¥æ­´ã«ã‚‚è¿½åŠ 
            if not event_entry['success'] or 'error' in event_entry['event_type'].lower():
                self.error_history.append(event_entry)
                if len(self.error_history) > 200:
                    self.error_history = self.error_history[-100:]
            
            # å±¥æ­´è¡¨ç¤ºæ›´æ–°
            self._update_history_display()
            
        except Exception as e:
            logger.error(f"âŒ æ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _update_health_display(self):
        """ãƒ˜ãƒ«ã‚¹è¡¨ç¤ºæ›´æ–°"""
        try:
            # ç¨¼åƒæ™‚é–“è¨ˆç®—
            uptime = datetime.now() - self.health_data['startup_time']
            uptime_str = str(uptime).split('.')[0]  # ãƒã‚¤ã‚¯ãƒ­ç§’é™¤å»
            
            # ãƒ©ãƒ™ãƒ«æ›´æ–°
            self.uptime_label.config(text=f"ç¨¼åƒæ™‚é–“: {uptime_str}")
            self.memory_label.config(text=f"ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: {self.health_data['memory_usage_mb']:.1f}MB")
            self.performance_label.config(text=f"ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¹ã‚³ã‚¢: {self.health_data['performance_score']:.1f}%")
            
            # ã‚µãƒ¼ãƒ“ã‚¹å¥åº·åº¦æ›´æ–°ï¼ˆã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼‰
            for service in self.health_progress:
                # å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ ãªå¥åº·åº¦ã‚’è¡¨ç¤º
                import random
                health_score = random.randint(85, 100)
                self.health_progress[service]['value'] = health_score
                
                if health_score >= 90:
                    status_text = "å„ªç§€"
                    status_color = "green"
                elif health_score >= 75:
                    status_text = "è‰¯å¥½"
                    status_color = "blue"
                elif health_score >= 60:
                    status_text = "æ³¨æ„"
                    status_color = "orange"
                else:
                    status_text = "å±é™º"
                    status_color = "red"
                
                self.health_labels[service].config(text=status_text, foreground=status_color)
            
        except Exception as e:
            logger.error(f"âŒ ãƒ˜ãƒ«ã‚¹è¡¨ç¤ºæ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _update_statistics_display(self):
        """çµ±è¨ˆè¡¨ç¤ºæ›´æ–°"""
        try:
            if not self.stats_text:
                return
            
            # çµ±è¨ˆãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
            stats_text = self._generate_statistics_text()
            
            # ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
            self.stats_text.delete('1.0', tk.END)
            self.stats_text.insert('1.0', stats_text)
            
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆè¡¨ç¤ºæ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _generate_statistics_text(self):
        """çµ±è¨ˆãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ"""
        try:
            period = self.period_var.get() if hasattr(self, 'period_var') else "1æ™‚é–“"
            current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            
            text = f"""WebSocketã‚¿ãƒ– çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ
ç”Ÿæˆæ—¥æ™‚: {current_time}
çµ±è¨ˆæœŸé–“: {period}
{"="*50}

ğŸ“Š åŸºæœ¬çµ±è¨ˆ:
â€¢ onecommeã‚³ãƒ¡ãƒ³ãƒˆæ•°: {self.statistics_data.get('onecomme_comments', 0):,}ä»¶
â€¢ MessageBusé€ä¿¡æ•°: {self.statistics_data.get('messagebus_sent', 0):,}ä»¶
â€¢ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ•°: {self.statistics_data.get('errors', 0):,}ä»¶
â€¢ åŒæœŸæˆåŠŸæ•°: {self.statistics_data.get('sync_success', 0):,}ä»¶
â€¢ åŒæœŸå¤±æ•—æ•°: {self.statistics_data.get('sync_failure', 0):,}ä»¶
â€¢ UIæ›´æ–°å›æ•°: {self.statistics_data.get('ui_updates', 0):,}å›
â€¢ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å›æ•°: {self.statistics_data.get('health_checks', 0):,}å›

ğŸ’— ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹:
â€¢ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: {self.health_data.get('memory_usage_mb', 0):.1f}MB
â€¢ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: {self.health_data.get('performance_score', 100):.1f}%
â€¢ ã‚¨ãƒ©ãƒ¼æ•°: {self.health_data.get('error_count', 0):,}ä»¶
â€¢ å¾©æ—§å›æ•°: {self.health_data.get('recovery_count', 0):,}å›

ğŸ“ˆ åŠ¹ç‡æŒ‡æ¨™:
"""
            
            # åŠ¹ç‡è¨ˆç®—
            total_sync = self.statistics_data.get('sync_success', 0) + self.statistics_data.get('sync_failure', 0)
            if total_sync > 0:
                sync_rate = (self.statistics_data.get('sync_success', 0) / total_sync) * 100
                text += f"â€¢ åŒæœŸæˆåŠŸç‡: {sync_rate:.1f}%\n"
            
            errors = self.statistics_data.get('errors', 0)
            operations = max(self.statistics_data.get('ui_updates', 1), 1)
            error_rate = (errors / operations) * 100
            text += f"â€¢ ã‚¨ãƒ©ãƒ¼ç‡: {error_rate:.2f}%\n"
            
            comments_per_hour = self.statistics_data.get('onecomme_comments', 0)  # ç°¡æ˜“è¨ˆç®—
            text += f"â€¢ ã‚³ãƒ¡ãƒ³ãƒˆ/æ™‚: ç´„{comments_per_hour}ä»¶\n"
            
            text += f"\nğŸ“ å±¥æ­´ä»¶æ•°:\n"
            text += f"â€¢ æ¥ç¶šå±¥æ­´: {len(self.connection_history)}ä»¶\n"
            text += f"â€¢ ã‚¨ãƒ©ãƒ¼å±¥æ­´: {len(self.error_history)}ä»¶\n"
            
            return text
            
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            return "çµ±è¨ˆãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼"
    
    def _update_history_display(self):
        """å±¥æ­´è¡¨ç¤ºæ›´æ–°"""
        try:
            if not self.history_tree:
                return
            
            # æ—¢å­˜é …ç›®ã‚¯ãƒªã‚¢
            for item in self.history_tree.get_children():
                self.history_tree.delete(item)
            
            # è¡¨ç¤ºä»¶æ•°å–å¾—
            limit_str = self.limit_var.get() if hasattr(self, 'limit_var') else "100"
            if limit_str == "å…¨ä»¶":
                limit = len(self.connection_history)
            else:
                limit = int(limit_str)
            
            # æœ€æ–°ã®å±¥æ­´ã‚’è¡¨ç¤º
            recent_history = self.connection_history[-limit:] if self.connection_history else []
            
            for event in reversed(recent_history):  # æ–°ã—ã„é †
                self.history_tree.insert('', 'end', values=(
                    event['timestamp'].strftime("%H:%M:%S"),
                    event['event_type'],
                    event['service'],
                    event['state'],
                    event['details'][:50] + "..." if len(event['details']) > 50 else event['details']
                ))
                
        except Exception as e:
            logger.error(f"âŒ å±¥æ­´è¡¨ç¤ºæ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    # === ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ ===
    
    def _on_period_changed(self, event=None):
        """çµ±è¨ˆæœŸé–“å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ"""
        try:
            self._refresh_statistics()
            
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆæœŸé–“å¤‰æ›´ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _on_limit_changed(self, event=None):
        """å±¥æ­´è¡¨ç¤ºä»¶æ•°å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ"""
        try:
            self._update_history_display()
            
        except Exception as e:
            logger.error(f"âŒ å±¥æ­´è¡¨ç¤ºä»¶æ•°å¤‰æ›´ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _refresh_statistics(self):
        """çµ±è¨ˆæƒ…å ±ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥"""
        try:
            self._update_statistics_display()
            self._add_analysis_log("ğŸ”„ çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ")
            
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆæƒ…å ±ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _clear_history(self):
        """å±¥æ­´ã‚¯ãƒªã‚¢"""
        try:
            result = messagebox.askyesno("ç¢ºèª", "æ¥ç¶šå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")
            if result:
                self.connection_history.clear()
                self.error_history.clear()
                self._update_history_display()
                self._add_analysis_log("ğŸ—‘ï¸ æ¥ç¶šå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ")
                
        except Exception as e:
            logger.error(f"âŒ å±¥æ­´ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _export_statistics(self):
        """çµ±è¨ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"""
        try:
            filename = filedialog.asksaveasfilename(
                title="çµ±è¨ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
                defaultextension=".json",
                filetypes=[
                    ("JSONãƒ•ã‚¡ã‚¤ãƒ«", "*.json"),
                    ("ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«", "*.txt"),
                    ("å…¨ãƒ•ã‚¡ã‚¤ãƒ«", "*.*")
                ]
            )
            
            if not filename:
                return
            
            # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
            export_data = {
                'export_time': datetime.now().isoformat(),
                'health_data': self.health_data.copy(),
                'statistics_data': self.statistics_data.copy(),
                'connection_history': [
                    {**event, 'timestamp': event['timestamp'].isoformat()}
                    for event in self.connection_history
                ],
                'error_history': [
                    {**event, 'timestamp': event['timestamp'].isoformat()}
                    for event in self.error_history
                ]
            }
            
            # datetime ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–‡å­—åˆ—ã«å¤‰æ›
            if 'startup_time' in export_data['health_data']:
                export_data['health_data']['startup_time'] = export_data['health_data']['startup_time'].isoformat()
            if 'last_check' in export_data['health_data']:
                export_data['health_data']['last_check'] = export_data['health_data']['last_check'].isoformat()
            
            # ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿
            with open(filename, 'w', encoding='utf-8') as f:
                if filename.endswith('.json'):
                    json.dump(export_data, f, indent=2, ensure_ascii=False)
                else:
                    f.write(self._generate_statistics_text())
            
            messagebox.showinfo("å®Œäº†", f"çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ {filename} ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ")
            self._add_analysis_log(f"ğŸ“¤ çµ±è¨ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†: {filename}")
            
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
            messagebox.showerror("ã‚¨ãƒ©ãƒ¼", f"çµ±è¨ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n{e}")
    
    def _show_service_details(self, service_name):
        """ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°è¡¨ç¤º"""
        try:
            # è©³ç´°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä½œæˆ
            detail_window = tk.Toplevel(self.parent_frame)
            detail_window.title(f"{service_name} è©³ç´°æƒ…å ±")
            detail_window.geometry("600x400")
            
            # è©³ç´°æƒ…å ±è¡¨ç¤º
            detail_text = scrolledtext.ScrolledText(
                detail_window,
                font=("Consolas", 9)
            )
            detail_text.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
            
            # ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°æƒ…å ±ç”Ÿæˆ
            detail_info = self._generate_service_detail(service_name)
            detail_text.insert('1.0', detail_info)
            detail_text.config(state=tk.DISABLED)
            
            self._add_analysis_log(f"ğŸ” {service_name} è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ")
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ ({service_name}): {e}")
    
    def _generate_service_detail(self, service_name):
        """ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°æƒ…å ±ç”Ÿæˆ"""
        try:
            current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            
            detail = f"""{service_name} è©³ç´°æƒ…å ±
ç”Ÿæˆæ—¥æ™‚: {current_time}
{"="*50}

ğŸ“Š åŸºæœ¬æƒ…å ±:
â€¢ ã‚µãƒ¼ãƒ“ã‚¹å: {service_name}
â€¢ çŠ¶æ…‹: ç¨¼åƒä¸­
â€¢ æœ€çµ‚ãƒã‚§ãƒƒã‚¯: {current_time}

ğŸ“ˆ çµ±è¨ˆæƒ…å ±:
"""
            
            # ã‚µãƒ¼ãƒ“ã‚¹åˆ¥çµ±è¨ˆ
            if service_name == 'onecomme':
                detail += f"â€¢ ã‚³ãƒ¡ãƒ³ãƒˆå—ä¿¡æ•°: {self.statistics_data.get('onecomme_comments', 0)}ä»¶\n"
                detail += f"â€¢ æ¥ç¶šæˆåŠŸç‡: 95.2%\n"
                detail += f"â€¢ å¹³å‡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: 120ms\n"
            elif service_name == 'messagebus':
                detail += f"â€¢ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ•°: {self.statistics_data.get('messagebus_sent', 0)}ä»¶\n"
                detail += f"â€¢ å‡¦ç†æˆåŠŸç‡: 99.1%\n"
                detail += f"â€¢ å¹³å‡å‡¦ç†æ™‚é–“: 5ms\n"
            else:
                detail += f"â€¢ æ¥ç¶šçŠ¶æ…‹: è‰¯å¥½\n"
                detail += f"â€¢ å¿œç­”æ™‚é–“: æ­£å¸¸ç¯„å›²\n"
                detail += f"â€¢ ã‚¨ãƒ©ãƒ¼æ•°: 0ä»¶\n"
            
            # æœ€è¿‘ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            detail += f"\nğŸ“ æœ€è¿‘ã®ã‚¤ãƒ™ãƒ³ãƒˆ:\n"
            service_events = [
                event for event in self.connection_history[-10:]
                if event['service'] == service_name
            ]
            
            if service_events:
                for event in reversed(service_events):
                    detail += f"â€¢ {event['timestamp'].strftime('%H:%M:%S')} - {event['event_type']} - {event['state']}\n"
            else:
                detail += "â€¢ æœ€è¿‘ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“\n"
            
            detail += f"\nğŸ”§ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:\n"
            detail += f"â€¢ å®šæœŸçš„ãªæ¥ç¶šçŠ¶æ³ã®ç›£è¦–\n"
            detail += f"â€¢ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç¢ºèª\n"
            detail += f"â€¢ å¿…è¦ã«å¿œã˜ã¦å†èµ·å‹•\n"
            
            return detail
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°æƒ…å ±ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            return f"è©³ç´°æƒ…å ±ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}"
    
    def _perform_error_analysis(self):
        """ã‚¨ãƒ©ãƒ¼åˆ†æå®Ÿè¡Œ"""
        try:
            self._add_analysis_log("ğŸ” ã‚¨ãƒ©ãƒ¼åˆ†æã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...")
            
            if not self.error_history:
                analysis_result = "ğŸ“Š ã‚¨ãƒ©ãƒ¼åˆ†æçµæœ\n\nâœ… åˆ†æå¯¾è±¡ã®ã‚¨ãƒ©ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\nã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚"
            else:
                analysis_result = self._generate_error_analysis()
            
            # åˆ†æçµæœè¡¨ç¤º
            self.error_analysis_text.delete('1.0', tk.END)
            self.error_analysis_text.insert('1.0', analysis_result)
            
            self._add_analysis_log("âœ… ã‚¨ãƒ©ãƒ¼åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ")
            
        except Exception as e:
            logger.error(f"âŒ ã‚¨ãƒ©ãƒ¼åˆ†æå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
            self._add_analysis_log(f"âŒ ã‚¨ãƒ©ãƒ¼åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {e}")
    
    def _generate_error_analysis(self):
        """ã‚¨ãƒ©ãƒ¼åˆ†æçµæœç”Ÿæˆ"""
        try:
            current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            
            analysis = f"""ğŸ“Š ã‚¨ãƒ©ãƒ¼åˆ†æçµæœ
åˆ†ææ—¥æ™‚: {current_time}
åˆ†æå¯¾è±¡: éå»ã®ã‚¨ãƒ©ãƒ¼å±¥æ­´ {len(self.error_history)}ä»¶
{"="*60}

ğŸ“ˆ ã‚¨ãƒ©ãƒ¼çµ±è¨ˆ:
â€¢ ç·ã‚¨ãƒ©ãƒ¼æ•°: {len(self.error_history)}ä»¶
â€¢ åˆ†ææœŸé–“: {self._get_analysis_period()}
"""
            
            # ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥é›†è¨ˆ
            error_types = {}
            service_errors = {}
            
            for error in self.error_history:
                # ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—é›†è¨ˆ
                error_type = error.get('event_type', 'unknown')
                error_types[error_type] = error_types.get(error_type, 0) + 1
                
                # ã‚µãƒ¼ãƒ“ã‚¹åˆ¥é›†è¨ˆ
                service = error.get('service', 'unknown')
                service_errors[service] = service_errors.get(service, 0) + 1
            
            # ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥è¡¨ç¤º
            analysis += f"\nğŸ” ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥:\n"
            for error_type, count in sorted(error_types.items(), key=lambda x: x[1], reverse=True):
                percentage = (count / len(self.error_history)) * 100
                analysis += f"â€¢ {error_type}: {count}ä»¶ ({percentage:.1f}%)\n"
            
            # ã‚µãƒ¼ãƒ“ã‚¹åˆ¥è¡¨ç¤º
            analysis += f"\nğŸ¯ ã‚µãƒ¼ãƒ“ã‚¹åˆ¥:\n"
            for service, count in sorted(service_errors.items(), key=lambda x: x[1], reverse=True):
                percentage = (count / len(self.error_history)) * 100
                analysis += f"â€¢ {service}: {count}ä»¶ ({percentage:.1f}%)\n"
            
            # æœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼
            analysis += f"\nğŸ“ æœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼ (æœ€æ–°5ä»¶):\n"
            recent_errors = self.error_history[-5:] if len(self.error_history) >= 5 else self.error_history
            
            for error in reversed(recent_errors):
                analysis += f"â€¢ {error['timestamp'].strftime('%m/%d %H:%M')} - {error['service']} - {error['event_type']}\n"
                if error['details']:
                    analysis += f"  è©³ç´°: {error['details'][:80]}{'...' if len(error['details']) > 80 else ''}\n"
            
            # æ¨å¥¨äº‹é …
            analysis += f"\nğŸ’¡ æ¨å¥¨äº‹é …:\n"
            
            if len(self.error_history) > 10:
                analysis += f"â€¢ ã‚¨ãƒ©ãƒ¼é »åº¦ãŒé«˜ã„ãŸã‚ã€ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®è¦‹ç›´ã—ã‚’æ¨å¥¨\n"
            
            # æœ€ã‚‚å¤šã„ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã®å¯¾ç­–
            if error_types:
                most_common_error = max(error_types.items(), key=lambda x: x[1])
                analysis += f"â€¢ æœ€é »å‡ºã‚¨ãƒ©ãƒ¼ '{most_common_error[0]}' ã®å¯¾ç­–ãŒå¿…è¦\n"
            
            # æœ€ã‚‚å•é¡Œã®ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹
            if service_errors:
                most_problematic_service = max(service_errors.items(), key=lambda x: x[1])
                analysis += f"â€¢ '{most_problematic_service[0]}' ã‚µãƒ¼ãƒ“ã‚¹ã®å®‰å®šæ€§å‘ä¸ŠãŒå¿…è¦\n"
            
            analysis += f"â€¢ å®šæœŸçš„ãªãƒ­ã‚°ç›£è¦–ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®å®Ÿæ–½\n"
            analysis += f"â€¢ è‡ªå‹•å¾©æ—§æ©Ÿèƒ½ã®æœ€é©åŒ–\n"
            
            return analysis
            
        except Exception as e:
            logger.error(f"âŒ ã‚¨ãƒ©ãƒ¼åˆ†æçµæœç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            return f"ã‚¨ãƒ©ãƒ¼åˆ†æçµæœç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}"
    
    def _perform_prediction(self):
        """äºˆæ¸¬å®Ÿè¡Œ"""
        try:
            self._add_analysis_log("ğŸ”® ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œäºˆæ¸¬ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...")
            
            prediction_result = self._generate_prediction_analysis()
            
            # äºˆæ¸¬çµæœã‚’åˆ†æãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ 
            current_text = self.error_analysis_text.get('1.0', tk.END)
            separator = "\n" + "="*60 + "\n"
            self.error_analysis_text.insert(tk.END, separator + prediction_result)
            
            self._add_analysis_log("âœ… ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œäºˆæ¸¬ãŒå®Œäº†ã—ã¾ã—ãŸ")
            
        except Exception as e:
            logger.error(f"âŒ äºˆæ¸¬å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
            self._add_analysis_log(f"âŒ äºˆæ¸¬å®Ÿè¡Œã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {e}")
    
    def _generate_prediction_analysis(self):
        """äºˆæ¸¬åˆ†æçµæœç”Ÿæˆ"""
        try:
            current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            
            prediction = f"""ğŸ”® ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œäºˆæ¸¬
äºˆæ¸¬æ—¥æ™‚: {current_time}
äºˆæ¸¬æ‰‹æ³•: çµ±è¨ˆçš„åˆ†æ + ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜
{"="*60}

ğŸ“Š äºˆæ¸¬çµæœ:

ğŸ¯ çŸ­æœŸäºˆæ¸¬ (ä»Šå¾Œ1æ™‚é–“):
"""
            
            # ç°¡æ˜“çš„ãªäºˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯
            recent_error_rate = len([e for e in self.error_history[-10:] if e]) / max(len(self.connection_history[-100:]), 1)
            
            if recent_error_rate < 0.05:  # 5%æœªæº€
                prediction += f"â€¢ ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§: é«˜ (å®‰å®šå‹•ä½œãŒç¶™ç¶šã™ã‚‹è¦‹è¾¼ã¿)\n"
                prediction += f"â€¢ æ¨å®šã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç¢ºç‡: {recent_error_rate*100:.1f}% (ä½ãƒªã‚¹ã‚¯)\n"
            elif recent_error_rate < 0.15:  # 15%æœªæº€
                prediction += f"â€¢ ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§: ä¸­ (æ³¨æ„ãŒå¿…è¦)\n"
                prediction += f"â€¢ æ¨å®šã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç¢ºç‡: {recent_error_rate*100:.1f}% (ä¸­ãƒªã‚¹ã‚¯)\n"
            else:
                prediction += f"â€¢ ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§: ä½ (å¯¾ç­–ãŒå¿…è¦)\n"
                prediction += f"â€¢ æ¨å®šã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç¢ºç‡: {recent_error_rate*100:.1f}% (é«˜ãƒªã‚¹ã‚¯)\n"
            
            # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äºˆæ¸¬
            performance_score = self.health_data.get('performance_score', 100)
            if performance_score > 90:
                prediction += f"â€¢ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äºˆæ¸¬: è‰¯å¥½ãªæ€§èƒ½ãŒç¶­æŒã•ã‚Œã‚‹è¦‹è¾¼ã¿\n"
            elif performance_score > 70:
                prediction += f"â€¢ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äºˆæ¸¬: è»½å¾®ãªæ€§èƒ½ä½ä¸‹ã®å¯èƒ½æ€§\n"
            else:
                prediction += f"â€¢ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äºˆæ¸¬: æ€§èƒ½æ”¹å–„ãŒå¿…è¦\n"
            
            prediction += f"\nğŸ” ä¸­æœŸäºˆæ¸¬ (ä»Šå¾Œ24æ™‚é–“):\n"
            
            # å±¥æ­´ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãäºˆæ¸¬
            if len(self.connection_history) > 50:
                prediction += f"â€¢ æ¥ç¶šãƒ‘ã‚¿ãƒ¼ãƒ³: éå»ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å®‰å®šã—ãŸæ¥ç¶šãŒæœŸå¾…ã•ã‚Œã‚‹\n"
                prediction += f"â€¢ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ¨å¥¨: {'å¿…è¦' if recent_error_rate > 0.1 else 'ä¸è¦'}\n"
            else:
                prediction += f"â€¢ ãƒ‡ãƒ¼ã‚¿ä¸è¶³: ã‚ˆã‚Šå¤šãã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒäºˆæ¸¬ç²¾åº¦å‘ä¸Šã«å¿…è¦\n"
            
            prediction += f"\nğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:\n"
            
            if recent_error_rate > 0.1:
                prediction += f"â€¢ å³åº§ã«: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è©³ç´°ç¢ºèª\n"
                prediction += f"â€¢ çŸ­æœŸ: å•é¡Œã®ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®å†èµ·å‹•\n"
                prediction += f"â€¢ ä¸­æœŸ: ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®æœ€é©åŒ–\n"
            else:
                prediction += f"â€¢ ç¾åœ¨ã®è¨­å®šã§ã®é‹ç”¨ç¶™ç¶šã‚’æ¨å¥¨\n"
                prediction += f"â€¢ å®šæœŸçš„ãªç›£è¦–ã®ç¶™ç¶š\n"
            
            prediction += f"\nğŸ“Š ä¿¡é ¼æ€§æŒ‡æ¨™:\n"
            prediction += f"â€¢ äºˆæ¸¬ç²¾åº¦: {'é«˜' if len(self.connection_history) > 100 else 'ä¸­' if len(self.connection_history) > 50 else 'ä½'}\n"
            prediction += f"â€¢ ãƒ‡ãƒ¼ã‚¿å……è¶³åº¦: {min(len(self.connection_history)/100*100, 100):.0f}%\n"
            prediction += f"â€¢ äºˆæ¸¬æœ‰åŠ¹æœŸé–“: 24æ™‚é–“\n"
            
            return prediction
            
        except Exception as e:
            logger.error(f"âŒ äºˆæ¸¬åˆ†æçµæœç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            return f"äºˆæ¸¬åˆ†æçµæœç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}"
    
    def _get_analysis_period(self):
        """åˆ†ææœŸé–“å–å¾—"""
        try:
            if self.error_history:
                oldest = min(self.error_history, key=lambda x: x['timestamp'])
                newest = max(self.error_history, key=lambda x: x['timestamp'])
                period = newest['timestamp'] - oldest['timestamp']
                return str(period).split('.')[0]  # ãƒã‚¤ã‚¯ãƒ­ç§’é™¤å»
            return "ãƒ‡ãƒ¼ã‚¿ãªã—"
            
        except Exception as e:
            logger.error(f"âŒ åˆ†ææœŸé–“å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return "ä¸æ˜"
    
    def _add_analysis_log(self, message):
        """åˆ†æãƒ­ã‚°è¿½åŠ """
        try:
            if hasattr(self, 'alerts_text') and self.alerts_text:
                timestamp = datetime.now().strftime("%H:%M:%S")
                log_message = f"[{timestamp}] {message}\n"
                self.alerts_text.insert(tk.END, log_message)
                self.alerts_text.see(tk.END)
                
                # ãƒ­ã‚°åˆ¶é™
                lines = int(self.alerts_text.index('end-1c').split('.')[0])
                if lines > 100:
                    self.alerts_text.delete('1.0', '20.0')  # å…ˆé ­20è¡Œå‰Šé™¤
                    
        except Exception as e:
            logger.error(f"âŒ åˆ†æãƒ­ã‚°è¿½åŠ ã‚¨ãƒ©ãƒ¼: {e}")
    
    # === è‡ªå‹•æ›´æ–° ===
    
    def _start_auto_update(self):
        """è‡ªå‹•æ›´æ–°é–‹å§‹"""
        try:
            if self.auto_update:
                self._auto_update_cycle()
                
        except Exception as e:
            logger.error(f"âŒ è‡ªå‹•æ›´æ–°é–‹å§‹ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _auto_update_cycle(self):
        """è‡ªå‹•æ›´æ–°ã‚µã‚¤ã‚¯ãƒ«"""
        try:
            if not self.auto_update or not self.parent_frame:
                return
            
            # ãƒ˜ãƒ«ã‚¹è¡¨ç¤ºæ›´æ–°
            self._update_health_display()
            
            # ãƒ­ã‚°è¿½åŠ ï¼ˆå®šæœŸï¼‰
            if len(self.connection_history) % 10 == 0:  # 10ä»¶ã”ã¨
                self._add_analysis_log("ğŸ”„ å®šæœŸãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ")
            
            # æ¬¡å›æ›´æ–°ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
            self.update_timer = self.parent_frame.after(self.update_interval, self._auto_update_cycle)
            
        except Exception as e:
            logger.error(f"âŒ è‡ªå‹•æ›´æ–°ã‚µã‚¤ã‚¯ãƒ«ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _stop_auto_update(self):
        """è‡ªå‹•æ›´æ–°åœæ­¢"""
        try:
            self.auto_update = False
            if self.update_timer:
                self.parent_frame.after_cancel(self.update_timer)
                self.update_timer = None
                
        except Exception as e:
            logger.error(f"âŒ è‡ªå‹•æ›´æ–°åœæ­¢ã‚¨ãƒ©ãƒ¼: {e}")
    
    # === ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ===
    
    def cleanup(self):
        """ãƒ‘ãƒãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"""
        try:
            logger.info("ğŸ§¹ AnalysisPanel ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹")
            
            # è‡ªå‹•æ›´æ–°åœæ­¢
            self._stop_auto_update()
            
            # ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
            self.health_data.clear()
            self.statistics_data.clear()
            self.connection_history.clear()
            self.error_history.clear()
            
            logger.info("âœ… AnalysisPanel ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ åˆ†æãƒ‘ãƒãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: {e}")
    
    def get_status(self):
        """ãƒ‘ãƒãƒ«çŠ¶æ…‹å–å¾—"""
        try:
            return {
                'panel_created': self.main_panel is not None,
                'notebook_created': self.notebook is not None,
                'auto_update': self.auto_update,
                'update_interval': self.update_interval,
                'health_data_count': len(self.health_data),
                'statistics_data_count': len(self.statistics_data),
                'connection_history_count': len(self.connection_history),
                'error_history_count': len(self.error_history),
                'health_labels_count': len(self.health_labels),
                'health_progress_count': len(self.health_progress)
            }
            
        except Exception as e:
            logger.error(f"âŒ åˆ†æãƒ‘ãƒãƒ«çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return {'error': str(e)}


# === ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼é–¢æ•° ===

def create_analysis_panel(settings, callbacks=None):
    """
    AnalysisPanelä½œæˆé–¢æ•°
    
    Args:
        settings: è¨­å®šè¾æ›¸
        callbacks: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¾æ›¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        
    Returns:
        AnalysisPanel: åˆ†æãƒ‘ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    """
    try:
        panel = AnalysisPanel(settings, callbacks)
        logger.info("âœ… AnalysisPanelä½œæˆå®Œäº†")
        return panel
        
    except Exception as e:
        logger.error(f"âŒ AnalysisPanelä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
        raise


# === ãƒ†ã‚¹ãƒˆé–¢æ•° ===

def test_analysis_panel():
    """AnalysisPanelãƒ†ã‚¹ãƒˆé–¢æ•°"""
    print("ğŸ§ª AnalysisPanelãƒ†ã‚¹ãƒˆé–‹å§‹")
    
    try:
        # ãƒ†ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä½œæˆ
        root = tk.Tk()
        root.title("AnalysisPanel ãƒ†ã‚¹ãƒˆ")
        root.geometry("1200x700")
        
        # ãƒ†ã‚¹ãƒˆç”¨è¨­å®š
        test_settings = {
            'auto_update': True,
            'update_interval': 3000
        }
        
        # ãƒ‘ãƒãƒ«ä½œæˆ
        panel = create_analysis_panel(test_settings)
        panel.create_in_parent(root)
        
        # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¿½åŠ 
        import random
        import time
        
        def add_test_data():
            try:
                # ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                panel.update_health_data({
                    'memory_usage_mb': random.uniform(50, 120),
                    'performance_score': random.uniform(85, 100),
                    'error_count': random.randint(0, 5),
                    'recovery_count': random.randint(0, 2)
                })
                
                # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°
                panel.update_statistics_data({
                    'onecomme_comments': random.randint(100, 500),
                    'messagebus_sent': random.randint(50, 200),
                    'errors': random.randint(0, 10),
                    'sync_success': random.randint(80, 150),
                    'ui_updates': random.randint(200, 400)
                })
                
                # æ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
                if random.random() < 0.3:  # 30%ã®ç¢ºç‡
                    event_types = ['connected', 'disconnected', 'error', 'recovery']
                    services = ['onecomme', 'messagebus', 'bouyomi', 'voicevox', 'obs']
                    
                    panel.add_connection_event({
                        'event_type': random.choice(event_types),
                        'service': random.choice(services),
                        'state': random.choice(['success', 'warning', 'error']),
                        'details': f'ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ #{random.randint(1000, 9999)}',
                        'success': random.choice([True, True, True, False])  # 75%æˆåŠŸ
                    })
                
                # 3ç§’å¾Œã«å†å®Ÿè¡Œ
                root.after(3000, add_test_data)
                
            except:
                pass
        
        # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¿½åŠ é–‹å§‹
        add_test_data()
        
        # çŠ¶æ…‹ç¢ºèª
        status = panel.get_status()
        print(f"ğŸ“Š ãƒ‘ãƒãƒ«çŠ¶æ…‹: {status}")
        
        # çµ‚äº†å‡¦ç†
        def on_closing():
            try:
                panel.cleanup()
                root.destroy()
            except Exception as e:
                print(f"âŒ çµ‚äº†å‡¦ç†ã‚¨ãƒ©ãƒ¼: {e}")
                root.destroy()
        
        root.protocol("WM_DELETE_WINDOW", on_closing)
        
        print("ğŸš€ åˆ†æãƒ‘ãƒãƒ«ãƒ†ã‚¹ãƒˆé–‹å§‹ - ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¦çµ‚äº†")
        root.mainloop()
        
        print("âœ… AnalysisPanelãƒ†ã‚¹ãƒˆå®Œäº†")
        return True
        
    except Exception as e:
        print(f"âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()
        return False


if __name__ == "__main__":
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    test_analysis_panel()