#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ® WebSocketã‚¿ãƒ– æ¥ç¶šåˆ¶å¾¡ãƒ‘ãƒãƒ« v17.0.0 Phase5
SlideSwitchçµ±åˆãƒ»5ã‚µãƒ¼ãƒ“ã‚¹åˆ¶å¾¡UI

æ©Ÿèƒ½:
- SlideSwitch UIçµ±åˆ
- 5ã‚µãƒ¼ãƒ“ã‚¹åˆ¶å¾¡ï¼ˆonecomme, messagebus, bouyomi, voicevox, obsï¼‰
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºãƒ»æ›´æ–°
- çµ±è¨ˆæƒ…å ±è¡¨ç¤º
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½
"""

import tkinter as tk
from tkinter import ttk
from datetime import datetime
import logging
from typing import Dict, Any, Callable, Optional

# SlideSwitchèª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
try:
    from .slide_switch import create_slide_switch, update_slide_switch_appearance, animate_slide_switch
    SLIDE_SWITCH_AVAILABLE = True
except ImportError:
    SLIDE_SWITCH_AVAILABLE = False

logger = logging.getLogger(__name__)


class ConnectionControlPanel:
    """
    æ¥ç¶šåˆ¶å¾¡ãƒ‘ãƒãƒ«å°‚ç”¨ã‚¯ãƒ©ã‚¹
    
    SlideSwitchçµ±åˆãƒ»5ã‚µãƒ¼ãƒ“ã‚¹åˆ¶å¾¡ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ‹…å½“
    """
    
    def __init__(self, services, settings, callbacks=None):
        """
        åˆæœŸåŒ–
        
        Args:
            services: ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹è¾æ›¸
            settings: è¨­å®šè¾æ›¸
            callbacks: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¾æ›¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        """
        self.services = services
        self.settings = settings
        self.callbacks = callbacks or {}
        
        # UIè¦ç´ ç®¡ç†
        self.parent_frame = None
        self.main_panel = None
        self.services_frame = None
        self.stats_frame = None
        
        # SlideSwitchç®¡ç†
        self.slide_switches = {}
        self.toggle_switches = {}
        self.status_labels = {}
        self.detail_labels = {}
        
        # çµ±è¨ˆè¡¨ç¤º
        self.stats_label = None
        self.phase_info_label = None
        
        # ã‚µãƒ¼ãƒ“ã‚¹è¨­å®š
        self.service_configs = [
            {'key': 'onecomme', 'icon': 'ğŸ“¡', 'name': 'ã‚ã‚“ã‚³ãƒ¡ã€€ã€€ã€€', 'description': 'ã‚³ãƒ¡ãƒ³ãƒˆå—ä¿¡'},
            {'key': 'messagebus', 'icon': 'ğŸšŒ', 'name': 'MessageBusã€€', 'description': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸­ç¶™'},
            {'key': 'bouyomi', 'icon': 'ğŸµ', 'name': 'æ£’èª­ã¿ã¡ã‚ƒã‚“ã€€', 'description': 'éŸ³å£°èª­ã¿ä¸Šã’'},
            {'key': 'voicevox', 'icon': 'ğŸ¤', 'name': 'VOICEVOXã€€ã€€', 'description': 'AIéŸ³å£°åˆæˆ'},
            {'key': 'obs', 'icon': 'ğŸ“º', 'name': 'OBSã€€ã€€ã€€ã€€ã€€', 'description': 'é…ä¿¡ã‚½ãƒ•ãƒˆé€£æº'}
        ]
        
        logger.info("ğŸ® ConnectionControlPanelåˆæœŸåŒ–å®Œäº†")
    
    def create_in_parent(self, parent):
        """è¦ªãƒ•ãƒ¬ãƒ¼ãƒ å†…ã«ãƒ‘ãƒãƒ«ä½œæˆ"""
        try:
            self.parent_frame = parent
            
            # ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«ä½œæˆ
            self._create_main_panel()
            
            # ã‚µãƒ¼ãƒ“ã‚¹åˆ¶å¾¡ã‚¨ãƒªã‚¢ä½œæˆ
            self._create_services_area()
            
            # çµ±è¨ˆæƒ…å ±ã‚¨ãƒªã‚¢ä½œæˆ
            self._create_statistics_area()
            
            # Phaseæƒ…å ±ã‚¨ãƒªã‚¢ä½œæˆ
            self._create_phase_info_area()
            
            logger.info("âœ… æ¥ç¶šåˆ¶å¾¡ãƒ‘ãƒãƒ«ä½œæˆå®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ æ¥ç¶šåˆ¶å¾¡ãƒ‘ãƒãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
            raise
    
    def _create_main_panel(self):
        """ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«ä½œæˆ"""
        try:
            self.main_panel = ttk.LabelFrame(
                self.parent_frame, 
                text="ğŸŒ ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šçŠ¶æ…‹ (Phase5 - ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼è¨­è¨ˆãƒ»SlideSwitchçµ±åˆ)"
            )
            self.main_panel.pack(fill=tk.X, pady=(0, 20))
            
        except Exception as e:
            logger.error(f"âŒ ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
            raise
    
    def _create_services_area(self):
        """ã‚µãƒ¼ãƒ“ã‚¹åˆ¶å¾¡ã‚¨ãƒªã‚¢ä½œæˆ"""
        try:
            self.services_frame = ttk.Frame(self.main_panel)
            self.services_frame.pack(fill=tk.X, padx=20, pady=20)
            
            # å„ã‚µãƒ¼ãƒ“ã‚¹åˆ¶å¾¡è¡Œã‚’ä½œæˆ
            for i, config in enumerate(self.service_configs):
                self._create_service_control_row(config, i)
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹åˆ¶å¾¡ã‚¨ãƒªã‚¢ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _create_service_control_row(self, config, row_index):
        """ã‚µãƒ¼ãƒ“ã‚¹åˆ¶å¾¡è¡Œä½œæˆï¼ˆSlideSwitchçµ±åˆï¼‰"""
        try:
            service_key = config['key']
            
            # è¡Œãƒ•ãƒ¬ãƒ¼ãƒ 
            row_frame = ttk.Frame(self.services_frame)
            row_frame.pack(fill=tk.X, pady=5)
            
            # ã‚¢ã‚¤ã‚³ãƒ³
            icon_label = ttk.Label(
                row_frame, 
                text=config['icon'], 
                font=("Yu Gothic UI", 16)
            )
            icon_label.pack(side=tk.LEFT, padx=(0, 10))
            
            # ã‚µãƒ¼ãƒ“ã‚¹å
            name_label = ttk.Label(
                row_frame, 
                text=config['name'], 
                font=("Yu Gothic UI", 12, "bold")
            )
            name_label.pack(side=tk.LEFT, padx=(0, 20))
            
            # SlideSwitch ã¾ãŸã¯ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            self._create_service_toggle(row_frame, service_key)
            
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«
            status_label = ttk.Label(
                row_frame, 
                text="âšªç„¡åŠ¹", 
                font=("Yu Gothic UI", 10)
            )
            status_label.pack(side=tk.LEFT, padx=(0, 15))
            self.status_labels[service_key] = status_label
            
            # è©³ç´°ãƒ©ãƒ™ãƒ«
            detail_label = ttk.Label(
                row_frame, 
                text=config['description'], 
                font=("Yu Gothic UI", 9), 
                foreground="gray"
            )
            detail_label.pack(side=tk.LEFT, padx=(0, 10))
            self.detail_labels[service_key] = detail_label
            
            # åˆ¶å¾¡ãƒœã‚¿ãƒ³ï¼ˆè¿½åŠ æ©Ÿèƒ½ï¼‰
            self._create_service_controls(row_frame, service_key)
            
            logger.debug(f"âœ… {service_key} åˆ¶å¾¡è¡Œä½œæˆå®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ {service_key} åˆ¶å¾¡è¡Œä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _create_service_toggle(self, parent, service_key):
        """ã‚µãƒ¼ãƒ“ã‚¹ãƒˆã‚°ãƒ«ä½œæˆï¼ˆSlideSwitchå„ªå…ˆï¼‰"""
        try:
            if SLIDE_SWITCH_AVAILABLE:
                # SlideSwitchä½¿ç”¨
                self._create_slide_switch_toggle(parent, service_key)
            else:
                # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šé€šå¸¸ã®Checkbutton
                self._create_fallback_toggle(parent, service_key)
                
        except Exception as e:
            logger.error(f"âŒ {service_key} ãƒˆã‚°ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
            self._create_fallback_toggle(parent, service_key)
    
    def _create_slide_switch_toggle(self, parent, service_key):
        """SlideSwitchä½œæˆ"""
        try:
            # ãƒˆã‚°ãƒ«å¤‰æ•°ä½œæˆ
            toggle_var = tk.BooleanVar()
            initial_state = self.settings.get(f'auto_start_{service_key}', True)
            toggle_var.set(initial_state)
            
            # SlideSwitchä½œæˆ
            slide_switch = create_slide_switch(
                parent,
                service_key,
                toggle_var,
                self._on_slide_switch_changed
            )
            slide_switch.pack(side=tk.LEFT, padx=(0, 20))
            
            # åˆæœŸå¤–è¦³è¨­å®š
            update_slide_switch_appearance(slide_switch, initial_state)
            
            # ä¿å­˜
            self.slide_switches[service_key] = slide_switch
            self.toggle_switches[service_key] = toggle_var
            
            # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹åˆæœŸåŒ–
            if service_key in self.services:
                self.services[service_key].enabled = initial_state
            
            logger.debug(f"âœ… {service_key} SlideSwitchä½œæˆå®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ {service_key} SlideSwitchä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
            raise
    
    def _create_fallback_toggle(self, parent, service_key):
        """ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒˆã‚°ãƒ«ä½œæˆ"""
        try:
            # ãƒˆã‚°ãƒ«å¤‰æ•°ä½œæˆ
            toggle_var = tk.BooleanVar()
            initial_state = self.settings.get(f'auto_start_{service_key}', True)
            toggle_var.set(initial_state)
            
            # Checkbuttonä½œæˆ
            toggle_button = ttk.Checkbutton(
                parent,
                text="æœ‰åŠ¹",
                variable=toggle_var,
                command=lambda: self._on_toggle_changed(service_key, toggle_var.get())
            )
            toggle_button.pack(side=tk.LEFT, padx=(0, 20))
            
            # ä¿å­˜
            self.toggle_switches[service_key] = toggle_var
            
            # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹åˆæœŸåŒ–
            if service_key in self.services:
                self.services[service_key].enabled = initial_state
            
            logger.debug(f"âœ… {service_key} ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒˆã‚°ãƒ«ä½œæˆå®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ {service_key} ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒˆã‚°ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _create_service_controls(self, parent, service_key):
        """ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ åˆ¶å¾¡ä½œæˆ"""
        try:
            # å†æ¥ç¶šãƒœã‚¿ãƒ³
            reconnect_btn = ttk.Button(
                parent,
                text="ğŸ”„",
                width=3,
                command=lambda: self._on_service_action(service_key, 'reconnect')
            )
            reconnect_btn.pack(side=tk.RIGHT, padx=(5, 0))
            
            # è¨­å®šãƒœã‚¿ãƒ³
            config_btn = ttk.Button(
                parent,
                text="âš™ï¸",
                width=3,
                command=lambda: self._on_service_action(service_key, 'config')
            )
            config_btn.pack(side=tk.RIGHT, padx=(5, 0))
            
        except Exception as e:
            logger.error(f"âŒ {service_key} è¿½åŠ åˆ¶å¾¡ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _create_statistics_area(self):
        """çµ±è¨ˆæƒ…å ±ã‚¨ãƒªã‚¢ä½œæˆ"""
        try:
            self.stats_frame = ttk.Frame(self.main_panel)
            self.stats_frame.pack(fill=tk.X, padx=20, pady=(10, 20))
            
            # çµ±è¨ˆãƒ©ãƒ™ãƒ«
            self.stats_label = ttk.Label(
                self.stats_frame,
                text="ğŸ“Š çµ±è¨ˆ: èª­ã¿è¾¼ã¿ä¸­...",
                font=("Yu Gothic UI", 11)
            )
            self.stats_label.pack(anchor="w")
            
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆæƒ…å ±ã‚¨ãƒªã‚¢ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _create_phase_info_area(self):
        """Phaseæƒ…å ±ã‚¨ãƒªã‚¢ä½œæˆ"""
        try:
            phase_frame = ttk.Frame(self.main_panel)
            phase_frame.pack(fill=tk.X, padx=20, pady=(5, 15))
            
            # Phase5æƒ…å ±è¡¨ç¤º
            phase_text = self._generate_phase_info()
            
            self.phase_info_label = ttk.Label(
                phase_frame,
                text=phase_text,
                font=("Yu Gothic UI", 9),
                foreground="blue"
            )
            self.phase_info_label.pack(anchor="w")
            
        except Exception as e:
            logger.error(f"âŒ Phaseæƒ…å ±ã‚¨ãƒªã‚¢ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _generate_phase_info(self):
        """Phaseæƒ…å ±ç”Ÿæˆ"""
        try:
            modules_status = []
            
            # SlideSwitchçŠ¶æ³
            modules_status.append(f"SlideSwitch {'âœ…' if SLIDE_SWITCH_AVAILABLE else 'âŒ'}")
            
            # å¤–éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çŠ¶æ³ãƒã‚§ãƒƒã‚¯
            module_checks = [
                ('WebSocketManager', 'handler'),
                ('MessageBridge', 'message_bridge'),
                ('ConnectionState', 'connection_state'),
                ('Eventså¤–éƒ¨åŒ–', 'shared.event_types'),
                ('Mockåˆ†é›¢', 'test_mocks')
            ]
            
            for name, module_name in module_checks:
                try:
                    __import__(module_name)
                    modules_status.append(f"{name} âœ…")
                except ImportError:
                    modules_status.append(f"{name} âŒ")
            
            return f"ğŸ”§ Phase5 ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼è¨­è¨ˆ: {' | '.join(modules_status)}"
            
        except Exception as e:
            logger.error(f"âŒ Phaseæƒ…å ±ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            return "ğŸ”§ Phase5 ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼è¨­è¨ˆ: æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼"
    
    # === ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ ===
    
    def _on_slide_switch_changed(self, service_key, enabled):
        """SlideSwitchå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ"""
        try:
            logger.info(f"ğŸ”„ SlideSwitchå¤‰æ›´: {service_key} = {enabled}")
            
            # å¤–è¦³æ›´æ–°
            if service_key in self.slide_switches:
                update_slide_switch_appearance(self.slide_switches[service_key], enabled)
            
            # å…±é€šãƒˆã‚°ãƒ«å‡¦ç†
            self._on_toggle_changed(service_key, enabled)
            
        except Exception as e:
            logger.error(f"âŒ SlideSwitchå¤‰æ›´ã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
    
    def _on_toggle_changed(self, service_key, enabled):
        """ãƒˆã‚°ãƒ«å¤‰æ›´å…±é€šå‡¦ç†"""
        try:
            # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹æ›´æ–°
            if service_key in self.services:
                self.services[service_key].enabled = enabled
            
            # è¨­å®šæ›´æ–°
            self.settings[f'auto_start_{service_key}'] = enabled
            
            # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
            callback = self.callbacks.get('service_toggle')
            if callback:
                callback(service_key, enabled)
            else:
                logger.warning(f"âš ï¸ service_toggle ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æœªè¨­å®š ({service_key})")
            
            logger.info(f"ğŸ”„ ã‚µãƒ¼ãƒ“ã‚¹ãƒˆã‚°ãƒ«: {service_key} = {enabled}")
            
        except Exception as e:
            logger.error(f"âŒ ãƒˆã‚°ãƒ«å¤‰æ›´ã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
    
    def _on_service_action(self, service_key, action):
        """ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ"""
        try:
            logger.info(f"ğŸ® ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: {service_key} - {action}")
            
            # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
            callback = self.callbacks.get('service_action')
            if callback:
                callback(service_key, action)
            else:
                logger.warning(f"âš ï¸ service_action ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æœªè¨­å®š ({service_key}, {action})")
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ ({service_key}, {action}): {e}")
    
    # === æ›´æ–°ãƒ¡ã‚½ãƒƒãƒ‰ ===
    
    def update_all_services(self):
        """å…¨ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹æ›´æ–°"""
        try:
            for service_key in self.services:
                self.update_service_status(service_key)
                
        except Exception as e:
            logger.error(f"âŒ å…¨ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    def update_service_status(self, service_key):
        """å€‹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹æ›´æ–°"""
        try:
            if service_key not in self.services:
                return
            
            service = self.services[service_key]
            
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆãƒ»è‰²æ±ºå®š
            if hasattr(service, 'auto_recovery_in_progress') and service.auto_recovery_in_progress:
                status_text = "ğŸ”„ç¢ºèªä¸­"
                status_color = "orange"
            elif service.connected and service.enabled:
                status_text = "âœ…æ¥ç¶šä¸­"
                status_color = "green"
            elif service.enabled and not service.connected:
                status_text = "âŒæœªæ¥ç¶š"
                status_color = "red"
            else:
                status_text = "âšªç„¡åŠ¹"
                status_color = "gray"
            
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«æ›´æ–°
            if service_key in self.status_labels:
                current_text = self.status_labels[service_key].cget("text")
                if current_text != status_text:
                    self.status_labels[service_key].config(text=status_text, foreground=status_color)
            
            # è©³ç´°ãƒ©ãƒ™ãƒ«æ›´æ–°
            if service_key in self.detail_labels and hasattr(service, 'details'):
                current_details = self.detail_labels[service_key].cget("text")
                if current_details != service.details:
                    self.detail_labels[service_key].config(text=service.details)
            
            # SlideSwitchå¤–è¦³æ›´æ–°
            if SLIDE_SWITCH_AVAILABLE and service_key in self.slide_switches:
                try:
                    update_slide_switch_appearance(self.slide_switches[service_key], service.enabled)
                except Exception as e:
                    logger.error(f"âŒ SlideSwitchå¤–è¦³æ›´æ–°ã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
    
    def update_statistics(self, stats):
        """çµ±è¨ˆè¡¨ç¤ºæ›´æ–°"""
        try:
            if not self.stats_label:
                return
            
            # çµ±è¨ˆãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
            stats_text = self._generate_stats_text(stats)
            
            # ãƒ©ãƒ™ãƒ«æ›´æ–°
            current_text = self.stats_label.cget("text")
            if current_text != stats_text:
                self.stats_label.config(text=stats_text)
                
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆè¡¨ç¤ºæ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _generate_stats_text(self, stats):
        """çµ±è¨ˆãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ"""
        try:
            return (f"ğŸ“Š çµ±è¨ˆ: onecomme {stats.get('onecomme_comments', 0)}ä»¶ | "
                   f"MessageBus {stats.get('messagebus_sent', 0)}ä»¶é€ä¿¡ | "
                   f"ã‚¨ãƒ©ãƒ¼ {stats.get('errors', 0)}ä»¶ | "
                   f"è‡ªå‹•å¾©æ—§ {stats.get('auto_recovery_count', 0)}å› | "
                   f"åŒæœŸæˆåŠŸ {stats.get('sync_success_count', 0)}ä»¶ | "
                   f"UIæ›´æ–° {stats.get('ui_updates', 0)}å› | "
                   f"SlideSwitch {'âœ…' if SLIDE_SWITCH_AVAILABLE else 'âŒ'}")
                   
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            return "ğŸ“Š çµ±è¨ˆ: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
    
    def update_phase_info(self):
        """Phaseæƒ…å ±æ›´æ–°"""
        try:
            if not self.phase_info_label:
                return
                
            phase_text = self._generate_phase_info()
            current_text = self.phase_info_label.cget("text")
            if current_text != phase_text:
                self.phase_info_label.config(text=phase_text)
                
        except Exception as e:
            logger.error(f"âŒ Phaseæƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    # === åˆ¶å¾¡ãƒ¡ã‚½ãƒƒãƒ‰ ===
    
    def set_service_enabled(self, service_key, enabled):
        """ã‚µãƒ¼ãƒ“ã‚¹æœ‰åŠ¹çŠ¶æ…‹è¨­å®š"""
        try:
            if service_key in self.toggle_switches:
                self.toggle_switches[service_key].set(enabled)
                
            if service_key in self.services:
                self.services[service_key].enabled = enabled
                
            # UIæ›´æ–°
            self.update_service_status(service_key)
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹æœ‰åŠ¹çŠ¶æ…‹è¨­å®šã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
    
    def get_service_enabled(self, service_key):
        """ã‚µãƒ¼ãƒ“ã‚¹æœ‰åŠ¹çŠ¶æ…‹å–å¾—"""
        try:
            if service_key in self.toggle_switches:
                return self.toggle_switches[service_key].get()
            return False
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹æœ‰åŠ¹çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
            return False
    
    def animate_service_toggle(self, service_key, to_enabled):
        """ã‚µãƒ¼ãƒ“ã‚¹ãƒˆã‚°ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³"""
        try:
            if SLIDE_SWITCH_AVAILABLE and service_key in self.slide_switches:
                animate_slide_switch(self.slide_switches[service_key], to_enabled)
            else:
                # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå³åº§ã«çŠ¶æ…‹å¤‰æ›´
                self.set_service_enabled(service_key, to_enabled)
                
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹ãƒˆã‚°ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
    
    # === ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç®¡ç† ===
    
    def set_callback(self, event_name, callback):
        """ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š"""
        self.callbacks[event_name] = callback
        logger.debug(f"ğŸ“‹ ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š: {event_name}")
    
    def get_callback(self, event_name):
        """ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å–å¾—"""
        return self.callbacks.get(event_name)
    
    def clear_callbacks(self):
        """ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¯ãƒªã‚¢"""
        self.callbacks.clear()
        logger.debug("ğŸ“‹ ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¯ãƒªã‚¢å®Œäº†")
    
    # === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
    
    def get_all_service_states(self):
        """å…¨ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹å–å¾—"""
        try:
            states = {}
            for service_key in self.services:
                states[service_key] = {
                    'enabled': self.get_service_enabled(service_key),
                    'connected': getattr(self.services[service_key], 'connected', False),
                    'details': getattr(self.services[service_key], 'details', ''),
                    'auto_recovery': getattr(self.services[service_key], 'auto_recovery_in_progress', False)
                }
            return states
            
        except Exception as e:
            logger.error(f"âŒ å…¨ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return {}
    
    def refresh_all_displays(self):
        """å…¨è¡¨ç¤ºè¦ç´ ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥"""
        try:
            # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹æ›´æ–°
            self.update_all_services()
            
            # Phaseæƒ…å ±æ›´æ–°
            self.update_phase_info()
            
            logger.debug("ğŸ”„ è¡¨ç¤ºãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ è¡¨ç¤ºãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼: {e}")
    
    # === ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ===
    
    def cleanup(self):
        """ãƒ‘ãƒãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"""
        try:
            logger.info("ğŸ§¹ ConnectionControlPanel ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹")
            
            # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¯ãƒªã‚¢
            self.clear_callbacks()
            
            # UIè¦ç´ ã‚¯ãƒªã‚¢
            self.slide_switches.clear()
            self.toggle_switches.clear()
            self.status_labels.clear()
            self.detail_labels.clear()
            
            logger.info("âœ… ConnectionControlPanel ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ ãƒ‘ãƒãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: {e}")
    
    def get_status(self):
        """ãƒ‘ãƒãƒ«çŠ¶æ…‹å–å¾—"""
        try:
            return {
                'panel_created': self.main_panel is not None,
                'slide_switches_count': len(self.slide_switches),
                'toggle_switches_count': len(self.toggle_switches),
                'slide_switch_available': SLIDE_SWITCH_AVAILABLE,
                'services_count': len(self.services),
                'callbacks_count': len(self.callbacks),
                'service_states': self.get_all_service_states()
            }
            
        except Exception as e:
            logger.error(f"âŒ ãƒ‘ãƒãƒ«çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return {'error': str(e)}


# === ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼é–¢æ•° ===

def create_connection_control_panel(services, settings, callbacks=None):
    """
    ConnectionControlPanelä½œæˆé–¢æ•°
    
    Args:
        services: ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹è¾æ›¸
        settings: è¨­å®šè¾æ›¸
        callbacks: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¾æ›¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        
    Returns:
        ConnectionControlPanel: æ¥ç¶šåˆ¶å¾¡ãƒ‘ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    """
    try:
        panel = ConnectionControlPanel(services, settings, callbacks)
        logger.info("âœ… ConnectionControlPanelä½œæˆå®Œäº†")
        return panel
        
    except Exception as e:
        logger.error(f"âŒ ConnectionControlPanelä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
        raise


# === ãƒ†ã‚¹ãƒˆé–¢æ•° ===

def test_connection_control_panel():
    """ConnectionControlPanelãƒ†ã‚¹ãƒˆé–¢æ•°"""
    print("ğŸ§ª ConnectionControlPanelãƒ†ã‚¹ãƒˆé–‹å§‹")
    
    try:
        # ãƒ†ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä½œæˆ
        root = tk.Tk()
        root.title("ConnectionControlPanel ãƒ†ã‚¹ãƒˆ")
        root.geometry("900x500")
        
        # ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆ
        test_services = {}
        for config in [
            {'key': 'onecomme'}, {'key': 'messagebus'}, 
            {'key': 'bouyomi'}, {'key': 'voicevox'}, {'key': 'obs'}
        ]:
            service_key = config['key']
            test_services[service_key] = type('Service', (), {
                'enabled': True,
                'connected': service_key == 'messagebus',  # messagebusã®ã¿æ¥ç¶šæ¸ˆã¿
                'details': f'{service_key} ãƒ†ã‚¹ãƒˆçŠ¶æ…‹',
                'auto_recovery_in_progress': False
            })()
        
        test_settings = {
            'auto_start_onecomme': True,
            'auto_start_messagebus': True,
            'auto_start_bouyomi': False,
            'auto_start_voicevox': False,
            'auto_start_obs': True
        }
        
        # ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        def test_toggle_callback(service_key, enabled):
            print(f"ğŸ”„ ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ - {service_key}: {enabled}")
        
        def test_action_callback(service_key, action):
            print(f"ğŸ® ãƒ†ã‚¹ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ - {service_key}: {action}")
        
        test_callbacks = {
            'service_toggle': test_toggle_callback,
            'service_action': test_action_callback
        }
        
        # ãƒ‘ãƒãƒ«ä½œæˆ
        panel = create_connection_control_panel(test_services, test_settings, test_callbacks)
        panel.create_in_parent(root)
        
        # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆ
        test_stats = {
            'onecomme_comments': 125,
            'messagebus_sent': 67,
            'errors': 2,
            'auto_recovery_count': 1,
            'sync_success_count': 45,
            'ui_updates': 123
        }
        panel.update_statistics(test_stats)
        
        # å®šæœŸæ›´æ–°ãƒ†ã‚¹ãƒˆ
        def periodic_update():
            try:
                panel.update_all_services()
                root.after(2000, periodic_update)  # 2ç§’ã”ã¨
            except:
                pass
        
        periodic_update()
        
        # çŠ¶æ…‹ç¢ºèª
        status = panel.get_status()
        print(f"ğŸ“Š ãƒ‘ãƒãƒ«çŠ¶æ…‹: {status}")
        
        # çµ‚äº†å‡¦ç†
        def on_closing():
            try:
                panel.cleanup()
                root.destroy()
            except Exception as e:
                print(f"âŒ çµ‚äº†å‡¦ç†ã‚¨ãƒ©ãƒ¼: {e}")
                root.destroy()
        
        root.protocol("WM_DELETE_WINDOW", on_closing)
        
        print("ğŸš€ ãƒ‘ãƒãƒ«ãƒ†ã‚¹ãƒˆé–‹å§‹ - ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¦çµ‚äº†")
        root.mainloop()
        
        print("âœ… ConnectionControlPanelãƒ†ã‚¹ãƒˆå®Œäº†")
        return True
        
    except Exception as e:
        print(f"âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()
        return False


if __name__ == "__main__":
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    test_connection_control_panel()
            
