#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ“‹ WebSocketã‚¿ãƒ– ãƒ­ã‚°ãƒ‘ãƒãƒ« v17.0.0 Phase5 - ä¿®æ­£ç‰ˆ
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°è¡¨ç¤ºãƒ»ç®¡ç†

ä¿®æ­£å†…å®¹:
- ScrolledTextã®ä¸æ­£ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³å‰Šé™¤
- ãƒ­ã‚°ã‚¿ã‚°è¨­å®šã®ä¿®æ­£
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
"""

import tkinter as tk
from tkinter import ttk, scrolledtext, filedialog, messagebox
from datetime import datetime
import logging
import threading
from typing import Dict, Any, List, Optional

logger = logging.getLogger(__name__)


class LogPanel:
    """
    ãƒ­ã‚°ãƒ‘ãƒãƒ«å°‚ç”¨ã‚¯ãƒ©ã‚¹ - ä¿®æ­£ç‰ˆ
    
    ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°è¡¨ç¤ºãƒ»æ¤œç´¢ãƒ»ç®¡ç†ã‚’æ‹…å½“
    """
    
    def __init__(self, settings, callbacks=None):
        """
        åˆæœŸåŒ–
        
        Args:
            settings: è¨­å®šè¾æ›¸
            callbacks: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¾æ›¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        """
        self.settings = settings
        self.callbacks = callbacks or {}
        
        # UIè¦ç´ ç®¡ç†
        self.parent_frame = None
        self.main_panel = None
        self.log_text = None
        self.search_frame = None
        self.control_frame = None
        
        # ãƒ­ã‚°ç®¡ç†
        self.log_buffer = []
        self.max_log_lines = self.settings.get('max_log_lines', 1000)
        self.auto_scroll = True
        self.log_filters = set()
        
        # æ¤œç´¢æ©Ÿèƒ½
        self.search_var = None
        self.search_entry = None
        self.filter_vars = {}
        
        # ãƒ­ã‚°ã‚¿ã‚°è¨­å®šï¼ˆä¿®æ­£ç‰ˆ - descriptionã¯åˆ¥ç®¡ç†ï¼‰
        self.log_tags = {
            'success': {'foreground': '#4CAF50'},
            'error': {'foreground': '#F44336'},
            'warning': {'foreground': '#FF9800'},
            'info': {'foreground': '#2196F3'},
            'debug': {'foreground': '#9E9E9E'},
            'phase4': {'foreground': '#9C27B0'},
            'phase5': {'foreground': '#673AB7'},
            'events_external': {'foreground': '#00BCD4'},
            'mock_separated': {'foreground': '#8BC34A'},
            'ui_component': {'foreground': '#FF5722'},
            'service_control': {'foreground': '#795548'}
        }
        
        # ã‚¿ã‚°èª¬æ˜ï¼ˆåˆ¥ç®¡ç†ï¼‰
        self.tag_descriptions = {
            'success': 'æˆåŠŸ',
            'error': 'ã‚¨ãƒ©ãƒ¼',
            'warning': 'è­¦å‘Š',
            'info': 'æƒ…å ±',
            'debug': 'ãƒ‡ãƒãƒƒã‚°',
            'phase4': 'Phase4',
            'phase5': 'Phase5',
            'events_external': 'Eventså¤–éƒ¨åŒ–',
            'mock_separated': 'Mockåˆ†é›¢',
            'ui_component': 'UIåˆ†é›¢',
            'service_control': 'ã‚µãƒ¼ãƒ“ã‚¹åˆ¶å¾¡'
        }
        
        logger.info("ğŸ“‹ LogPanelåˆæœŸåŒ–å®Œäº†")
    
    def create_in_parent(self, parent):
        """è¦ªãƒ•ãƒ¬ãƒ¼ãƒ å†…ã«ãƒ‘ãƒãƒ«ä½œæˆ"""
        try:
            self.parent_frame = parent
            
            # ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«ä½œæˆ
            self._create_main_panel()
            
            # åˆ¶å¾¡ã‚¨ãƒªã‚¢ä½œæˆ
            self._create_control_area()
            
            # æ¤œç´¢ã‚¨ãƒªã‚¢ä½œæˆ
            self._create_search_area()
            
            # ãƒ­ã‚°ã‚¨ãƒªã‚¢ä½œæˆï¼ˆä¿®æ­£ç‰ˆï¼‰
            self._create_log_area_fixed()
            
            # åˆæœŸãƒ­ã‚°è¿½åŠ 
            self._add_initial_logs()
            
            logger.info("âœ… ãƒ­ã‚°ãƒ‘ãƒãƒ«ä½œæˆå®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ ãƒ­ã‚°ãƒ‘ãƒãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
            raise
    
    def _create_main_panel(self):
        """ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«ä½œæˆ"""
        try:
            self.main_panel = ttk.LabelFrame(
                self.parent_frame,
                text="ğŸ“‹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚° (Phase5 - UIåˆ†é›¢ç‰ˆ)"
            )
            self.main_panel.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
            
        except Exception as e:
            logger.error(f"âŒ ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
            raise
    
    def _create_control_area(self):
        """åˆ¶å¾¡ã‚¨ãƒªã‚¢ä½œæˆ"""
        try:
            self.control_frame = ttk.Frame(self.main_panel)
            self.control_frame.pack(fill=tk.X, padx=10, pady=(10, 5))
            
            # å·¦å´ï¼šåˆ¶å¾¡ãƒœã‚¿ãƒ³
            left_frame = ttk.Frame(self.control_frame)
            left_frame.pack(side=tk.LEFT)
            
            # ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
            clear_btn = ttk.Button(
                left_frame,
                text="ğŸ—‘ï¸ ã‚¯ãƒªã‚¢",
                command=self.clear_logs
            )
            clear_btn.pack(side=tk.LEFT, padx=(0, 5))
            
            # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
            export_btn = ttk.Button(
                left_frame,
                text="ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
                command=self.export_logs
            )
            export_btn.pack(side=tk.LEFT, padx=(0, 5))
            
            # è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
            self.auto_scroll_var = tk.BooleanVar(value=True)
            auto_scroll_check = ttk.Checkbutton(
                left_frame,
                text="è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«",
                variable=self.auto_scroll_var,
                command=self._on_auto_scroll_changed
            )
            auto_scroll_check.pack(side=tk.LEFT, padx=(10, 0))
            
            # å³å´ï¼šãƒ­ã‚°çµ±è¨ˆ
            right_frame = ttk.Frame(self.control_frame)
            right_frame.pack(side=tk.RIGHT)
            
            self.stats_label = ttk.Label(
                right_frame,
                text="ãƒ­ã‚°: 0è¡Œ",
                font=("Yu Gothic UI", 9)
            )
            self.stats_label.pack(side=tk.RIGHT)
            
        except Exception as e:
            logger.error(f"âŒ åˆ¶å¾¡ã‚¨ãƒªã‚¢ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _create_search_area(self):
        """æ¤œç´¢ã‚¨ãƒªã‚¢ä½œæˆ"""
        try:
            self.search_frame = ttk.Frame(self.main_panel)
            self.search_frame.pack(fill=tk.X, padx=10, pady=(0, 5))
            
            # æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹
            search_label = ttk.Label(self.search_frame, text="ğŸ” æ¤œç´¢:")
            search_label.pack(side=tk.LEFT, padx=(0, 5))
            
            self.search_var = tk.StringVar()
            self.search_entry = ttk.Entry(
                self.search_frame,
                textvariable=self.search_var,
                width=30
            )
            self.search_entry.pack(side=tk.LEFT, padx=(0, 10))
            self.search_entry.bind('<KeyRelease>', self._on_search_changed)
            
            # ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            filter_frame = ttk.Frame(self.search_frame)
            filter_frame.pack(side=tk.LEFT, padx=(10, 0))
            
            ttk.Label(filter_frame, text="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:").pack(side=tk.LEFT, padx=(0, 5))
            
            # ä¸»è¦ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            main_filters = ['error', 'warning', 'success', 'info']
            for filter_name in main_filters:
                var = tk.BooleanVar(value=True)
                check = ttk.Checkbutton(
                    filter_frame,
                    text=self.tag_descriptions[filter_name],  # ä¿®æ­£: åˆ¥ç®¡ç†ã®èª¬æ˜ã‚’ä½¿ç”¨
                    variable=var,
                    command=lambda f=filter_name: self._on_filter_changed(f)
                )
                check.pack(side=tk.LEFT, padx=(0, 5))
                self.filter_vars[filter_name] = var
            
        except Exception as e:
            logger.error(f"âŒ æ¤œç´¢ã‚¨ãƒªã‚¢ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _create_log_area_fixed(self):
        """ãƒ­ã‚°ã‚¨ãƒªã‚¢ä½œæˆï¼ˆä¿®æ­£ç‰ˆï¼‰"""
        try:
            # ãƒ­ã‚°ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼ˆä¿®æ­£ç‰ˆ - ä¸æ­£ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³å‰Šé™¤ï¼‰
            self.log_text = scrolledtext.ScrolledText(
                self.main_panel,
                height=20,
                font=("Consolas", 9),
                bg="#1e1e1e",
                fg="#ffffff",
                insertbackground="#ffffff",
                wrap=tk.WORD
            )
            self.log_text.pack(fill=tk.BOTH, expand=True, padx=10, pady=(0, 10))
            
            # ãƒ­ã‚°ã‚¿ã‚°è¨­å®šï¼ˆä¿®æ­£ç‰ˆï¼‰
            for tag_name, tag_config in self.log_tags.items():
                try:
                    self.log_text.tag_config(tag_name, **tag_config)
                except Exception as e:
                    logger.warning(f"âš ï¸ ãƒ­ã‚°ã‚¿ã‚°è¨­å®šè­¦å‘Š ({tag_name}): {e}")
            
            # æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã‚¿ã‚°
            self.log_text.tag_config('search_highlight', background='yellow', foreground='black')
            
            logger.debug("âœ… ãƒ­ã‚°ã‚¨ãƒªã‚¢ä½œæˆå®Œäº†ï¼ˆä¿®æ­£ç‰ˆï¼‰")
            
        except Exception as e:
            logger.error(f"âŒ ãƒ­ã‚°ã‚¨ãƒªã‚¢ä½œæˆã‚¨ãƒ©ãƒ¼ï¼ˆä¿®æ­£ç‰ˆï¼‰: {e}")
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šåŸºæœ¬çš„ãªTextã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
            self._create_fallback_log_area()
    
    def _create_fallback_log_area(self):
        """ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šåŸºæœ¬ãƒ­ã‚°ã‚¨ãƒªã‚¢ä½œæˆ"""
        try:
            logger.warning("âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚°ã‚¨ãƒªã‚¢ä½œæˆ")
            
            # åŸºæœ¬çš„ãªTextã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
            text_frame = ttk.Frame(self.main_panel)
            text_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=(0, 10))
            
            self.log_text = tk.Text(
                text_frame,
                height=20,
                font=("Consolas", 9),
                bg="#1e1e1e",
                fg="#ffffff",
                wrap=tk.WORD
            )
            
            # ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼
            scrollbar = ttk.Scrollbar(text_frame, orient=tk.VERTICAL, command=self.log_text.yview)
            self.log_text.configure(yscrollcommand=scrollbar.set)
            
            self.log_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
            scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
            
            # ãƒ­ã‚°ã‚¿ã‚°è¨­å®š
            for tag_name, tag_config in self.log_tags.items():
                try:
                    self.log_text.tag_config(tag_name, **tag_config)
                except Exception as e:
                    logger.warning(f"âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¿ã‚°è¨­å®šè­¦å‘Š ({tag_name}): {e}")
            
            logger.info("âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚°ã‚¨ãƒªã‚¢ä½œæˆå®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚°ã‚¨ãƒªã‚¢ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def _add_initial_logs(self):
        """åˆæœŸãƒ­ã‚°è¿½åŠ """
        try:
            self.add_message("ğŸ“‹ LogPanel Phase5 åˆæœŸåŒ–å®Œäº†", "phase5")
            self.add_message("ğŸ¨ UIåˆ†é›¢ã«ã‚ˆã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼è¨­è¨ˆé©ç”¨", "ui_component")
            self.add_message("âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°è¡¨ç¤ºé–‹å§‹", "success")
            self.add_message("ğŸ”§ ScrolledTextã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ä¿®æ­£å®Œäº†", "info")
            
        except Exception as e:
            logger.error(f"âŒ åˆæœŸãƒ­ã‚°è¿½åŠ ã‚¨ãƒ©ãƒ¼: {e}")
    
    # === ãƒ­ã‚°æ“ä½œãƒ¡ã‚½ãƒƒãƒ‰ ===
    
    def add_message(self, message, tag="info"):
        """ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ """
        try:
            # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
            timestamp = datetime.now().strftime("%H:%M:%S.%f")[:-3]  # ãƒŸãƒªç§’ã¾ã§
            log_message = f"[{timestamp}] {message}\n"
            
            # UIã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
            def add_to_ui():
                try:
                    # ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒã‚§ãƒƒã‚¯
                    if not self._should_show_message(tag):
                        return
                    
                    # ãƒ­ã‚°ãƒãƒƒãƒ•ã‚¡ã«è¿½åŠ 
                    self.log_buffer.append({
                        'timestamp': timestamp,
                        'message': message,
                        'tag': tag,
                        'full_text': log_message
                    })
                    
                    # ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºåˆ¶é™
                    if len(self.log_buffer) > self.max_log_lines:
                        self.log_buffer.pop(0)
                    
                    # UIæ›´æ–°
                    if self.log_text:
                        self.log_text.insert(tk.END, log_message, tag)
                        
                        # è¡Œæ•°åˆ¶é™
                        self._limit_log_lines()
                        
                        # è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                        if self.auto_scroll:
                            self.log_text.see(tk.END)
                        
                        # çµ±è¨ˆæ›´æ–°
                        self._update_stats()
                        
                        # æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
                        self._update_search_highlight()
                    
                except Exception as e:
                    logger.error(f"âŒ ãƒ­ã‚°UIè¿½åŠ ã‚¨ãƒ©ãƒ¼: {e}")
            
            # ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
            if threading.current_thread() == threading.main_thread():
                add_to_ui()
            else:
                if self.parent_frame:
                    self.parent_frame.after(0, add_to_ui)
                
        except Exception as e:
            logger.error(f"âŒ ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _should_show_message(self, tag):
        """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºåˆ¤å®š"""
        try:
            # ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒã‚§ãƒƒã‚¯
            if tag in self.filter_vars:
                return self.filter_vars[tag].get()
            return True  # æœªçŸ¥ã®ã‚¿ã‚°ã¯è¡¨ç¤º
            
        except Exception as e:
            logger.error(f"âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºåˆ¤å®šã‚¨ãƒ©ãƒ¼: {e}")
            return True
    
    def _limit_log_lines(self):
        """ãƒ­ã‚°è¡Œæ•°åˆ¶é™"""
        try:
            if not self.log_text:
                return
                
            lines = int(self.log_text.index('end-1c').split('.')[0])
            if lines > self.max_log_lines:
                # å…ˆé ­è¡Œã‚’å‰Šé™¤
                delete_lines = lines - self.max_log_lines + 100  # å°‘ã—å¤šã‚ã«å‰Šé™¤
                self.log_text.delete('1.0', f'{delete_lines}.0')
                
        except Exception as e:
            logger.error(f"âŒ ãƒ­ã‚°è¡Œæ•°åˆ¶é™ã‚¨ãƒ©ãƒ¼: {e}")
    
    def clear_logs(self):
        """ãƒ­ã‚°ã‚¯ãƒªã‚¢"""
        try:
            if self.log_text:
                self.log_text.delete('1.0', tk.END)
            self.log_buffer.clear()
            self._update_stats()
            self.add_message("ğŸ—‘ï¸ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ", "info")
            
        except Exception as e:
            logger.error(f"âŒ ãƒ­ã‚°ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: {e}")
    
    def export_logs(self):
        """ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"""
        try:
            if not self.log_buffer:
                messagebox.showwarning("è­¦å‘Š", "ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“")
                return
            
            # ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
            filename = filedialog.asksaveasfilename(
                title="ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
                defaultextension=".txt",
                filetypes=[
                    ("ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«", "*.txt"),
                    ("ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«", "*.log"),
                    ("å…¨ãƒ•ã‚¡ã‚¤ãƒ«", "*.*")
                ]
            )
            
            if not filename:
                return
            
            # ãƒ­ã‚°æ›¸ãå‡ºã—
            with open(filename, 'w', encoding='utf-8') as f:
                f.write(f"# WebSocketã‚¿ãƒ– ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ\n")
                f.write(f"# ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ—¥æ™‚: {datetime.now().isoformat()}\n")
                f.write(f"# ãƒ­ã‚°ä»¶æ•°: {len(self.log_buffer)}ä»¶\n")
                f.write("# " + "="*50 + "\n\n")
                
                for log_entry in self.log_buffer:
                    f.write(f"[{log_entry['timestamp']}] [{log_entry['tag']}] {log_entry['message']}\n")
            
            messagebox.showinfo("å®Œäº†", f"ãƒ­ã‚°ã‚’ {filename} ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ")
            self.add_message(f"ğŸ“¤ ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†: {filename}", "success")
            
        except Exception as e:
            logger.error(f"âŒ ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
            messagebox.showerror("ã‚¨ãƒ©ãƒ¼", f"ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n{e}")
    
    # === æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ ===
    
    def _on_search_changed(self, event=None):
        """æ¤œç´¢æ–‡å­—åˆ—å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ"""
        try:
            self._update_search_highlight()
            
        except Exception as e:
            logger.error(f"âŒ æ¤œç´¢å¤‰æ›´ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _update_search_highlight(self):
        """æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°"""
        try:
            if not self.log_text:
                return
                
            # æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¯ãƒªã‚¢
            self.log_text.tag_remove('search_highlight', '1.0', tk.END)
            
            search_text = self.search_var.get().strip() if self.search_var else ""
            if not search_text:
                return
            
            # æ¤œç´¢å®Ÿè¡Œ
            start_pos = '1.0'
            while True:
                pos = self.log_text.search(search_text, start_pos, tk.END, nocase=True)
                if not pos:
                    break
                
                end_pos = f"{pos}+{len(search_text)}c"
                self.log_text.tag_add('search_highlight', pos, end_pos)
                start_pos = end_pos
                
        except Exception as e:
            logger.error(f"âŒ æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _on_filter_changed(self, filter_name):
        """ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ"""
        try:
            # ãƒ­ã‚°å†è¡¨ç¤º
            self._refresh_log_display()
            
        except Exception as e:
            logger.error(f"âŒ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _refresh_log_display(self):
        """ãƒ­ã‚°è¡¨ç¤ºãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥"""
        try:
            if not self.log_text:
                return
                
            # ç¾åœ¨ã®è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            self.log_text.delete('1.0', tk.END)
            
            # ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ã—ã¦å†è¡¨ç¤º
            for log_entry in self.log_buffer:
                if self._should_show_message(log_entry['tag']):
                    self.log_text.insert(tk.END, log_entry['full_text'], log_entry['tag'])
            
            # æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
            self._update_search_highlight()
            
            # è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            if self.auto_scroll:
                self.log_text.see(tk.END)
                
        except Exception as e:
            logger.error(f"âŒ ãƒ­ã‚°è¡¨ç¤ºãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _on_auto_scroll_changed(self):
        """è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨­å®šå¤‰æ›´"""
        try:
            self.auto_scroll = self.auto_scroll_var.get()
            if self.auto_scroll and self.log_text:
                self.log_text.see(tk.END)
                
        except Exception as e:
            logger.error(f"âŒ è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨­å®šå¤‰æ›´ã‚¨ãƒ©ãƒ¼: {e}")
    
    # === çµ±è¨ˆãƒ»çŠ¶æ…‹ç®¡ç† ===
    
    def _update_stats(self):
        """çµ±è¨ˆæƒ…å ±æ›´æ–°"""
        try:
            if not self.stats_label:
                return
                
            total_lines = len(self.log_buffer)
            visible_lines = 0
            if self.log_text:
                try:
                    visible_lines = int(self.log_text.index('end-1c').split('.')[0]) - 1
                except:
                    visible_lines = 0
            
            # ã‚¿ã‚°åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
            tag_counts = {}
            for log_entry in self.log_buffer:
                tag = log_entry['tag']
                tag_counts[tag] = tag_counts.get(tag, 0) + 1
            
            # çµ±è¨ˆãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
            stats_text = f"ãƒ­ã‚°: {total_lines}è¡Œ (è¡¨ç¤º: {visible_lines}è¡Œ)"
            if tag_counts:
                error_count = tag_counts.get('error', 0)
                warning_count = tag_counts.get('warning', 0)
                if error_count > 0 or warning_count > 0:
                    stats_text += f" | ã‚¨ãƒ©ãƒ¼: {error_count}ä»¶, è­¦å‘Š: {warning_count}ä»¶"
            
            self.stats_label.config(text=stats_text)
            
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆæƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    # === ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ===
    
    def cleanup(self):
        """ãƒ‘ãƒãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"""
        try:
            logger.info("ğŸ§¹ LogPanel ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹")
            
            # ãƒ­ã‚°ãƒãƒƒãƒ•ã‚¡ã‚¯ãƒªã‚¢
            self.log_buffer.clear()
            
            # ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ•°ã‚¯ãƒªã‚¢
            self.filter_vars.clear()
            
            logger.info("âœ… LogPanel ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ ãƒ­ã‚°ãƒ‘ãƒãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: {e}")
    
    def get_status(self):
        """ãƒ‘ãƒãƒ«çŠ¶æ…‹å–å¾—"""
        try:
            return {
                'panel_created': self.main_panel is not None,
                'log_count': len(self.log_buffer),
                'max_log_lines': self.max_log_lines,
                'auto_scroll': self.auto_scroll,
                'filter_count': len(self.filter_vars),
                'search_active': bool(self.search_var and self.search_var.get().strip()),
                'log_text_available': self.log_text is not None
            }
            
        except Exception as e:
            logger.error(f"âŒ ãƒ­ã‚°ãƒ‘ãƒãƒ«çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return {'error': str(e)}


# === ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼é–¢æ•° ===

def create_log_panel(settings, callbacks=None):
    """
    LogPanelä½œæˆé–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
    
    Args:
        settings: è¨­å®šè¾æ›¸
        callbacks: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¾æ›¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        
    Returns:
        LogPanel: ãƒ­ã‚°ãƒ‘ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    """
    try:
        panel = LogPanel(settings, callbacks)
        logger.info("âœ… LogPanelä½œæˆå®Œäº†ï¼ˆä¿®æ­£ç‰ˆï¼‰")
        return panel
        
    except Exception as e:
        logger.error(f"âŒ LogPanelä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
        raise


# === é«˜åº¦ãªæ©Ÿèƒ½ ===

def add_bulk_messages(self, messages):
    """ä¸€æ‹¬ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ """
    try:
        for message_data in messages:
            if isinstance(message_data, dict):
                self.add_message(message_data.get('message', ''), message_data.get('tag', 'info'))
            else:
                self.add_message(str(message_data), 'info')
                
    except Exception as e:
        logger.error(f"âŒ ä¸€æ‹¬ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ ã‚¨ãƒ©ãƒ¼: {e}")

def search_logs(self, query, tag_filter=None):
    """ãƒ­ã‚°æ¤œç´¢"""
    try:
        results = []
        query_lower = query.lower()
        
        for log_entry in self.log_buffer:
            # ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            if tag_filter and log_entry['tag'] != tag_filter:
                continue
            
            # ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
            if query_lower in log_entry['message'].lower():
                results.append(log_entry)
        
        return results
        
    except Exception as e:
        logger.error(f"âŒ ãƒ­ã‚°æ¤œç´¢ã‚¨ãƒ©ãƒ¼: {e}")
        return []

def get_logs_by_timerange(self, start_time, end_time):
    """æ™‚é–“ç¯„å›²ã§ãƒ­ã‚°å–å¾—"""
    try:
        results = []
        
        for log_entry in self.log_buffer:
            try:
                log_time = datetime.strptime(log_entry['timestamp'], "%H:%M:%S.%f")
                if start_time <= log_time <= end_time:
                    results.append(log_entry)
            except ValueError:
                continue
        
        return results
        
    except Exception as e:
        logger.error(f"âŒ æ™‚é–“ç¯„å›²ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        return []

def set_log_level_visibility(self, level_settings):
    """ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºè¨­å®š"""
    try:
        for level, visible in level_settings.items():
            if level in self.filter_vars:
                self.filter_vars[level].set(visible)
        
        self._refresh_log_display()
        
    except Exception as e:
        logger.error(f"âŒ ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºè¨­å®šã‚¨ãƒ©ãƒ¼: {e}")

# === è¨­å®šç®¡ç† ===

def update_settings(self, new_settings):
    """è¨­å®šæ›´æ–°"""
    try:
        self.settings.update(new_settings)
        
        # æœ€å¤§è¡Œæ•°æ›´æ–°
        if 'max_log_lines' in new_settings:
            self.max_log_lines = new_settings['max_log_lines']
            self._limit_log_lines()
        
        # è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ›´æ–°
        if 'auto_scroll' in new_settings:
            self.auto_scroll_var.set(new_settings['auto_scroll'])
            self._on_auto_scroll_changed()
            
    except Exception as e:
        logger.error(f"âŒ è¨­å®šæ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")

def get_settings(self):
    """ç¾åœ¨ã®è¨­å®šå–å¾—"""
    try:
        return {
            'max_log_lines': self.max_log_lines,
            'auto_scroll': self.auto_scroll,
            'filter_settings': {name: var.get() for name, var in self.filter_vars.items()}
        }
        
    except Exception as e:
        logger.error(f"âŒ è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        return {}

def get_log_summary(self):
    """ãƒ­ã‚°ã‚µãƒãƒªãƒ¼å–å¾—"""
    try:
        tag_counts = {}
        recent_errors = []
        
        for log_entry in self.log_buffer:
            tag = log_entry['tag']
            tag_counts[tag] = tag_counts.get(tag, 0) + 1
            
            # æœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼åé›†
            if tag == 'error' and len(recent_errors) < 5:
                recent_errors.append({
                    'timestamp': log_entry['timestamp'],
                    'message': log_entry['message'][:100]  # æœ€åˆã®100æ–‡å­—
                })
        
        return {
            'total_logs': len(self.log_buffer),
            'tag_counts': tag_counts,
            'recent_errors': recent_errors,
            'buffer_size': self.max_log_lines,
            'auto_scroll': self.auto_scroll
        }
        
    except Exception as e:
        logger.error(f"âŒ ãƒ­ã‚°ã‚µãƒãƒªãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        return {}


# LogPanelã‚¯ãƒ©ã‚¹ã«ä¸Šè¨˜ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆä¿®æ­£ï¼‰
# å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯LogPanelã‚¯ãƒ©ã‚¹å†…ã«é…ç½®ã—ã¦ãã ã•ã„

# ã‚¯ãƒ©ã‚¹ã®å¤–ã§å®šç¾©ã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«LogPanelã«è¿½åŠ 
LogPanel.add_bulk_messages = add_bulk_messages
LogPanel.search_logs = search_logs  
LogPanel.get_logs_by_timerange = get_logs_by_timerange
LogPanel.set_log_level_visibility = set_log_level_visibility
LogPanel.update_settings = update_settings
LogPanel.get_settings = get_settings
LogPanel.get_log_summary = get_log_summary


# === ãƒ†ã‚¹ãƒˆé–¢æ•° ===

def test_log_panel():
    """LogPanelãƒ†ã‚¹ãƒˆé–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰"""
    print("ğŸ§ª LogPanelä¿®æ­£ç‰ˆãƒ†ã‚¹ãƒˆé–‹å§‹")
    
    try:
        # ãƒ†ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä½œæˆ
        root = tk.Tk()
        root.title("LogPanelä¿®æ­£ç‰ˆãƒ†ã‚¹ãƒˆ")
        root.geometry("1000x600")
        
        # ãƒ†ã‚¹ãƒˆç”¨è¨­å®š
        test_settings = {
            'max_log_lines': 500,
            'auto_scroll': True
        }
        
        # ãƒ‘ãƒãƒ«ä½œæˆ
        panel = create_log_panel(test_settings)
        panel.create_in_parent(root)
        
        # ãƒ†ã‚¹ãƒˆãƒ­ã‚°è¿½åŠ 
        test_logs = [
            ("ğŸ“‹ LogPanelä¿®æ­£ç‰ˆãƒ†ã‚¹ãƒˆé–‹å§‹", "phase5"),
            ("âœ… ScrolledTextã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ä¿®æ­£", "success"),
            ("âš ï¸ ãƒ†ã‚¹ãƒˆè­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", "warning"),
            ("âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", "error"),
            ("â„¹ï¸ æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", "info"),
            ("ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", "debug"),
            ("ğŸ¨ UIåˆ†é›¢ãƒ†ã‚¹ãƒˆ", "ui_component"),
            ("ğŸ® ã‚µãƒ¼ãƒ“ã‚¹åˆ¶å¾¡ãƒ†ã‚¹ãƒˆ", "service_control")
        ]
        
        # å®šæœŸçš„ã«ãƒ†ã‚¹ãƒˆãƒ­ã‚°è¿½åŠ 
        def add_test_logs():
            try:
                import random
                log_message, log_tag = random.choice(test_logs)
                panel.add_message(f"{log_message} (#{random.randint(1000, 9999)})", log_tag)
                root.after(2000, add_test_logs)  # 2ç§’ã”ã¨
            except:
                pass
        
        # åˆæœŸãƒ­ã‚°è¿½åŠ 
        for message, tag in test_logs:
            panel.add_message(message, tag)
        
        # å®šæœŸè¿½åŠ é–‹å§‹
        add_test_logs()
        
        # çŠ¶æ…‹ç¢ºèª
        status = panel.get_status()
        print(f"ğŸ“Š ãƒ‘ãƒãƒ«çŠ¶æ…‹ï¼ˆä¿®æ­£ç‰ˆï¼‰: {status}")
        
        # ä¿®æ­£ç¢ºèªãƒ­ã‚°
        print("âœ… ä¿®æ­£é …ç›®ç¢ºèª:")
        print("  - ScrolledTextã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ä¿®æ­£")
        print("  - ãƒ­ã‚°ã‚¿ã‚°è¨­å®šåˆ†é›¢")
        print("  - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–") 
        print("  - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½è¿½åŠ ")
        
        # çµ‚äº†å‡¦ç†
        def on_closing():
            try:
                panel.cleanup()
                root.destroy()
            except Exception as e:
                print(f"âŒ çµ‚äº†å‡¦ç†ã‚¨ãƒ©ãƒ¼: {e}")
                root.destroy()
        
        root.protocol("WM_DELETE_WINDOW", on_closing)
        
        print("ğŸš€ ãƒ­ã‚°ãƒ‘ãƒãƒ«ä¿®æ­£ç‰ˆãƒ†ã‚¹ãƒˆé–‹å§‹ - ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¦çµ‚äº†")
        root.mainloop()
        
        print("âœ… LogPanelä¿®æ­£ç‰ˆãƒ†ã‚¹ãƒˆå®Œäº†")
        return True
        
    except Exception as e:
        print(f"âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()
        return False


if __name__ == "__main__":
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    print("ğŸ”§ log_panel.py ä¿®æ­£ç‰ˆ")
    print("ğŸ“‹ ScrolledTextã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ä¿®æ­£å®Œäº†")
    test_log_panel()
