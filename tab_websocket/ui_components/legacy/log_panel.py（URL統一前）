# -*- coding: utf-8 -*-
"""
LogPanel æœ€å°å®Ÿè£…ç‰ˆï¼ˆä¾å­˜ãªã—ãƒ»å®‰å…¨ç‰ˆï¼‰
WebSocketã‚¿ãƒ–ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼è§£æ±ºç”¨

ç‰¹å¾´:
- å¤–éƒ¨ä¾å­˜ãªã—
- ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ­ã‚°è¡¨ç¤ºæ©Ÿèƒ½
- äº’æ›APIä¿æŒ
- UIåˆ†é›¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå¯¾å¿œ
"""

import tkinter as tk
from tkinter import ttk, scrolledtext
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

class LogPanel:
    """æœ€ä½é™ã®ãƒ­ã‚°ãƒ‘ãƒãƒ«ï¼ˆä¾å­˜ãªã—ãƒ»å®‰å…¨ç‰ˆï¼‰"""
    
    def __init__(self, parent=None, message_bus=None, *, title="ğŸ“‹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°"):
        self.parent = parent
        self.message_bus = message_bus
        
        # ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆ
        self.frame = ttk.Frame(parent) if parent else ttk.Frame()
        
        # ã‚¿ã‚¤ãƒˆãƒ«
        self.title_label = ttk.Label(
            self.frame, 
            text=title, 
            font=("Yu Gothic UI", 14, "bold")
        )
        self.title_label.pack(anchor="w", pady=(0, 8))

        # ãƒ­ã‚°ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢
        self.text = scrolledtext.ScrolledText(
            self.frame, 
            wrap=tk.WORD, 
            height=12,
            bg="#1a1a1a",
            fg="#ffffff",
            font=("Consolas", 9)
        )
        self.text.pack(fill=tk.BOTH, expand=True)
        
        # åˆæœŸãƒ­ã‚°
        self.append_log("âœ… LogPanel åˆæœŸåŒ–å®Œäº†")

        # æ“ä½œãƒœã‚¿ãƒ³
        btns = ttk.Frame(self.frame)
        btns.pack(fill=tk.X, pady=(8, 0))
        
        ttk.Button(
            btns, 
            text="ğŸ—‘ ã‚¯ãƒªã‚¢", 
            command=self.clear_logs
        ).pack(side=tk.LEFT)
        
        ttk.Button(
            btns, 
            text="ğŸ“„ ã‚³ãƒ”ãƒ¼", 
            command=self.copy_all
        ).pack(side=tk.LEFT, padx=(8, 0))
        
        ttk.Button(
            btns, 
            text="ğŸ’¾ ä¿å­˜", 
            command=self.save_logs
        ).pack(side=tk.LEFT, padx=(8, 0))

        logger.info("âœ… LogPanelæœ€å°å®Ÿè£…ç‰ˆ åˆæœŸåŒ–å®Œäº†")

    # ==================== äº’æ›API ====================
    
    def create_in_parent(self, parent):
        """UIåˆ†é›¢ç‰ˆäº’æ›API"""
        self.frame = ttk.Frame(parent)
        self.__init__(parent)  # å†åˆæœŸåŒ–ï¼ˆè¦ªå·®ã—æ›¿ãˆï¼‰
        return self.frame

    def get_widget(self):
        """UIåˆ†é›¢ç‰ˆäº’æ›API"""
        return self.frame

    # ==================== ãƒ­ã‚°æ“ä½œ ====================
    
    def append_log(self, msg: str):
        """ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ """
        try:
            timestamp = datetime.now().strftime("%H:%M:%S")
            formatted_msg = f"[{timestamp}] {msg}\n"
            
            self.text.insert(tk.END, formatted_msg)
            self.text.see(tk.END)
            
            # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
            logger.debug(f"LogPanel: {msg}")
            
        except Exception as e:
            logger.error(f"append_log error: {e}")

    def clear_logs(self):
        """ãƒ­ã‚°ã‚¯ãƒªã‚¢"""
        try:
            self.text.delete("1.0", tk.END)
            self.append_log("ğŸ—‘ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ")
        except Exception as e:
            logger.error(f"clear_logs error: {e}")

    def copy_all(self):
        """å…¨ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼"""
        try:
            content = self.text.get("1.0", tk.END).strip()
            self.frame.clipboard_clear()
            self.frame.clipboard_append(content)
            self.append_log("ğŸ“„ ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")
        except Exception as e:
            logger.error(f"copy_all error: {e}")

    def save_logs(self):
        """ãƒ­ã‚°ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜"""
        try:
            from tkinter import filedialog
            
            file_path = filedialog.asksaveasfilename(
                defaultextension=".txt",
                filetypes=[("Text files", "*.txt"), ("All files", "*.*")],
                title="ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜"
            )
            
            if file_path:
                content = self.text.get("1.0", tk.END)
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write(content)
                self.append_log(f"ğŸ’¾ ãƒ­ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸ: {file_path}")
                
        except Exception as e:
            logger.error(f"save_logs error: {e}")
            self.append_log(f"âŒ ãƒ­ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")

    # ==================== MessageBusé€£æº ====================
    
    def setup_message_subscriptions(self):
        """MessageBusè³¼èª­è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"""
        if not self.message_bus:
            return
            
        try:
            # åŸºæœ¬çš„ãªã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­ã—ã¦ãƒ­ã‚°è¡¨ç¤º
            events_to_subscribe = [
                "STATUS_UPDATE",
                "CHAT_MESSAGE", 
                "VOICE_REQUEST",
                "AI_RESPONSE",
                "USER_JOIN"
            ]
            
            for event in events_to_subscribe:
                try:
                    self.message_bus.subscribe(event, self._on_message_received)
                except Exception as e:
                    logger.debug(f"è³¼èª­è¨­å®šã‚¹ã‚­ãƒƒãƒ— {event}: {e}")
                    
            self.append_log("ğŸ“¡ MessageBusè³¼èª­è¨­å®šå®Œäº†")
            
        except Exception as e:
            logger.error(f"MessageBusè³¼èª­è¨­å®šã‚¨ãƒ©ãƒ¼: {e}")

    def _on_message_received(self, data, sender=None):
        """MessageBuså—ä¿¡ãƒ­ã‚°"""
        try:
            event_info = f"ğŸ“¨ {sender}: {str(data)[:50]}"
            if len(str(data)) > 50:
                event_info += "..."
            self.append_log(event_info)
        except Exception as e:
            logger.error(f"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒ­ã‚°ã‚¨ãƒ©ãƒ¼: {e}")

    # ==================== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ====================
    
    def cleanup(self):
        """ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†"""
        try:
            if self.message_bus:
                # è³¼èª­è§£é™¤ï¼ˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
                try:
                    self.message_bus.unsubscribe("STATUS_UPDATE", self._on_message_received)
                    self.message_bus.unsubscribe("CHAT_MESSAGE", self._on_message_received)
                    self.message_bus.unsubscribe("VOICE_REQUEST", self._on_message_received)
                    self.message_bus.unsubscribe("AI_RESPONSE", self._on_message_received)
                    self.message_bus.unsubscribe("USER_JOIN", self._on_message_received)
                except:
                    pass
                    
            logger.info("âœ… LogPanel ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†")
            
        except Exception as e:
            logger.error(f"LogPanel ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: {e}")


# ==================== ãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•° ====================

def create_log_panel(parent, message_bus=None, title="ğŸ“‹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°"):
    """LogPanelä½œæˆãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•°"""
    try:
        panel = LogPanel(parent, message_bus, title=title)
        if message_bus:
            panel.setup_message_subscriptions()
        return panel
    except Exception as e:
        logger.error(f"LogPanelä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
        # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€å°é™ã®ãƒ­ã‚°ãƒ‘ãƒãƒ«
        frame = ttk.Frame(parent)
        ttk.Label(frame, text="ãƒ­ã‚°ãƒ‘ãƒãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼").pack(pady=20)
        return frame


# ==================== ãƒ†ã‚¹ãƒˆé–¢æ•° ====================

def test_log_panel():
    """LogPanelãƒ†ã‚¹ãƒˆ"""
    root = tk.Tk()
    root.title("LogPanel ãƒ†ã‚¹ãƒˆ")
    root.geometry("600x400")
    
    panel = LogPanel(root, title="ğŸ§ª ãƒ†ã‚¹ãƒˆç”¨ãƒ­ã‚°ãƒ‘ãƒãƒ«")
    panel.frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
    
    # ãƒ†ã‚¹ãƒˆãƒ­ã‚°è¿½åŠ 
    panel.append_log("ãƒ†ã‚¹ãƒˆãƒ­ã‚°1: åˆæœŸåŒ–å®Œäº†")
    panel.append_log("ãƒ†ã‚¹ãƒˆãƒ­ã‚°2: æ¥ç¶šé–‹å§‹")
    panel.append_log("ãƒ†ã‚¹ãƒˆãƒ­ã‚°3: ãƒ‡ãƒ¼ã‚¿å—ä¿¡")
    
    root.mainloop()


if __name__ == "__main__":
    test_log_panel()
