#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸšŒ MessageBus æ–‡å­—åˆ—ã‚¤ãƒ™ãƒ³ãƒˆè¨±å®¹å¯¾å¿œç‰ˆ
'str' object has no attribute 'name' ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ

ğŸ”¥ Phase 3ä¿®æ­£ç‚¹:
- âœ… æ–‡å­—åˆ—ã‚¤ãƒ™ãƒ³ãƒˆè¨±å®¹ï¼ˆEventså®šæ•° + ç”Ÿæ–‡å­—åˆ— ä¸¡å¯¾å¿œï¼‰
- âœ… 'str' object has no attribute 'name' ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ
- âœ… å¾Œæ–¹äº’æ›æ€§ä¿æŒ

æ©Ÿèƒ½:
- ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œãƒ»è³¼èª­ã‚·ã‚¹ãƒ†ãƒ 
- å„ªå…ˆåº¦ç®¡ç†
- éåŒæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ğŸ”¥ æŸ”è»Ÿãªã‚¤ãƒ™ãƒ³ãƒˆåå‡¦ç†
"""

import asyncio
import json
import time
import threading
import logging
from datetime import datetime
from typing import Dict, Any, List, Callable, Optional, Union
from dataclasses import dataclass
from collections import deque, defaultdict
from enum import Enum
import traceback

# ãƒ­ã‚¬ãƒ¼è¨­å®š
logger = logging.getLogger(__name__)

class MessagePriority(Enum):
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å„ªå…ˆåº¦å®šç¾©"""
    HIGH = "HIGH"
    NORMAL = "NORMAL" 
    LOW = "LOW"

@dataclass
class Message:
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿æ§‹é€ """
    event_type: str
    data: Any
    sender: str
    priority: MessagePriority
    timestamp: datetime
    message_id: str = None

    def to_dict(self) -> Dict[str, Any]:
        """è¾æ›¸å½¢å¼å¤‰æ›"""
        return {
            'event_type': self.event_type,
            'data': self.data,
            'sender': self.sender,
            'priority': self.priority.value,
            'timestamp': self.timestamp.isoformat(),
            'message_id': self.message_id
        }


class MessageBus:
    """
    MessageBus - Phase 3æ–‡å­—åˆ—ã‚¤ãƒ™ãƒ³ãƒˆè¨±å®¹å¯¾å¿œç‰ˆ
    
    ğŸ”¥ ä¿®æ­£ç‚¹:
    - publish()ã§Eventså®šæ•°ãƒ»ç”Ÿæ–‡å­—åˆ—ä¸¡å¯¾å¿œ
    - 'str' object has no attribute 'name' ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ
    """
    
    def __init__(self, debug=False, max_queue_size=10000):
        """
        åˆæœŸåŒ–
        
        Args:
            debug: ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
            max_queue_size: ã‚­ãƒ¥ãƒ¼æœ€å¤§ã‚µã‚¤ã‚º
        """
        self.debug = debug
        self.max_queue_size = max_queue_size
        
        # è³¼èª­è€…ç®¡ç†
        self.subscribers: Dict[str, List[Callable]] = defaultdict(list)
        
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼
        self.message_queue = deque(maxlen=max_queue_size)
        
        # å‡¦ç†çµ±è¨ˆ
        self.stats = {
            'messages_published': 0,
            'messages_processed': 0,
            'errors_occurred': 0,
            'start_time': datetime.now()
        }
        
        # ãƒ¯ãƒ¼ã‚«ãƒ¼ç®¡ç†
        self.worker_running = False
        self.worker_thread: Optional[threading.Thread] = None
        
        # åˆ¶å¾¡ãƒ•ãƒ©ã‚°
        self.running = False
        
        logger.info(f"ğŸš€ MessageBus v16.2.0 åˆæœŸåŒ–å®Œäº†ï¼ˆdebug={debug}, max_queue={max_queue_size}ï¼‰")
    
    def start(self):
        """MessageBusé–‹å§‹"""
        if self.running:
            logger.warning("âš ï¸ MessageBusæ—¢ã«å®Ÿè¡Œä¸­")
            return
        
        self.running = True
        self.worker_running = True
        
        # ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¹ãƒ¬ãƒƒãƒ‰é–‹å§‹
        self.worker_thread = threading.Thread(target=self._worker_loop, daemon=True)
        self.worker_thread.start()
        
        logger.info("ğŸ”„ MessageBus ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†é–‹å§‹")
        logger.info("ğŸ“¡ MessageBus ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¹ãƒ¬ãƒƒãƒ‰é–‹å§‹")
    
    def stop(self):
        """MessageBusåœæ­¢"""
        self.running = False
        self.worker_running = False
        
        if self.worker_thread and self.worker_thread.is_alive():
            self.worker_thread.join(timeout=5.0)
        
        logger.info("ğŸ›‘ MessageBusåœæ­¢å®Œäº†")
    
    def publish(self, event, data=None, priority=MessagePriority.NORMAL, sender="unknown"):
        """
        ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç™ºè¡Œ - Phase 3ä¿®æ­£ç‰ˆ
        
        ğŸ”¥ ä¿®æ­£: Eventså®šæ•°ãƒ»ç”Ÿæ–‡å­—åˆ—ä¸¡å¯¾å¿œ
        
        Args:
            event: ã‚¤ãƒ™ãƒ³ãƒˆ (Eventså®šæ•° ã¾ãŸã¯ æ–‡å­—åˆ—)
            data: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿
            priority: å„ªå…ˆåº¦
            sender: é€ä¿¡è€…
        """
        try:
            # ğŸ”¥ Phase 3: æŸ”è»Ÿãªã‚¤ãƒ™ãƒ³ãƒˆåå‡¦ç†
            event_name = self._extract_event_name(event)
            
            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
            message = Message(
                event_type=event_name,
                data=data,
                sender=sender,
                priority=priority,
                timestamp=datetime.now(),
                message_id=f"{event_name}_{int(time.time() * 1000)}"
            )
            
            # ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
            self.message_queue.append(message)
            self.stats['messages_published'] += 1
            
            if self.debug:
                logger.debug(f"ğŸ“¤ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç™ºè¡Œ: {event_name} from {sender}")
            
        except Exception as e:
            logger.error(f"âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç™ºè¡Œã‚¨ãƒ©ãƒ¼: {e}")
            self.stats['errors_occurred'] += 1
    
    def _extract_event_name(self, event: Union[str, Any]) -> str:
        """
        ã‚¤ãƒ™ãƒ³ãƒˆåæŠ½å‡º - Phase 3è¿½åŠ 
        
        Eventså®šæ•°ãƒ»ç”Ÿæ–‡å­—åˆ—ãƒ»ãã®ä»–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¯¾å¿œ
        'str' object has no attribute 'name' ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ
        
        Args:
            event: ã‚¤ãƒ™ãƒ³ãƒˆ (ä»»æ„ã®å‹)
            
        Returns:
            str: ã‚¤ãƒ™ãƒ³ãƒˆåæ–‡å­—åˆ—
        """
        # æ–‡å­—åˆ—ã®å ´åˆã¯ãã®ã¾ã¾
        if isinstance(event, str):
            return event
        
        # .nameå±æ€§ãŒã‚ã‚‹å ´åˆï¼ˆEnumç­‰ï¼‰
        if hasattr(event, 'name'):
            return str(event.name)
        
        # .valueå±æ€§ãŒã‚ã‚‹å ´åˆï¼ˆEnumç­‰ï¼‰
        if hasattr(event, 'value'):
            return str(event.value)
        
        # ãã®ä»–ã®å ´åˆã¯æ–‡å­—åˆ—å¤‰æ›
        return str(event)
    
    def subscribe(self, event_type: Union[str, Any], callback: Callable):
        """
        ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ - Phase 3ä¿®æ­£ç‰ˆ
        
        Args:
            event_type: ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ— (Eventså®šæ•° ã¾ãŸã¯ æ–‡å­—åˆ—)
            callback: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
        """
        try:
            # ğŸ”¥ Phase 3: æŸ”è»Ÿãªã‚¤ãƒ™ãƒ³ãƒˆåå‡¦ç†
            event_name = self._extract_event_name(event_type)
            
            if callback not in self.subscribers[event_name]:
                self.subscribers[event_name].append(callback)
                
                if self.debug:
                    logger.debug(f"ğŸ”— ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­: {event_name}")
            
        except Exception as e:
            logger.error(f"âŒ ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ã‚¨ãƒ©ãƒ¼: {e}")
    
    def unsubscribe(self, event_type: Union[str, Any], callback: Callable):
        """
        ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­è§£é™¤ - Phase 3ä¿®æ­£ç‰ˆ
        
        Args:
            event_type: ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ— (Eventså®šæ•° ã¾ãŸã¯ æ–‡å­—åˆ—)
            callback: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
        """
        try:
            # ğŸ”¥ Phase 3: æŸ”è»Ÿãªã‚¤ãƒ™ãƒ³ãƒˆåå‡¦ç†
            event_name = self._extract_event_name(event_type)
            
            if event_name in self.subscribers:
                if callback in self.subscribers[event_name]:
                    self.subscribers[event_name].remove(callback)
                    
                    if self.debug:
                        logger.debug(f"ğŸ”Œ ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­è§£é™¤: {event_name}")
            
        except Exception as e:
            logger.error(f"âŒ ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­è§£é™¤ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _worker_loop(self):
        """ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ«ãƒ¼ãƒ—ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ï¼‰"""
        while self.worker_running:
            try:
                if self.message_queue:
                    message = self.message_queue.popleft()
                    self._process_message(message)
                else:
                    time.sleep(0.01)  # CPUãƒªã‚½ãƒ¼ã‚¹ç¯€ç´„
                    
            except Exception as e:
                logger.error(f"âŒ ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ«ãƒ¼ãƒ—ã‚¨ãƒ©ãƒ¼: {e}")
                self.stats['errors_occurred'] += 1
    
    def _process_message(self, message: Message):
        """å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†"""
        try:
            event_type = message.event_type
            subscribers = self.subscribers.get(event_type, [])
            
            if not subscribers:
                if self.debug:
                    logger.debug(f"ğŸ“­ è³¼èª­è€…ãªã—: {event_type}")
                return
            
            # å„è³¼èª­è€…ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡
            for callback in subscribers:
                try:
                    # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
                    callback(message.data, message.sender)
                    
                    if self.debug:
                        logger.debug(f"ğŸ“¨ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡: {event_type} â†’ {callback.__name__}")
                        
                except Exception as e:
                    logger.error(f"âŒ ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ ({event_type}): {e}")
                    self.stats['errors_occurred'] += 1
            
            self.stats['messages_processed'] += 1
            
        except Exception as e:
            logger.error(f"âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã‚¨ãƒ©ãƒ¼: {e}")
            self.stats['errors_occurred'] += 1
    
    # === å¾Œæ–¹äº’æ›ãƒ¡ã‚½ãƒƒãƒ‰ ===
    
    def emit(self, event, data=None, sender="unknown"):
        """emit ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆå¾Œæ–¹äº’æ›ï¼‰"""
        self.publish(event, data, MessagePriority.NORMAL, sender)
    
    def on(self, event_type, callback):
        """on ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆå¾Œæ–¹äº’æ›ï¼‰"""
        self.subscribe(event_type, callback)
    
    def off(self, event_type, callback):
        """off ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆå¾Œæ–¹äº’æ›ï¼‰"""
        self.unsubscribe(event_type, callback)
    
    # === ç®¡ç†ãƒ»ç›£è¦–æ©Ÿèƒ½ ===
    
    def get_stats(self) -> Dict[str, Any]:
        """çµ±è¨ˆæƒ…å ±å–å¾—"""
        uptime = datetime.now() - self.stats['start_time']
        
        return {
            'messages_published': self.stats['messages_published'],
            'messages_processed': self.stats['messages_processed'],
            'errors_occurred': self.stats['errors_occurred'],
            'queue_size': len(self.message_queue),
            'max_queue_size': self.max_queue_size,
            'subscriber_count': sum(len(subs) for subs in self.subscribers.values()),
            'event_types': len(self.subscribers),
            'uptime_seconds': uptime.total_seconds(),
            'worker_running': self.worker_running,
            'running': self.running
        }
    
    def get_subscribers(self) -> Dict[str, int]:
        """è³¼èª­è€…æƒ…å ±å–å¾—"""
        return {event_type: len(subscribers) 
                for event_type, subscribers in self.subscribers.items()}
    
    def clear_all_subscribers(self):
        """å…¨è³¼èª­è€…ã‚¯ãƒªã‚¢"""
        self.subscribers.clear()
        logger.info("ğŸ§¹ å…¨è³¼èª­è€…ã‚¯ãƒªã‚¢å®Œäº†")
    
    def get_queue_status(self) -> Dict[str, Any]:
        """ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹å–å¾—"""
        queue_list = list(self.message_queue)
        
        # å„ªå…ˆåº¦åˆ¥é›†è¨ˆ
        priority_counts = defaultdict(int)
        for msg in queue_list:
            priority_counts[msg.priority.value] += 1
        
        # é€ä¿¡è€…åˆ¥é›†è¨ˆ
        sender_counts = defaultdict(int)
        for msg in queue_list:
            sender_counts[msg.sender] += 1
        
        return {
            'current_size': len(queue_list),
            'max_size': self.max_queue_size,
            'utilization_percent': (len(queue_list) / self.max_queue_size) * 100,
            'priority_breakdown': dict(priority_counts),
            'sender_breakdown': dict(sender_counts),
            'oldest_message_age_seconds': (
                (datetime.now() - queue_list[0].timestamp).total_seconds()
                if queue_list else 0
            )
        }
    
    def flush_queue(self):
        """ã‚­ãƒ¥ãƒ¼ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆå¼·åˆ¶å‡¦ç†ï¼‰"""
        processed_count = 0
        
        while self.message_queue:
            message = self.message_queue.popleft()
            self._process_message(message)
            processed_count += 1
        
        logger.info(f"ğŸ”„ ã‚­ãƒ¥ãƒ¼ãƒ•ãƒ©ãƒƒã‚·ãƒ¥å®Œäº†: {processed_count}ä»¶å‡¦ç†")
        return processed_count
    
    # === ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ ===
    
    def enable_debug(self):
        """ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–"""
        self.debug = True
        logger.info("ğŸ” MessageBus ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹")
    
    def disable_debug(self):
        """ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ç„¡åŠ¹åŒ–"""
        self.debug = False
        logger.info("ğŸ” MessageBus ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ç„¡åŠ¹")
    
    def dump_state(self) -> Dict[str, Any]:
        """çŠ¶æ…‹ãƒ€ãƒ³ãƒ—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰"""
        return {
            'stats': self.get_stats(),
            'subscribers': self.get_subscribers(),
            'queue_status': self.get_queue_status(),
            'settings': {
                'debug': self.debug,
                'max_queue_size': self.max_queue_size
            }
        }
    
    # === Phase 3 æ–°æ©Ÿèƒ½ ===
    
    def broadcast(self, data: Any, sender: str = "broadcast", priority: MessagePriority = MessagePriority.HIGH):
        """
        å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ - Phase 3è¿½åŠ 
        
        Args:
            data: ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
            sender: é€ä¿¡è€…
            priority: å„ªå…ˆåº¦
        """
        try:
            broadcast_count = 0
            
            for event_type in self.subscribers.keys():
                self.publish(event_type, data, priority, sender)
                broadcast_count += 1
            
            logger.info(f"ğŸ“¡ ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆå®Ÿè¡Œ: {broadcast_count}ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—")
            
        except Exception as e:
            logger.error(f"âŒ ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def publish_delayed(self, event: Union[str, Any], data: Any, delay_seconds: float, 
                      priority: MessagePriority = MessagePriority.NORMAL, sender: str = "delayed"):
        """
        é…å»¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç™ºè¡Œ - Phase 3è¿½åŠ 
        
        Args:
            event: ã‚¤ãƒ™ãƒ³ãƒˆ
            data: ãƒ‡ãƒ¼ã‚¿
            delay_seconds: é…å»¶ç§’æ•°
            priority: å„ªå…ˆåº¦
            sender: é€ä¿¡è€…
        """
        def delayed_publish():
            time.sleep(delay_seconds)
            self.publish(event, data, priority, sender)
        
        thread = threading.Thread(target=delayed_publish, daemon=True)
        thread.start()
        
        logger.info(f"â° é…å»¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­å®š: {delay_seconds}ç§’å¾Œ {self._extract_event_name(event)}")
    
    def get_event_history(self, event_type: Union[str, Any], limit: int = 10) -> List[Dict[str, Any]]:
        """
        ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´å–å¾— - Phase 3è¿½åŠ 
        
        Args:
            event_type: ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—
            limit: å–å¾—ä»¶æ•°
            
        Returns:
            List[Dict]: ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´
        """
        try:
            event_name = self._extract_event_name(event_type)
            
            # ã‚­ãƒ¥ãƒ¼ã‹ã‚‰è©²å½“ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œç´¢
            history = []
            for message in list(self.message_queue):
                if message.event_type == event_name:
                    history.append(message.to_dict())
                    if len(history) >= limit:
                        break
            
            return history
            
        except Exception as e:
            logger.error(f"âŒ ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return []
    
    # === ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ===
    
    def cleanup(self):
        """MessageBusã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"""
        try:
            logger.info("ğŸ§¹ MessageBus ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹")
            
            # åœæ­¢
            self.stop()
            
            # æ®‹ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
            remaining_count = self.flush_queue()
            if remaining_count > 0:
                logger.info(f"ğŸ”„ æ®‹ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†: {remaining_count}ä»¶")
            
            # è³¼èª­è€…ã‚¯ãƒªã‚¢
            self.clear_all_subscribers()
            
            # çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ
            self.stats = {
                'messages_published': 0,
                'messages_processed': 0,
                'errors_occurred': 0,
                'start_time': datetime.now()
            }
            
            logger.info("âœ… MessageBus ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ MessageBus ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: {e}")


# === ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼é–¢æ•° ===

def create_message_bus(debug=False, max_queue_size=10000) -> MessageBus:
    """
    MessageBusä½œæˆé–¢æ•° - Phase 3å¯¾å¿œç‰ˆ
    
    Args:
        debug: ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
        max_queue_size: ã‚­ãƒ¥ãƒ¼æœ€å¤§ã‚µã‚¤ã‚º
        
    Returns:
        MessageBus: Phase 3å¯¾å¿œMessageBusã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    """
    try:
        bus = MessageBus(debug=debug, max_queue_size=max_queue_size)
        bus.start()
        
        logger.info("âœ… MessageBus Phase 3ç‰ˆ ä½œæˆãƒ»é–‹å§‹å®Œäº†")
        return bus
        
    except Exception as e:
        logger.error(f"âŒ MessageBusä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
        raise


# === ãƒ†ã‚¹ãƒˆé–¢æ•° ===

def test_message_bus():
    """MessageBus Phase 3å¯¾å¿œç‰ˆãƒ†ã‚¹ãƒˆ"""
    print("ğŸ§ª MessageBus Phase 3æ–‡å­—åˆ—ã‚¤ãƒ™ãƒ³ãƒˆè¨±å®¹ãƒ†ã‚¹ãƒˆé–‹å§‹")
    
    try:
        # MessageBusä½œæˆ
        bus = create_message_bus(debug=True)
        
        # ğŸ”¥ Phase 3: æ··åœ¨ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ãƒ†ã‚¹ãƒˆ
        test_events = {
            'string_event': 'test_string_event',  # ç”Ÿæ–‡å­—åˆ—
            'enum_value': MessagePriority.HIGH,   # Enum
            'object_with_name': type('TestEvent', (), {'name': 'test_object_event'})(),  # .nameå±æ€§
            'object_with_value': type('TestEvent', (), {'value': 'test_value_event'})(),  # .valueå±æ€§
            'plain_object': type('TestEvent', (), {})()  # ãã®ä»–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        }
        
        # ãƒ†ã‚¹ãƒˆç”¨è³¼èª­è€…
        received_messages = []
        
        def test_subscriber(data, sender):
            received_messages.append({
                'data': data,
                'sender': sender,
                'timestamp': datetime.now()
            })
            print(f"ğŸ“¨ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡: {data} from {sender}")
        
        # ğŸ”¥ Phase 3: å„ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã§è³¼èª­ãƒ»ç™ºè¡Œãƒ†ã‚¹ãƒˆ
        print("\n=== Phase 3 ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—æ··åœ¨ãƒ†ã‚¹ãƒˆ ===")
        
        for test_name, event in test_events.items():
            print(f"\n--- {test_name} ãƒ†ã‚¹ãƒˆ ---")
            
            # è³¼èª­
            bus.subscribe(event, test_subscriber)
            
            # ç™ºè¡Œ
            test_data = f"{test_name}_test_data"
            bus.publish(event, test_data, sender=f"{test_name}_sender")
            
            # å°‘ã—å¾…æ©Ÿï¼ˆéåŒæœŸå‡¦ç†ï¼‰
            time.sleep(0.1)
        
        # çµ±è¨ˆç¢ºèª
        print("\n=== çµ±è¨ˆç¢ºèª ===")
        stats = bus.get_stats()
        print(f"ğŸ“Š ç™ºè¡Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {stats['messages_published']}")
        print(f"ğŸ“Š å‡¦ç†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {stats['messages_processed']}")
        print(f"ğŸ“Š ã‚¨ãƒ©ãƒ¼æ•°: {stats['errors_occurred']}")
        print(f"ğŸ“Š å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {len(received_messages)}")
        
        # ğŸ”¥ Phase 3: æ–°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        print("\n=== Phase 3 æ–°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ===")
        
        # ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ
        bus.broadcast("ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", "broadcast_test")
        time.sleep(0.1)
        
        # é…å»¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ
        bus.publish_delayed("delayed_test", "é…å»¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", 0.5, sender="delay_test")
        
        # çŠ¶æ…‹ãƒ€ãƒ³ãƒ—
        state = bus.dump_state()
        print(f"ğŸ” è³¼èª­è€…æ•°: {state['stats']['subscriber_count']}")
        print(f"ğŸ” ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—æ•°: {state['stats']['event_types']}")
        
        # å°‘ã—å¾…æ©Ÿï¼ˆé…å»¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ï¼‰
        time.sleep(1.0)
        
        # æœ€çµ‚çµ±è¨ˆ
        final_stats = bus.get_stats()
        print(f"\nğŸ“Š æœ€çµ‚çµ±è¨ˆ:")
        print(f"  ç™ºè¡Œ: {final_stats['messages_published']}")
        print(f"  å‡¦ç†: {final_stats['messages_processed']}")
        print(f"  ã‚¨ãƒ©ãƒ¼: {final_stats['errors_occurred']}")
        print(f"  å—ä¿¡: {len(received_messages)}")
        
        # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        bus.cleanup()
        
        print("\nâœ… MessageBus Phase 3æ–‡å­—åˆ—ã‚¤ãƒ™ãƒ³ãƒˆè¨±å®¹ãƒ†ã‚¹ãƒˆå®Œäº†")
        print("ğŸ”¥ ä¸»ãªæˆæœ:")
        print("  âœ… æ–‡å­—åˆ—ã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œ")
        print("  âœ… Enumã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œ") 
        print("  âœ… ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œ")
        print("  âœ… 'str' object has no attribute 'name' ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ")
        print("  âœ… å¾Œæ–¹äº’æ›æ€§ä¿æŒ")
        
        return len(received_messages) > 0 and final_stats['errors_occurred'] == 0
        
    except Exception as e:
        print(f"âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
        print(f"âŒ è©³ç´°: {traceback.format_exc()}")
        return False


if __name__ == "__main__":
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    test_message_bus()
