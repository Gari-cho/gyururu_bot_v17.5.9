#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ® å†åˆ©ç”¨å¯èƒ½ãªSlideSwitch v17.0.0 - æ±ç”¨ç‰ˆ
è¤‡æ•°ã‚¿ãƒ–å¯¾å¿œãƒ»ãƒ†ãƒ¼ãƒè¨­å®šãƒ»å®Œå…¨ç‹¬ç«‹è¨­è¨ˆ
"""

import tkinter as tk
from tkinter import ttk
import threading
import time
from typing import Callable, Optional, Dict, Any

class SlideSwitch(tk.Frame):
    """
    å†åˆ©ç”¨å¯èƒ½ãªSlideSwitch ã‚¯ãƒ©ã‚¹
    
    ç‰¹å¾´:
    - å®Œå…¨ç‹¬ç«‹è¨­è¨ˆï¼ˆä»–ã®ã‚¯ãƒ©ã‚¹ã«ä¾å­˜ã—ãªã„ï¼‰
    - ãƒ†ãƒ¼ãƒè¨­å®šå¯¾å¿œ
    - è‡ªå‹•OFFæ©Ÿèƒ½å†…è”µ
    - è­¦å‘ŠçŠ¶æ…‹è¡¨ç¤º
    - è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¯¾å¿œ
    """
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒ
    DEFAULT_THEMES = {
        'default': {
            'bg_on': '#4CAF50',
            'bg_off': '#f44336', 
            'bg_disabled': '#bdc3c7',
            'bg_warning': '#ff9800',
            'text_on': 'ON',
            'text_off': 'OFF',
            'text_color': '#ffffff',
            'font_family': 'Yu Gothic UI',
            'font_size': 10,
            'font_weight': 'bold',
            'width': 60,
            'height': 30
        },
        'compact': {
            'bg_on': '#27ae60',
            'bg_off': '#e74c3c',
            'bg_disabled': '#95a5a6',
            'bg_warning': '#f39c12',
            'text_on': 'â—',
            'text_off': 'â—‹',
            'text_color': '#ffffff',
            'font_family': 'Arial',
            'font_size': 14,
            'font_weight': 'bold',
            'width': 40,
            'height': 25
        },
        'professional': {
            'bg_on': '#2ecc71',
            'bg_off': '#34495e',
            'bg_disabled': '#7f8c8d',
            'bg_warning': '#e67e22',
            'text_on': 'æœ‰åŠ¹',
            'text_off': 'ç„¡åŠ¹',
            'text_color': '#ffffff',
            'font_family': 'Meiryo',
            'font_size': 9,
            'font_weight': 'normal',
            'width': 70,
            'height': 28
        }
    }
    
    def __init__(self, parent, 
                 initial_value: bool = False,
                 callback: Optional[Callable[[bool], None]] = None,
                 theme: str = 'default',
                 custom_theme: Optional[Dict[str, Any]] = None,
                 service_key: Optional[str] = None,
                 **kwargs):
        """
        SlideSwitchåˆæœŸåŒ–
        
        Args:
            parent: è¦ªã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
            initial_value: åˆæœŸçŠ¶æ…‹
            callback: çŠ¶æ…‹å¤‰æ›´ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
            theme: ãƒ†ãƒ¼ãƒå ('default', 'compact', 'professional')
            custom_theme: ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒè¾æ›¸
            service_key: ã‚µãƒ¼ãƒ“ã‚¹è­˜åˆ¥ã‚­ãƒ¼ï¼ˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
            **kwargs: è¿½åŠ è¨­å®š
        """
        super().__init__(parent, **kwargs)
        
        # åŸºæœ¬è¨­å®š
        self.state = initial_value
        self.callback = callback
        self.service_key = service_key
        self.enabled = True
        self.warning_mode = False
        
        # ãƒ†ãƒ¼ãƒè¨­å®š
        self.theme = self._setup_theme(theme, custom_theme)
        
        # è‡ªå‹•OFFæ©Ÿèƒ½
        self._auto_off_timer = None
        self._auto_off_delay = 3000  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ç§’
        
        # æ¥ç¶šä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        self._connecting_animation = False
        self._animation_timer = None
        self._animation_state = 0
        
        # UIä½œæˆ
        self._create_ui()
        self._update_appearance()
    
    def _setup_theme(self, theme_name: str, custom_theme: Optional[Dict[str, Any]]) -> Dict[str, Any]:
        """ãƒ†ãƒ¼ãƒè¨­å®š"""
        if custom_theme:
            return custom_theme
        elif theme_name in self.DEFAULT_THEMES:
            return self.DEFAULT_THEMES[theme_name].copy()
        else:
            return self.DEFAULT_THEMES['default'].copy()
    
    def _create_ui(self):
        """UIä½œæˆ"""
        # ã‚¹ã‚¤ãƒƒãƒãƒœã‚¿ãƒ³
        self.switch_button = tk.Button(
            self,
            command=self._on_click,
            relief=tk.FLAT,
            bd=0,
            cursor='hand2'
        )
        self.switch_button.pack(expand=True, fill=tk.BOTH)
        
        # ã‚µã‚¤ã‚ºè¨­å®š
        self.configure(
            width=self.theme['width'],
            height=self.theme['height']
        )
    
    def _on_click(self):
        """ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ"""
        if not self.enabled:
            return
        
        # çŠ¶æ…‹åè»¢
        self.set_state(not self.state)
    
    def set_state(self, new_state: bool, trigger_callback: bool = True):
        """
        çŠ¶æ…‹è¨­å®š
        
        Args:
            new_state: æ–°ã—ã„çŠ¶æ…‹
            trigger_callback: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œãƒ•ãƒ©ã‚°
        """
        if self.state != new_state:
            self.state = new_state
            self._update_appearance()
            
            # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
            if trigger_callback and self.callback:
                try:
                    if self.service_key:
                        self.callback(self.service_key, new_state)
                    else:
                        self.callback(new_state)
                except Exception as e:
                    print(f"âŒ SlideSwitch ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: {e}")
    
    def get_state(self) -> bool:
        """çŠ¶æ…‹å–å¾—"""
        return self.state
    
    def set_enabled(self, enabled: bool):
        """æœ‰åŠ¹/ç„¡åŠ¹è¨­å®š"""
        self.enabled = enabled
        self._update_appearance()
    
    def is_enabled(self) -> bool:
        """æœ‰åŠ¹çŠ¶æ…‹å–å¾—"""
        return self.enabled
    
    def show_warning(self, warning: bool = True):
        """è­¦å‘ŠçŠ¶æ…‹è¡¨ç¤º"""
        self.warning_mode = warning
        self._update_appearance()
    
    def _update_appearance(self):
        """å¤–è¦³æ›´æ–°"""
        if not hasattr(self, 'switch_button'):
            return
        
        # è‰²ãƒ»ãƒ†ã‚­ã‚¹ãƒˆæ±ºå®š
        if not self.enabled:
            bg_color = self.theme['bg_disabled']
            text = self.theme['text_off']
        elif self.warning_mode:
            bg_color = self.theme['bg_warning']
            text = 'âš ï¸'
        elif self.state:
            bg_color = self.theme['bg_on']
            text = self.theme['text_on']
        else:
            bg_color = self.theme['bg_off']
            text = self.theme['text_off']
        
        # å¤–è¦³é©ç”¨
        self.switch_button.configure(
            bg=bg_color,
            activebackground=bg_color,
            fg=self.theme['text_color'],
            activeforeground=self.theme['text_color'],
            text=text,
            font=(
                self.theme['font_family'],
                self.theme['font_size'],
                self.theme['font_weight']
            )
        )
    
    # === è‡ªå‹•OFFæ©Ÿèƒ½ ===
    
    def auto_off(self, delay_ms: int = 3000):
        """
        è‡ªå‹•OFFè¨­å®š
        
        Args:
            delay_ms: é…å»¶æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
        """
        self._auto_off_delay = delay_ms
        self._start_auto_off_timer()
    
    def _start_auto_off_timer(self):
        """è‡ªå‹•OFFã‚¿ã‚¤ãƒãƒ¼é–‹å§‹"""
        self.cancel_auto_off()  # æ—¢å­˜ã‚¿ã‚¤ãƒãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        
        self._auto_off_timer = self.after(
            self._auto_off_delay,
            self._execute_auto_off
        )
        
        # è­¦å‘ŠçŠ¶æ…‹è¡¨ç¤º
        self.show_warning(True)
    
    def _execute_auto_off(self):
        """è‡ªå‹•OFFå®Ÿè¡Œ"""
        self.set_state(False)
        self.show_warning(False)
        self._auto_off_timer = None
    
    def cancel_auto_off(self):
        """è‡ªå‹•OFFã‚­ãƒ£ãƒ³ã‚»ãƒ«"""
        if self._auto_off_timer:
            self.after_cancel(self._auto_off_timer)
            self._auto_off_timer = None
        
        self.show_warning(False)
    
    # === æ¥ç¶šä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ===
    
    def set_connecting_state(self, connecting: bool = True):
        """æ¥ç¶šä¸­çŠ¶æ…‹è¨­å®š"""
        if connecting:
            self._start_connecting_animation()
        else:
            self._stop_connecting_animation()
    
    def _start_connecting_animation(self):
        """æ¥ç¶šä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹"""
        self._connecting_animation = True
        self._animation_state = 0
        self._animate_connecting()
    
    def _animate_connecting(self):
        """æ¥ç¶šä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ"""
        if not self._connecting_animation:
            return
        
        # ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹æ›´æ–°
        self._animation_state = (self._animation_state + 1) % 4
        animation_chars = ['âŸ³', 'âŸ²', 'âŸ³', 'âŸ²']
        
        # è¡¨ç¤ºæ›´æ–°
        if hasattr(self, 'switch_button'):
            self.switch_button.configure(
                text=animation_chars[self._animation_state],
                bg=self.theme['bg_warning']
            )
        
        # æ¬¡å›ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        self._animation_timer = self.after(500, self._animate_connecting)
    
    def _stop_connecting_animation(self):
        """æ¥ç¶šä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢"""
        self._connecting_animation = False
        
        if self._animation_timer:
            self.after_cancel(self._animation_timer)
            self._animation_timer = None
        
        # é€šå¸¸è¡¨ç¤ºã«æˆ»ã™
        self._update_appearance()
    
    def stop_connecting_animation(self):
        """å¤–éƒ¨ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢"""
        self._stop_connecting_animation()
    
    # === ãƒ†ãƒ¼ãƒå¤‰æ›´ ===
    
    def change_theme(self, theme_name: str = None, custom_theme: Dict[str, Any] = None):
        """ãƒ†ãƒ¼ãƒå¤‰æ›´"""
        self.theme = self._setup_theme(theme_name or 'default', custom_theme)
        
        # ã‚µã‚¤ã‚ºæ›´æ–°
        self.configure(
            width=self.theme['width'],
            height=self.theme['height']
        )
        
        # å¤–è¦³æ›´æ–°
        self._update_appearance()
    
    # === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
    
    def get_info(self) -> Dict[str, Any]:
        """SlideSwitchæƒ…å ±å–å¾—"""
        return {
            'state': self.state,
            'enabled': self.enabled,
            'warning_mode': self.warning_mode,
            'service_key': self.service_key,
            'theme': self.theme.get('name', 'custom'),
            'auto_off_active': self._auto_off_timer is not None,
            'connecting_animation': self._connecting_animation
        }
    
    def reset(self):
        """çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ"""
        self.cancel_auto_off()
        self._stop_connecting_animation()
        self.show_warning(False)
        self.set_enabled(True)
        self.set_state(False, trigger_callback=False)
    
    # === ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ===
    
    def cleanup(self):
        """ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"""
        self.cancel_auto_off()
        self._stop_connecting_animation()
        self.callback = None


# === æ±ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ===

def create_slide_switch(parent, service_key: str = None, initial_state: bool = False, 
                       callback: Callable = None, theme: str = 'default', **kwargs) -> SlideSwitch:
    """
    SlideSwitchä½œæˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆå¾“æ¥äº’æ›æ€§ï¼‰
    """
    return SlideSwitch(
        parent=parent,
        initial_value=initial_state,
        callback=callback,
        theme=theme,
        service_key=service_key,
        **kwargs
    )


def create_themed_slide_switch(parent, theme_config: Dict[str, Any], **kwargs) -> SlideSwitch:
    """
    ãƒ†ãƒ¼ãƒæŒ‡å®šSlideSwitchä½œæˆ
    """
    return SlideSwitch(
        parent=parent,
        custom_theme=theme_config,
        **kwargs
    )


# === AutoConnectionManagerï¼ˆçµ±åˆç‰ˆï¼‰ ===

class AutoConnectionManager:
    """
    è‡ªå‹•æ¥ç¶šç®¡ç†ï¼ˆSlideSwitchçµ±åˆç‰ˆï¼‰
    """
    
    def __init__(self):
        self.connection_callback = None
        self.active_connections = {}
    
    def set_connection_callback(self, callback: Callable[[str], bool]):
        """æ¥ç¶šãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š"""
        self.connection_callback = callback
    
    def start_auto_connection(self, slide_switch: SlideSwitch, service_key: str):
        """è‡ªå‹•æ¥ç¶šé–‹å§‹"""
        if not self.connection_callback:
            print(f"âš ï¸ {service_key}: æ¥ç¶šã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æœªè¨­å®š")
            return
        
        # æ¥ç¶šä¸­è¡¨ç¤ºé–‹å§‹
        slide_switch.set_connecting_state(True)
        
        # éåŒæœŸã§æ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        def test_connection():
            try:
                success = self.connection_callback(service_key)
                
                # ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§çµæœå‡¦ç†
                slide_switch.after(0, lambda: self._handle_connection_result(
                    slide_switch, service_key, success
                ))
                
            except Exception as e:
                print(f"âŒ {service_key} æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
                slide_switch.after(0, lambda: self._handle_connection_result(
                    slide_switch, service_key, False
                ))
        
        # åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
        threading.Thread(target=test_connection, daemon=True).start()
    
    def _handle_connection_result(self, slide_switch: SlideSwitch, service_key: str, success: bool):
        """æ¥ç¶šçµæœå‡¦ç†"""
        slide_switch.stop_connecting_animation()
        
        if success:
            print(f"âœ… {service_key} æ¥ç¶šæˆåŠŸ")
        else:
            print(f"âŒ {service_key} æ¥ç¶šå¤±æ•— - 3ç§’å¾Œè‡ªå‹•OFF")
            slide_switch.auto_off(3000)


# === çµ±åˆåˆ¶å¾¡é–¢æ•°ï¼ˆæ–°ç‰ˆPhase2ï¼‰ ===

def set_slide_switch_state(slide_switch: SlideSwitch, state: bool, 
                          log_widget=None, message: str = ""):
    """
    SlideSwitchçµ±åˆåˆ¶å¾¡é–¢æ•°
    
    Args:
        slide_switch: SlideSwitchã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        state: è¨­å®šçŠ¶æ…‹
        log_widget: ãƒ­ã‚°ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        message: ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    """
    try:
        slide_switch.set_state(state)
        
        if log_widget and message:
            timestamp = time.strftime("%H:%M:%S")
            log_message = f"[{timestamp}] {message}\n"
            log_widget.insert(tk.END, log_message)
            log_widget.see(tk.END)
            
    except Exception as e:
        print(f"âŒ SlideSwitchåˆ¶å¾¡ã‚¨ãƒ©ãƒ¼: {e}")


# === ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ¢ç”¨ï¼ˆåˆ†é›¢ï¼‰ ===

def run_slideswitch_demo():
    """SlideSwitch ãƒ‡ãƒ¢å®Ÿè¡Œ"""
    print("ğŸ§ª SlideSwitch æ±ç”¨ç‰ˆãƒ‡ãƒ¢é–‹å§‹")
    
    root = tk.Tk()
    root.title("SlideSwitch æ±ç”¨ç‰ˆãƒ‡ãƒ¢")
    root.geometry("600x400")
    
    # ãƒ‡ãƒ¢ç”¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    def demo_callback(service_key, state):
        print(f"ğŸ”„ {service_key}: {state}")
    
    # è¤‡æ•°ãƒ†ãƒ¼ãƒã®SlideSwitchä½œæˆ
    themes = ['default', 'compact', 'professional']
    switches = {}
    
    for i, theme in enumerate(themes):
        frame = tk.LabelFrame(root, text=f"{theme.capitalize()} Theme")
        frame.pack(fill=tk.X, padx=10, pady=5)
        
        # ã‚µãƒ¼ãƒ“ã‚¹ä¾‹
        services = ['onecomme', 'messagebus', 'voicevox']
        for j, service in enumerate(services):
            service_frame = tk.Frame(frame)
            service_frame.pack(side=tk.LEFT, padx=10, pady=10)
            
            tk.Label(service_frame, text=service).pack()
            
            switch = SlideSwitch(
                service_frame,
                initial_value=j % 2 == 0,  # äº¤äº’ã«ON/OFF
                callback=demo_callback,
                theme=theme,
                service_key=service
            )
            switch.pack(pady=5)
            
            switches[f"{theme}_{service}"] = switch
    
    # ãƒ†ã‚¹ãƒˆç”¨ãƒœã‚¿ãƒ³
    test_frame = tk.Frame(root)
    test_frame.pack(pady=20)
    
    def test_auto_off():
        for switch in switches.values():
            if switch.get_state():
                switch.auto_off(2000)  # 2ç§’å¾Œè‡ªå‹•OFF
    
    def test_connecting():
        for switch in switches.values():
            switch.set_connecting_state(True)
            switch.after(3000, lambda s=switch: s.stop_connecting_animation())
    
    tk.Button(test_frame, text="ğŸš¨ è‡ªå‹•OFFãƒ†ã‚¹ãƒˆ", command=test_auto_off).pack(side=tk.LEFT, padx=5)
    tk.Button(test_frame, text="ğŸ”„ æ¥ç¶šä¸­ãƒ†ã‚¹ãƒˆ", command=test_connecting).pack(side=tk.LEFT, padx=5)
    
    root.mainloop()


if __name__ == "__main__":
    # ãƒ‡ãƒ¢å®Ÿè¡Œ
    run_slideswitch_demo()
