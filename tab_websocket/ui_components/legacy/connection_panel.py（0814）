# connection_panel.py - å¥‘ç´„çµ±ä¸€å¯¾å¿œç‰ˆ
"""
ãã‚…ã‚‹ã‚‹ãƒœãƒƒãƒˆ v16 Phase3 - æ¥ç¶šåˆ¶å¾¡ãƒ‘ãƒãƒ«ï¼ˆå¥‘ç´„çµ±ä¸€ç‰ˆï¼‰

ğŸ”§ Phase3 æ”¹å–„ç‚¹:
âœ… shared.contracts çµ±ä¸€ä½¿ç”¨
âœ… ServiceStateãƒ»æ­£è¦åŒ–é–¢æ•°ã®é‡è¤‡å‰Šé™¤
âœ… 'dict' object has no attribute ã‚¨ãƒ©ãƒ¼å®Œå…¨è§£æ¶ˆ
âœ… UIã«å°‚å¿µï¼ˆæ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯ã¯å§”è­²ï¼‰

Author: Claude & ãƒ¦ãƒ¼ã‚¶ãƒ¼
Version: 16.3.0
License: MIT
"""

import tkinter as tk
from tkinter import ttk
import logging
from typing import Dict, Any, Optional, Callable

# ğŸ¯ çµ±ä¸€ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆshared.event_types ä½¿ç”¨ï¼‰
try:
    from shared.contracts import (
        ServiceState, 
        normalize_service, 
        normalize_services_dict,
        safe_service_update,
        get_service_summary,
        ServiceKeys
    )
    from shared.message_bus import MessageBus
    from shared.event_types import Events
except ImportError:
    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›¸å¯¾ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    try:
        from .shared.contracts import (
            ServiceState, 
            normalize_service, 
            normalize_services_dict,
            safe_service_update,
            get_service_summary,
            ServiceKeys
        )
        from .shared.message_bus import MessageBus
        from .shared.event_types import Events
    except ImportError:
        # æœ€å¾Œã®ç ¦: ãƒ­ãƒ¼ã‚«ãƒ«å®šç¾©ï¼ˆæœ¬ç•ªã§ã¯å‰Šé™¤äºˆå®šï¼‰
        from dataclasses import dataclass, field
        from typing import Dict, Any, Optional
        
        @dataclass
        class ServiceState:
            key: str
            enabled: bool = False
            connected: bool = False
            name: Optional[str] = None
            meta: Dict[str, Any] = field(default_factory=dict)
            
            def update_state(self, *, enabled: Optional[bool] = None, 
                           connected: Optional[bool] = None, **kwargs):
                if enabled is not None: self.enabled = bool(enabled)
                if connected is not None: self.connected = bool(connected)
                if kwargs: self.meta.update(kwargs)
        
        def normalize_service(key: str, raw: Any) -> ServiceState:
            if isinstance(raw, ServiceState): return raw
            if isinstance(raw, dict):
                return ServiceState(
                    key=key,
                    enabled=bool(raw.get("enabled", False)),
                    connected=bool(raw.get("connected", False)),
                    name=str(raw.get("name", key))
                )
            return ServiceState(key=key, enabled=False, connected=False, name=key)
        
        # åŸºæœ¬Eventså®šç¾©
        class Events:
            CONNECTION_STATUS_CHANGED = "connection_status_changed"
            SERVICE_ERROR = "service_error"

try:
    from .slide_switch import SlideSwitch
except ImportError:
    from slide_switch import SlideSwitch

logger = logging.getLogger(__name__)

class ConnectionControlPanel(ttk.Frame):
    """
    æ¥ç¶šåˆ¶å¾¡ãƒ‘ãƒãƒ«ï¼ˆå¥‘ç´„çµ±ä¸€ç‰ˆï¼‰
    
    ğŸ¯ è²¬å‹™:
    - ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ã®è¡¨ç¤ºã®ã¿
    - ã‚¹ã‚¤ãƒƒãƒUIæä¾›
    - ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ï¼ˆå®Ÿéš›ã®æ¥ç¶šå‡¦ç†ã¯å§”è­²ï¼‰
    """
    
    def __init__(self, parent, message_bus: MessageBus, service_registry=None):
        super().__init__(parent)
        
        self.message_bus = message_bus
        self.service_registry = service_registry
        
        # ğŸ—ï¸ ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç®¡ç†ï¼ˆçµ±ä¸€å¥‘ç´„ä½¿ç”¨ï¼‰
        self.services: Dict[str, ServiceState] = {}
        
        # UIè¦ç´ 
        self.service_switches: Dict[str, SlideSwitch] = {}
        self.status_labels: Dict[str, ttk.Label] = {}
        self.summary_var = tk.StringVar()
        
        # ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        self._connection_callbacks: Dict[str, Callable] = {}
        
        # UIæ§‹ç¯‰
        self._setup_ui()
        self._setup_event_handlers()
        
        logger.info("ğŸ›ï¸ ConnectionControlPanel åˆæœŸåŒ–å®Œäº†")
    
    def _setup_ui(self):
        """UIæ§‹ç¯‰"""
        # ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ 
        main_frame = ttk.LabelFrame(self, text="ğŸ”Œ æ¥ç¶šåˆ¶å¾¡", padding=10)
        main_frame.pack(fill=tk.BOTH, expand=True)
        
        # ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        summary_frame = ttk.Frame(main_frame)
        summary_frame.pack(fill=tk.X, pady=(0, 10))
        
        ttk.Label(summary_frame, text="ğŸ“Š çŠ¶æ…‹ã‚µãƒãƒªãƒ¼:").pack(side=tk.LEFT)
        ttk.Label(summary_frame, textvariable=self.summary_var).pack(side=tk.LEFT, padx=(5, 0))
        
        # ã‚µãƒ¼ãƒ“ã‚¹åˆ¶å¾¡ã‚¨ãƒªã‚¢
        self.services_frame = ttk.Frame(main_frame)
        self.services_frame.pack(fill=tk.BOTH, expand=True)
        
        # åˆæœŸã‚µãƒ¼ãƒ“ã‚¹ä½œæˆ
        self._create_default_services()
    
    def _create_default_services(self):
        """ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆ"""
        default_services = {
            ServiceKeys.WEBSOCKET: {
                "name": "WebSocket",
                "enabled": False,
                "connected": False
            },
            ServiceKeys.MQTT: {
                "name": "MQTT",
                "enabled": False,
                "connected": False
            }
        }
        
        self.update_services(default_services)
    
    def _setup_event_handlers(self):
        """ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®š"""
        if self.message_bus:
            # ğŸ¯ çµ±ä¸€å¥‘ç´„å¯¾å¿œã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
            self.message_bus.subscribe(
                Events.CONNECTION_STATUS_CHANGED, 
                self._on_connection_status_changed,
                "ConnectionControlPanel"
            )
            self.message_bus.subscribe(
                Events.SERVICE_ERROR,
                self._on_service_error,
                "ConnectionControlPanel"
            )
    
    def update_services(self, services: Dict[str, Any]):
        """
        ğŸ”§ ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹æ›´æ–°ï¼ˆçµ±ä¸€å¥‘ç´„ç‰ˆï¼‰
        
        Args:
            services: ç”Ÿã‚µãƒ¼ãƒ“ã‚¹è¾æ›¸ï¼ˆdict/ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ··åœ¨OKï¼‰
        """
        try:
            # ğŸ¯ çµ±ä¸€æ­£è¦åŒ–å‡¦ç†
            normalized_services = normalize_services_dict(services)
            
            # æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ã¨çµ±åˆ
            for key, service_state in normalized_services.items():
                if key in self.services:
                    # æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ã®æ›´æ–°
                    existing = self.services[key]
                    existing.enabled = service_state.enabled
                    existing.connected = service_state.connected
                    existing.meta.update(service_state.meta)
                else:
                    # æ–°è¦ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ 
                    self.services[key] = service_state
                    self._create_service_ui(key, service_state)
            
            # UIæ›´æ–°
            self._update_ui()
            
            logger.debug(f"ğŸ”„ ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹æ›´æ–°å®Œäº†: {len(normalized_services)}ä»¶")
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _create_service_ui(self, service_key: str, service: ServiceState):
        """å€‹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹UIä½œæˆ"""
        try:
            # ã‚µãƒ¼ãƒ“ã‚¹è¡Œãƒ•ãƒ¬ãƒ¼ãƒ 
            service_frame = ttk.Frame(self.services_frame)
            service_frame.pack(fill=tk.X, pady=2)
            
            # ã‚µãƒ¼ãƒ“ã‚¹å
            name_label = ttk.Label(
                service_frame, 
                text=f"{service.name or service_key}:",
                width=15
            )
            name_label.pack(side=tk.LEFT, padx=(0, 10))
            
            # ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¹ã‚¤ãƒƒãƒ
            switch = SlideSwitch(
                service_frame,
                initial_state=service.enabled,
                callback=lambda state, key=service_key: self._on_switch_changed(key, state)
            )
            switch.pack(side=tk.LEFT, padx=(0, 10))
            self.service_switches[service_key] = switch
            
            # çŠ¶æ…‹ãƒ©ãƒ™ãƒ«
            status_label = ttk.Label(service_frame, text="")
            status_label.pack(side=tk.LEFT, padx=(0, 10))
            self.status_labels[service_key] = status_label
            
            logger.debug(f"ğŸ¨ ã‚µãƒ¼ãƒ“ã‚¹UIä½œæˆ: {service_key}")
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹UIä½œæˆã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
    
    def _update_ui(self):
        """UIçŠ¶æ…‹æ›´æ–°"""
        try:
            # å„ã‚µãƒ¼ãƒ“ã‚¹UIæ›´æ–°
            for key, service in self.services.items():
                # ã‚¹ã‚¤ãƒƒãƒçŠ¶æ…‹æ›´æ–°
                if key in self.service_switches:
                    switch = self.service_switches[key]
                    switch.set_state(service.enabled)
                
                # çŠ¶æ…‹ãƒ©ãƒ™ãƒ«æ›´æ–°
                if key in self.status_labels:
                    label = self.status_labels[key]
                    status_text, color = self._get_status_display(service)
                    label.config(text=status_text, foreground=color)
            
            # ã‚µãƒãƒªãƒ¼æ›´æ–°
            self._update_summary()
            
        except Exception as e:
            logger.error(f"âŒ UIæ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _get_status_display(self, service: ServiceState) -> tuple[str, str]:
        """çŠ¶æ…‹è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã¨è‰²ã‚’å–å¾—"""
        if service.connected:
            return "ğŸŸ¢ æ¥ç¶šä¸­", "green"
        elif service.enabled:
            return "ğŸŸ¡ æ¥ç¶šå¾…æ©Ÿ", "orange"
        else:
            return "ğŸ”´ ç„¡åŠ¹", "red"
    
    def _update_summary(self):
        """ã‚µãƒãƒªãƒ¼è¡¨ç¤ºæ›´æ–°"""
        try:
            # ğŸ¯ çµ±ä¸€å¥‘ç´„ã®ã‚µãƒãƒªãƒ¼é–¢æ•°ä½¿ç”¨
            summary = get_service_summary(self.services)
            
            summary_text = (
                f"å…¨ä½“: {summary['total_services']}ä»¶ | "
                f"æœ‰åŠ¹: {summary['enabled_services']}ä»¶ | "
                f"æ¥ç¶šä¸­: {summary['connected_services']}ä»¶ | "
                f"å¥åº·åº¦: {summary['health_percentage']:.0f}%"
            )
            
            self.summary_var.set(summary_text)
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒãƒªãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
            self.summary_var.set("âŒ ã‚µãƒãƒªãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼")
    
    def _on_switch_changed(self, service_key: str, enabled: bool):
        """ã‚¹ã‚¤ãƒƒãƒå¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©ãƒ¼"""
        try:
            logger.info(f"ğŸ”„ ã‚¹ã‚¤ãƒƒãƒå¤‰æ›´: {service_key} -> {'æœ‰åŠ¹' if enabled else 'ç„¡åŠ¹'}")
            
            # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹æ›´æ–°
            if service_key in self.services:
                self.services[service_key].enabled = enabled
                # ç„¡åŠ¹åŒ–æ™‚ã¯æ¥ç¶šã‚‚åˆ‡æ–­
                if not enabled:
                    self.services[service_key].connected = False
            
            # ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ï¼ˆå®Ÿéš›ã®æ¥ç¶šå‡¦ç†ã¯ä»–ã§å®Ÿè¡Œï¼‰
            if self.message_bus:
                self.message_bus.publish(
                    Events.CONNECTION_STATUS_CHANGED,
                    {
                        'service': service_key,
                        'enabled': enabled,
                        'action': 'enable' if enabled else 'disable'
                    },
                    sender="ConnectionControlPanel"
                )
            
            # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
            if service_key in self._connection_callbacks:
                try:
                    self._connection_callbacks[service_key](service_key, enabled)
                except Exception as e:
                    logger.error(f"âŒ ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
            
            # UIæ›´æ–°
            self._update_ui()
            
        except Exception as e:
            logger.error(f"âŒ ã‚¹ã‚¤ãƒƒãƒå¤‰æ›´å‡¦ç†ã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
    
    def _on_connection_status_changed(self, data: Dict[str, Any], sender: str):
        """æ¥ç¶šçŠ¶æ…‹å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼"""
        try:
            service_key = data.get('service')
            if not service_key or service_key not in self.services:
                return
            
            # ğŸ¯ çµ±ä¸€å¥‘ç´„ã«ã‚ˆã‚‹å®‰å…¨ãªæ›´æ–°
            service = self.services[service_key]
            safe_service_update(service, data)
            
            # UIæ›´æ–°
            self.after_idle(self._update_ui)
            
            logger.debug(f"ğŸ“¡ æ¥ç¶šçŠ¶æ…‹å¤‰æ›´å—ä¿¡: {service_key} from {sender}")
            
        except Exception as e:
            logger.error(f"âŒ æ¥ç¶šçŠ¶æ…‹å¤‰æ›´å‡¦ç†ã‚¨ãƒ©ãƒ¼: {e}")
    
    def _on_service_error(self, data: Dict[str, Any], sender: str):
        """ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼"""
        try:
            service_key = data.get('service')
            error_message = data.get('error', 'Unknown error')
            
            logger.warning(f"âš ï¸ ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼å—ä¿¡: {service_key} - {error_message}")
            
            # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¹ã‚¤ãƒƒãƒã‚’ç„¡åŠ¹åŒ–
            if service_key in self.services:
                self.services[service_key].enabled = False
                self.services[service_key].connected = False
                self.services[service_key].meta['last_error'] = error_message
                self.after_idle(self._update_ui)
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚¨ãƒ©ãƒ¼: {e}")
    
    def set_connection_callback(self, service_key: str, callback: Callable[[str, bool], None]):
        """
        æ¥ç¶šã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
        
        Args:
            service_key: ã‚µãƒ¼ãƒ“ã‚¹ã‚­ãƒ¼
            callback: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•° (service_key, enabled) ã‚’å—ã‘å–ã‚‹
        """
        self._connection_callbacks[service_key] = callback
        logger.debug(f"ğŸ”— ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š: {service_key}")
    
    def get_service_state(self, service_key: str) -> Optional[ServiceState]:
        """
        ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹å–å¾—
        
        Args:
            service_key: ã‚µãƒ¼ãƒ“ã‚¹ã‚­ãƒ¼
            
        Returns:
            ServiceState: ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯Noneï¼‰
        """
        return self.services.get(service_key)
    
    def get_all_services(self) -> Dict[str, ServiceState]:
        """å…¨ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹å–å¾—"""
        return self.services.copy()
    
    def set_service_enabled(self, service_key: str, enabled: bool):
        """
        ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹æœ‰åŠ¹/ç„¡åŠ¹è¨­å®š
        
        Args:
            service_key: ã‚µãƒ¼ãƒ“ã‚¹ã‚­ãƒ¼
            enabled: æœ‰åŠ¹ãƒ•ãƒ©ã‚°
        """
        try:
            if service_key in self.services:
                self.services[service_key].enabled = enabled
                
                # ã‚¹ã‚¤ãƒƒãƒUIæ›´æ–°
                if service_key in self.service_switches:
                    self.service_switches[service_key].set_state(enabled)
                
                self._update_ui()
                logger.info(f"ğŸ“ ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¨­å®š: {service_key} -> {'æœ‰åŠ¹' if enabled else 'ç„¡åŠ¹'}")
            else:
                logger.warning(f"âš ï¸ å­˜åœ¨ã—ãªã„ã‚µãƒ¼ãƒ“ã‚¹: {service_key}")
                
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
    
    def set_service_connected(self, service_key: str, connected: bool):
        """
        ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰ã®æ¥ç¶šçŠ¶æ…‹è¨­å®š
        
        Args:
            service_key: ã‚µãƒ¼ãƒ“ã‚¹ã‚­ãƒ¼
            connected: æ¥ç¶šãƒ•ãƒ©ã‚°
        """
        try:
            if service_key in self.services:
                self.services[service_key].connected = connected
                self._update_ui()
                logger.debug(f"ğŸ”Œ æ¥ç¶šçŠ¶æ…‹è¨­å®š: {service_key} -> {'æ¥ç¶š' if connected else 'åˆ‡æ–­'}")
            else:
                logger.warning(f"âš ï¸ å­˜åœ¨ã—ãªã„ã‚µãƒ¼ãƒ“ã‚¹: {service_key}")
                
        except Exception as e:
            logger.error(f"âŒ æ¥ç¶šçŠ¶æ…‹è¨­å®šã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
    
    def add_service(self, service_key: str, service_data: Dict[str, Any]):
        """
        å‹•çš„ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ 
        
        Args:
            service_key: ã‚µãƒ¼ãƒ“ã‚¹ã‚­ãƒ¼
            service_data: ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ãƒ¼ã‚¿
        """
        try:
            # ğŸ¯ çµ±ä¸€æ­£è¦åŒ–
            service_state = normalize_service(service_key, service_data)
            self.services[service_key] = service_state
            
            # UIä½œæˆ
            self._create_service_ui(service_key, service_state)
            self._update_ui()
            
            logger.info(f"â• ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ : {service_key}")
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ ã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
    
    def remove_service(self, service_key: str):
        """
        ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤
        
        Args:
            service_key: ã‚µãƒ¼ãƒ“ã‚¹ã‚­ãƒ¼
        """
        try:
            if service_key in self.services:
                # ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                del self.services[service_key]
                
                # UIå‰Šé™¤
                if service_key in self.service_switches:
                    self.service_switches[service_key].destroy()
                    del self.service_switches[service_key]
                
                if service_key in self.status_labels:
                    self.status_labels[service_key].destroy()
                    del self.status_labels[service_key]
                
                # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‰Šé™¤
                if service_key in self._connection_callbacks:
                    del self._connection_callbacks[service_key]
                
                self._update_ui()
                logger.info(f"â– ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤: {service_key}")
            else:
                logger.warning(f"âš ï¸ å‰Šé™¤å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“: {service_key}")
                
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤ã‚¨ãƒ©ãƒ¼ ({service_key}): {e}")
    
    def refresh_from_registry(self):
        """
        ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‹ã‚‰çŠ¶æ…‹ã‚’å†èª­ã¿è¾¼ã¿
        """
        try:
            if not self.service_registry:
                logger.warning("âš ï¸ ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
                return
            
            # ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§å–å¾—
            registered_services = self.service_registry.get_all_services()
            
            # å„ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
            for service_key, service_obj in registered_services.items():
                service_data = {
                    'enabled': getattr(service_obj, 'enabled', False),
                    'connected': getattr(service_obj, 'connected', False),
                    'name': getattr(service_obj, 'name', service_key)
                }
                
                if service_key in self.services:
                    # æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°
                    service_state = self.services[service_key]
                    safe_service_update(service_state, service_data)
                else:
                    # æ–°è¦ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ 
                    self.add_service(service_key, service_data)
            
            self._update_ui()
            logger.info("ğŸ”„ ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‹ã‚‰çŠ¶æ…‹æ›´æ–°å®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ ãƒ¬ã‚¸ã‚¹ãƒˆãƒªæ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
    
    def get_health_status(self) -> Dict[str, Any]:
        """
        ãƒ‘ãƒãƒ«å…¨ä½“ã®å¥åº·çŠ¶æ…‹å–å¾—
        
        Returns:
            Dict[str, Any]: å¥åº·çŠ¶æ…‹æƒ…å ±
        """
        try:
            # ğŸ¯ çµ±ä¸€å¥‘ç´„ã®ã‚µãƒãƒªãƒ¼é–¢æ•°ä½¿ç”¨
            summary = get_service_summary(self.services)
            
            # è¿½åŠ ã®å¥åº·æƒ…å ±
            health_info = {
                **summary,
                'panel_status': 'healthy',
                'ui_elements': {
                    'switches': len(self.service_switches),
                    'labels': len(self.status_labels),
                    'callbacks': len(self._connection_callbacks)
                },
                'timestamp': time.time()
            }
            
            return health_info
            
        except Exception as e:
            logger.error(f"âŒ å¥åº·çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return {
                'panel_status': 'error',
                'error': str(e),
                'timestamp': time.time()
            }
    
    def reset_all_services(self):
        """å…¨ã‚µãƒ¼ãƒ“ã‚¹ãƒªã‚»ãƒƒãƒˆ"""
        try:
            for service_key in list(self.services.keys()):
                self.services[service_key].enabled = False
                self.services[service_key].connected = False
                self.services[service_key].meta.clear()
            
            self._update_ui()
            logger.info("ğŸ”„ å…¨ã‚µãƒ¼ãƒ“ã‚¹ãƒªã‚»ãƒƒãƒˆå®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ ã‚µãƒ¼ãƒ“ã‚¹ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def export_config(self) -> Dict[str, Any]:
        """è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"""
        try:
            config = {}
            for key, service in self.services.items():
                config[key] = service.to_dict()
            
            return {
                'services': config,
                'timestamp': time.time(),
                'version': '16.3.0'
            }
            
        except Exception as e:
            logger.error(f"âŒ è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
            return {}
    
    def import_config(self, config: Dict[str, Any]):
        """è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ"""
        try:
            if 'services' not in config:
                logger.warning("âš ï¸ ä¸æ­£ãªè¨­å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ")
                return
            
            services_config = config['services']
            self.update_services(services_config)
            
            logger.info(f"ğŸ“¥ è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†: {len(services_config)}ä»¶")
            
        except Exception as e:
            logger.error(f"âŒ è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
    
    def destroy(self):
        """ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾"""
        try:
            # ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­è§£é™¤
            if self.message_bus:
                self.message_bus.unsubscribe(
                    Events.CONNECTION_STATUS_CHANGED,
                    self._on_connection_status_changed,
                    "ConnectionControlPanel"
                )
                self.message_bus.unsubscribe(
                    Events.SERVICE_ERROR,
                    self._on_service_error,
                    "ConnectionControlPanel"
                )
            
            # UIè¦ç´ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            self.service_switches.clear()
            self.status_labels.clear()
            self._connection_callbacks.clear()
            
            # è¦ªã‚¯ãƒ©ã‚¹ã® destroy
            super().destroy()
            
            logger.info("ğŸ—‘ï¸ ConnectionControlPanel ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾å®Œäº†")
            
        except Exception as e:
            logger.error(f"âŒ ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾ã‚¨ãƒ©ãƒ¼: {e}")


# ğŸš€ ä¾¿åˆ©ãªä½œæˆé–¢æ•°
def create_connection_panel(parent, message_bus: MessageBus, 
                          service_registry=None, **kwargs) -> ConnectionControlPanel:
    """
    ConnectionControlPanelä½œæˆä¾¿åˆ©é–¢æ•°
    
    Args:
        parent: è¦ªã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
        message_bus: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚¹
        service_registry: ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒª
        **kwargs: è¿½åŠ å¼•æ•°
        
    Returns:
        ConnectionControlPanel: ä½œæˆã•ã‚ŒãŸãƒ‘ãƒãƒ«
    """
    return ConnectionControlPanel(parent, message_bus, service_registry, **kwargs)


if __name__ == "__main__":
    # ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    import time
    from shared.message_bus import start_message_bus
    
    def test_callback(service_key: str, enabled: bool):
        print(f"ğŸ”— ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: {service_key} -> {'æœ‰åŠ¹' if enabled else 'ç„¡åŠ¹'}")
    
    # ãƒ†ã‚¹ãƒˆç”¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
    root = tk.Tk()
    root.title("ConnectionControlPanel ãƒ†ã‚¹ãƒˆ")
    root.geometry("600x400")
    
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚¹é–‹å§‹
    from shared.message_bus import start_message_bus
    bus = start_message_bus(debug_mode=True)
    
    # ãƒ‘ãƒãƒ«ä½œæˆ
    panel = ConnectionControlPanel(root, bus)
    panel.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
    
    # ãƒ†ã‚¹ãƒˆã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ 
    test_services = {
        'websocket': {'name': 'WebSocket', 'enabled': True, 'connected': False},
        'mqtt': {'name': 'MQTT', 'enabled': False, 'connected': False},
        'voice': {'name': 'éŸ³å£°', 'enabled': True, 'connected': True}
    }
    
    panel.update_services(test_services)
    
    # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
    for key in test_services.keys():
        panel.set_connection_callback(key, test_callback)
    
    # å¥åº·çŠ¶æ…‹è¡¨ç¤º
    def show_health():
        health = panel.get_health_status()
        print(f"ğŸ¥ å¥åº·çŠ¶æ…‹: {health}")
        root.after(5000, show_health)  # 5ç§’ã”ã¨ã«è¡¨ç¤º
    
    root.after(1000, show_health)
    
    try:
        root.mainloop()
    finally:
        bus.stop()
        print("âœ… ConnectionControlPanel ãƒ†ã‚¹ãƒˆå®Œäº†")